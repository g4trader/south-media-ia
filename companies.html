<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Empresas - Dashboard IA South</title>
  <style>
  :root{
    --bg: #1a1a2e;
    --surface: #16213e;
    --stroke: #0f3460;
    --accent: #533483;
    --grad: linear-gradient(135deg, #8b5cf6, #3b82f6);
    --muted: #64748b;
    --text: #e2e8f0;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
  }
  
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  
  .header{background:rgba(22,33,62,.8);border-bottom:1px solid var(--stroke);padding:20px 0;backdrop-filter:blur(10px)}
  .header-content{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
  .header-left{display:flex;align-items:center;gap:16px}
  .header-logo{width:40px;height:40px;background:var(--grad);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
  .header-title{font-size:1.5rem;font-weight:700;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .header-right{display:flex;align-items:center;gap:16px}
  .user-info{display:flex;align-items:center;gap:12px;padding:8px 16px;background:rgba(83,52,131,.1);border:1px solid rgba(83,52,131,.3);border-radius:8px}
  .user-avatar{width:32px;height:32px;background:var(--grad);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600}
  .user-details{display:flex;flex-direction:column;gap:2px}
  .user-name{font-size:.9rem;font-weight:600}
  .user-role{font-size:.75rem;color:var(--muted)}
  .logout-btn{padding:8px 16px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:6px;color:#fca5a5;text-decoration:none;font-size:.9rem;transition:all .3s ease}
  .logout-btn:hover{background:rgba(239,68,68,.2);transform:translateY(-1px)}
  
  .container{max-width:1200px;margin:0 auto;padding:40px 20px}
  .page-title{font-size:2.5rem;font-weight:700;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
  .page-subtitle{color:var(--muted);font-size:1.1rem;margin-bottom:40px}
  
  .companies-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:24px;margin-bottom:40px}
  .company-card{background:rgba(22,33,62,.6);border:1px solid var(--stroke);border-radius:16px;padding:24px;transition:all .3s ease;position:relative;overflow:hidden}
  .company-card:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 8px 32px rgba(139,92,246,.1)}
  .company-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--grad)}
  
  .company-header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
  .company-logo{width:60px;height:60px;background:var(--grad);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:600}
  .company-info{flex:1}
  .company-name{font-size:1.2rem;font-weight:700;margin-bottom:4px}
  .company-code{color:var(--muted);font-size:.9rem;background:rgba(83,52,131,.1);padding:2px 8px;border-radius:4px;display:inline-block}
  
  .company-details{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
  .detail-row{display:flex;justify-content:space-between;align-items:center}
  .detail-label{color:var(--muted);font-size:.9rem}
  .detail-value{color:var(--text);font-size:.9rem;font-weight:500}
  
  .company-actions{display:flex;gap:8px}
  .btn{padding:8px 16px;border-radius:8px;text-decoration:none;font-size:.9rem;font-weight:600;transition:all .3s ease;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .btn-primary{background:var(--grad);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(139,92,246,.3)}
  .btn-secondary{background:rgba(83,52,131,.1);color:var(--accent);border:1px solid rgba(83,52,131,.3)}
  .btn-secondary:hover{background:rgba(83,52,131,.2)}
  .btn-danger{background:rgba(239,68,68,.1);color:#fca5a5;border:1px solid rgba(239,68,68,.3)}
  .btn-danger:hover{background:rgba(239,68,68,.2)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  
  .add-company-section{background:rgba(83,52,131,.05);border:1px solid rgba(83,52,131,.2);border-radius:16px;padding:24px;margin-bottom:40px}
  .add-company-title{font-size:1.3rem;font-weight:600;margin-bottom:16px;color:var(--text)}
  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:20px}
  .form-group{margin-bottom:16px}
  .form-label{display:block;margin-bottom:8px;color:var(--text);font-weight:500;font-size:.9rem}
  .form-input{width:100%;padding:12px 16px;background:rgba(22,33,62,.5);border:1px solid var(--stroke);border-radius:10px;color:var(--text);font-size:1rem;transition:all .3s ease}
  .form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
  .form-input::placeholder{color:var(--muted)}
  .form-textarea{width:100%;padding:12px 16px;background:rgba(22,33,62,.5);border:1px solid var(--stroke);border-radius:10px;color:var(--text);font-size:1rem;transition:all .3s ease;min-height:80px;resize:vertical}
  .form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
  
  .message{display:none;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:.9rem}
  .message.error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
  .message.success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac}
  
  .stats-section{background:rgba(83,52,131,.05);border:1px solid rgba(83,52,131,.2);border-radius:16px;padding:24px;margin-bottom:40px}
  .stats-title{font-size:1.2rem;font-weight:600;margin-bottom:16px;color:var(--text)}
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px}
  .stat-card{background:rgba(22,33,62,.3);border:1px solid var(--stroke);border-radius:12px;padding:16px;text-align:center}
  .stat-number{font-size:2rem;font-weight:700;color:var(--accent);margin-bottom:4px}
  .stat-label{color:var(--muted);font-size:.9rem}
  
  @media (max-width:768px){
    .companies-grid{grid-template-columns:1fr}
    .header-content{flex-direction:column;gap:16px;text-align:center}
    .user-info{flex-direction:column;text-align:center}
    .page-title{font-size:2rem}
    .form-grid{grid-template-columns:1fr}
  }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-logo">üè¢</div>
        <h1 class="header-title">Gerenciamento de Empresas</h1>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">Usu√°rio</div>
            <div class="user-role" id="userRole">Role</div>
          </div>
        </div>
        <a href="/dashboard-protected.html" class="btn btn-secondary">Voltar</a>
        <a href="#" class="logout-btn" onclick="logout()">Sair</a>
      </div>
    </div>
  </header>

  <div class="container">
    <h1 class="page-title">Gerenciamento de Empresas</h1>
    <p class="page-subtitle">Gerencie empresas e suas configura√ß√µes no sistema multi-tenant</p>
    
    <div class="stats-section">
      <h3 class="stats-title">üìä Estat√≠sticas</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalCompanies">0</div>
          <div class="stat-label">Total de Empresas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="activeCompanies">0</div>
          <div class="stat-label">Empresas Ativas</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">Usu√°rios Associados</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalDashboards">0</div>
          <div class="stat-label">Dashboards</div>
        </div>
      </div>
    </div>
    
    <div class="add-company-section">
      <h2 class="add-company-title">‚ûï Adicionar Nova Empresa</h2>
      
      <div id="errorMessage" class="message error"></div>
      <div id="successMessage" class="message success"></div>
      
      <form id="addCompanyForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="companyName" class="form-label">Nome da Empresa</label>
            <input type="text" id="companyName" name="name" class="form-input" placeholder="Digite o nome da empresa" required>
          </div>
          <div class="form-group">
            <label for="companyCode" class="form-label">C√≥digo da Empresa</label>
            <input type="text" id="companyCode" name="code" class="form-input" placeholder="Ex: IASOUTH" required>
          </div>
          <div class="form-group">
            <label for="companyEmail" class="form-label">Email de Contato</label>
            <input type="email" id="companyEmail" name="email" class="form-input" placeholder="contato@empresa.com">
          </div>
          <div class="form-group">
            <label for="companyPhone" class="form-label">Telefone</label>
            <input type="text" id="companyPhone" name="phone" class="form-input" placeholder="+55 11 99999-9999">
          </div>
        </div>
        
        <div class="form-group">
          <label for="companyDescription" class="form-label">Descri√ß√£o</label>
          <textarea id="companyDescription" name="description" class="form-textarea" placeholder="Descreva a empresa e seus objetivos"></textarea>
        </div>
        
        <div class="form-group">
          <label for="companyAddress" class="form-label">Endere√ßo</label>
          <input type="text" id="companyAddress" name="address" class="form-input" placeholder="Endere√ßo completo da empresa">
        </div>
        
        <div style="margin-top: 20px;">
          <button type="submit" class="btn btn-primary">Criar Empresa</button>
        </div>
      </form>
    </div>
    
    <div class="companies-grid" id="companiesGrid">
      <!-- Empresas ser√£o carregadas dinamicamente -->
    </div>
  </div>

  <!-- Incluir sistema de autentica√ß√£o -->
  <script src="auth_system.js"></script>
  <script src="auth_middleware.js"></script>

  <script>
// Verificar autentica√ß√£o e permiss√µes
if (!window.authSystem.isAuthenticated()) {
  window.location.href = '/login.html';
}

if (!window.authSystem.hasPermission('companies:view')) {
  alert('Voc√™ n√£o tem permiss√£o para acessar esta p√°gina');
  window.location.href = '/dashboard-protected.html';
}

// Exibir informa√ß√µes do usu√°rio
const session = window.authSystem.getCurrentSession();
const user = window.authSystem.getCurrentUser();

if (session && user) {
  document.getElementById('userName').textContent = user.profile.full_name || session.username;
  document.getElementById('userAvatar').textContent = (user.profile.full_name || session.username).charAt(0).toUpperCase();
  
  // Exibir role do usu√°rio
  const roleElement = document.getElementById('userRole');
  if (roleElement) {
    const systemData = window.authSystem.getSystemData();
    const role = systemData.roles.find(r => r.id === session.role);
    roleElement.textContent = role ? role.name : session.role;
  }
}

// Fun√ß√£o de logout
function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    window.authSystem.logout();
    window.location.href = '/login.html';
  }
}

// Fun√ß√£o para mostrar mensagem de erro
function showError(message) {
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  errorMessage.textContent = message;
  errorMessage.style.display = 'block';
  successMessage.style.display = 'none';
}

// Fun√ß√£o para mostrar mensagem de sucesso
function showSuccess(message) {
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  successMessage.textContent = message;
  successMessage.style.display = 'block';
  errorMessage.style.display = 'none';
}

// Fun√ß√£o para esconder mensagens
function hideMessages() {
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
}

// Renderizar empresas
function renderCompanies() {
  const companiesGrid = document.getElementById('companiesGrid');
  const result = window.authSystem.getAllCompanies();
  
  if (!result.success) {
    showError(result.message);
    return;
  }
  
  const companies = result.companies;
  const systemData = window.authSystem.getSystemData();
  
  const companyElements = companies.map(company => {
    // Contar usu√°rios da empresa
    const companyUsers = systemData.users.filter(u => u.company_id === company.id);
    
    // Contar dashboards da empresa
    const companyDashboards = systemData.dashboards.filter(d => d.company_id === company.id);
    
    let actionsHtml = '';
    
    if (window.authSystem.hasPermission('companies:manage')) {
      actionsHtml = `
        <button class="btn btn-secondary" onclick="editCompany('${company.id}')">Editar</button>
        <button class="btn btn-danger" onclick="deleteCompany('${company.id}')">Excluir</button>
      `;
    }
    
    return `
      <div class="company-card">
        <div class="company-header">
          <div class="company-logo">${company.name.charAt(0).toUpperCase()}</div>
          <div class="company-info">
            <div class="company-name">${company.name}</div>
            <div class="company-code">${company.code}</div>
          </div>
        </div>
        
        <div class="company-details">
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">${company.status === 'active' ? 'Ativo' : 'Inativo'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Usu√°rios:</span>
            <span class="detail-value">${companyUsers.length}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Dashboards:</span>
            <span class="detail-value">${companyDashboards.length}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Criado em:</span>
            <span class="detail-value">${new Date(company.created_at).toLocaleDateString('pt-BR')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Email:</span>
            <span class="detail-value">${company.contact.email || 'N√£o informado'}</span>
          </div>
        </div>
        
        <div class="company-actions">
          ${actionsHtml}
        </div>
      </div>
    `;
  });
  
  companiesGrid.innerHTML = companyElements.join('');
  
  // Atualizar estat√≠sticas
  updateStats(companies, systemData);
}

// Atualizar estat√≠sticas
function updateStats(companies, systemData) {
  document.getElementById('totalCompanies').textContent = companies.length;
  document.getElementById('activeCompanies').textContent = companies.filter(c => c.status === 'active').length;
  document.getElementById('totalUsers').textContent = systemData.users.filter(u => u.company_id).length;
  document.getElementById('totalDashboards').textContent = systemData.dashboards.length;
}

// Adicionar nova empresa
document.getElementById('addCompanyForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  
  const companyData = {
    name: formData.get('name'),
    code: formData.get('code').toUpperCase(),
    description: formData.get('description'),
    email: formData.get('email'),
    phone: formData.get('phone'),
    address: formData.get('address')
  };
  
  const result = window.authSystem.createCompany(companyData);
  
  if (result.success) {
    showSuccess('Empresa criada com sucesso!');
    e.target.reset();
    renderCompanies();
  } else {
    showError(result.message);
  }
});

// Fun√ß√µes de edi√ß√£o e exclus√£o (placeholder)
function editCompany(companyId) {
  alert(`Editar empresa ${companyId} - Funcionalidade em desenvolvimento`);
}

function deleteCompany(companyId) {
  if (confirm('Tem certeza que deseja excluir esta empresa?')) {
    alert(`Excluir empresa ${companyId} - Funcionalidade em desenvolvimento`);
  }
}

// Inicializar p√°gina
document.addEventListener('DOMContentLoaded', () => {
  renderCompanies();
});
</script>
</body>
</html>

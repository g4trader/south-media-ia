<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerenciamento de Usu√°rios - Dashboard IA South</title>
  <style>
  :root{
    --bg: #1a1a2e;
    --surface: #16213e;
    --stroke: #0f3460;
    --accent: #533483;
    --grad: linear-gradient(135deg, #8b5cf6, #3b82f6);
    --muted: #64748b;
    --text: #e2e8f0;
    --success: #10b981;
    --warning: #f59e0b;
    --error: #ef4444;
  }
  
  *{margin:0;padding:0;box-sizing:border-box}
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  
  .header{background:rgba(22,33,62,.8);border-bottom:1px solid var(--stroke);padding:20px 0;backdrop-filter:blur(10px)}
  .header-content{max-width:1200px;margin:0 auto;padding:0 20px;display:flex;justify-content:space-between;align-items:center}
  .header-left{display:flex;align-items:center;gap:16px}
  .header-logo{width:40px;height:40px;background:var(--grad);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700}
  .header-title{font-size:1.5rem;font-weight:700;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .header-right{display:flex;align-items:center;gap:16px}
  .user-info{display:flex;align-items:center;gap:12px;padding:8px 16px;background:rgba(83,52,131,.1);border:1px solid rgba(83,52,131,.3);border-radius:8px}
  .user-avatar{width:32px;height:32px;background:var(--grad);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:600}
  .user-details{display:flex;flex-direction:column;gap:2px}
  .user-name{font-size:.9rem;font-weight:600}
  .user-role{font-size:.75rem;color:var(--muted)}
  .logout-btn{padding:8px 16px;background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);border-radius:6px;color:#fca5a5;text-decoration:none;font-size:.9rem;transition:all .3s ease}
  .logout-btn:hover{background:rgba(239,68,68,.2);transform:translateY(-1px)}
  
  .container{max-width:1200px;margin:0 auto;padding:40px 20px}
  .page-title{font-size:2.5rem;font-weight:700;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
  .page-subtitle{color:var(--muted);font-size:1.1rem;margin-bottom:40px}
  
  .users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:24px;margin-bottom:40px}
  .user-card{background:rgba(22,33,62,.6);border:1px solid var(--stroke);border-radius:16px;padding:24px;transition:all .3s ease;position:relative;overflow:hidden}
  .user-card:hover{transform:translateY(-4px);border-color:var(--accent);box-shadow:0 8px 32px rgba(139,92,246,.1)}
  .user-card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;background:var(--grad)}
  
  .user-header{display:flex;align-items:center;gap:16px;margin-bottom:16px}
  .user-avatar-large{width:60px;height:60px;background:var(--grad);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:600}
  .user-info-card{flex:1}
  .user-name{font-size:1.2rem;font-weight:700;margin-bottom:4px}
  .user-email{color:var(--muted);font-size:.9rem}
  .user-role{display:inline-block;padding:4px 12px;background:rgba(83,52,131,.1);color:var(--accent);border:1px solid rgba(83,52,131,.3);border-radius:20px;font-size:.8rem;font-weight:600;margin-top:8px}
  
  .user-details{display:flex;flex-direction:column;gap:8px;margin-bottom:20px}
  .detail-row{display:flex;justify-content:space-between;align-items:center}
  .detail-label{color:var(--muted);font-size:.9rem}
  .detail-value{color:var(--text);font-size:.9rem;font-weight:500}
  
  .user-actions{display:flex;gap:8px}
  .btn{padding:8px 16px;border-radius:8px;text-decoration:none;font-size:.9rem;font-weight:600;transition:all .3s ease;border:none;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
  .btn-primary{background:var(--grad);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 16px rgba(139,92,246,.3)}
  .btn-secondary{background:rgba(83,52,131,.1);color:var(--accent);border:1px solid rgba(83,52,131,.3)}
  .btn-secondary:hover{background:rgba(83,52,131,.2)}
  .btn-danger{background:rgba(239,68,68,.1);color:#fca5a5;border:1px solid rgba(239,68,68,.3)}
  .btn-danger:hover{background:rgba(239,68,68,.2)}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  
  .add-user-section{background:rgba(83,52,131,.05);border:1px solid rgba(83,52,131,.2);border-radius:16px;padding:24px;margin-bottom:40px}
  .add-user-title{font-size:1.3rem;font-weight:600;margin-bottom:16px;color:var(--text)}
  .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:20px}
  .form-group{margin-bottom:16px}
  .form-label{display:block;margin-bottom:8px;color:var(--text);font-weight:500;font-size:.9rem}
  .form-input{width:100%;padding:12px 16px;background:rgba(22,33,62,.5);border:1px solid var(--stroke);border-radius:10px;color:var(--text);font-size:1rem;transition:all .3s ease}
  .form-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
  .form-input::placeholder{color:var(--muted)}
  .form-select{width:100%;padding:12px 16px;background:rgba(22,33,62,.5);border:1px solid var(--stroke);border-radius:10px;color:var(--text);font-size:1rem;transition:all .3s ease}
  .form-select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(139,92,246,.1)}
  
  .permissions-section{margin-top:20px}
  .permissions-title{font-size:1rem;font-weight:600;margin-bottom:12px;color:var(--text)}
  .permissions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .permission-item{display:flex;align-items:center;gap:8px}
  .permission-checkbox{width:16px;height:16px;accent-color:var(--accent)}
  .permission-label{color:var(--text);font-size:.9rem}
  
  .message{display:none;padding:12px 16px;border-radius:8px;margin-bottom:16px;font-size:.9rem}
  .message.error{background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.3);color:#fca5a5}
  .message.success{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:#86efac}
  
  .btn-secondary {
    background: var(--muted);
    color: white;
  }
  
  .btn-secondary:hover {
    background: #475569;
  }
  
  .users-actions {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    align-items: center;
  }
  
  .users-actions .btn {
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  /* Modal Styles */
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
  }
  
  .modal-content {
    background: var(--surface);
    margin: 5% auto;
    padding: 0;
    border: 1px solid var(--stroke);
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
  }
  
  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .modal-header {
    padding: 20px 30px;
    border-bottom: 1px solid var(--stroke);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .modal-header h3 {
    margin: 0;
    color: var(--text);
  }
  
  .close {
    color: var(--muted);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
  }
  
  .close:hover {
    color: var(--text);
  }
  
  .modal-body {
    padding: 30px;
  }
  
  .modal-footer {
    padding: 20px 30px;
    border-top: 1px solid var(--stroke);
    display: flex;
    justify-content: flex-end;
    gap: 15px;
  }
  
  .form-group {
    margin-bottom: 20px;
  }
  
  .form-group label {
    display: block;
    margin-bottom: 8px;
    color: var(--text);
    font-weight: 500;
  }
  
  .form-group input,
  .form-group select {
    width: 100%;
    padding: 12px 16px;
    border: 1px solid var(--stroke);
    border-radius: 8px;
    background: var(--bg);
    color: var(--text);
    font-size: 14px;
    transition: all 0.3s ease;
  }
  
  .form-group input:focus,
  .form-group select:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
  }
  
  .user-card {
    background: var(--surface);
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s ease;
  }
  
  .user-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  }
  
  .user-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .user-name {
    font-size: 18px;
    font-weight: 600;
    color: var(--text);
  }
  
  .user-role {
    background: var(--accent);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 500;
  }
  
  .user-details {
    display: grid;
    gap: 8px;
  }
  
  .user-detail {
    display: flex;
    justify-content: space-between;
    color: var(--muted);
    font-size: 14px;
  }
  
  .user-detail strong {
    color: var(--text);
  }
  
  .user-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }
  
  .user-actions .btn {
    padding: 8px 16px;
    font-size: 12px;
    flex: 1;
  }
  
  .edit-user-btn {
    background: var(--warning);
  }
  
  .edit-user-btn:hover {
    background: #d97706;
  }
  
  .delete-user-btn {
    background: var(--error);
  }
  
  .delete-user-btn:hover {
    background: #dc2626;
  }

  @media (max-width:768px){
    .users-grid{grid-template-columns:1fr}
    .header-content{flex-direction:column;gap:16px;text-align:center}
    .user-info{flex-direction:column;text-align:center}
    .page-title{font-size:2rem}
    .form-grid{grid-template-columns:1fr}
    .users-actions{flex-direction:column;align-items:stretch}
    .modal-content{width:95%;margin:10% auto}
  }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <div class="header-logo">üë•</div>
        <h1 class="header-title">Gerenciamento de Usu√°rios</h1>
      </div>
      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">U</div>
          <div class="user-details">
            <div class="user-name" id="userName">Usu√°rio</div>
            <div class="user-role" id="userRole">Role</div>
          </div>
        </div>
        <a href="/dashboard-protected.html" class="btn btn-secondary">Voltar</a>
        <a href="#" class="logout-btn" onclick="logout()">Sair</a>
      </div>
    </div>
  </header>

  <div class="container">
    <h1 class="page-title">Gerenciamento de Usu√°rios</h1>
    <p class="page-subtitle">Gerencie usu√°rios, roles e permiss√µes do sistema</p>
    
    <div class="add-user-section">
      <h2 class="add-user-title">‚ûï Adicionar Novo Usu√°rio</h2>
      
      <div id="errorMessage" class="message error"></div>
      <div id="successMessage" class="message success"></div>
      
      <form id="addUserForm">
        <div class="form-grid">
          <div class="form-group">
            <label for="newUsername" class="form-label">Usu√°rio</label>
            <input type="text" id="newUsername" name="username" class="form-input" placeholder="Digite o nome de usu√°rio" required>
          </div>
          <div class="form-group">
            <label for="newPassword" class="form-label">Senha</label>
            <input type="password" id="newPassword" name="password" class="form-input" placeholder="Digite a senha" required>
          </div>
          <div class="form-group">
            <label for="newEmail" class="form-label">Email</label>
            <input type="email" id="newEmail" name="email" class="form-input" placeholder="Digite o email" required>
          </div>
          <div class="form-group">
            <label for="newFullName" class="form-label">Nome Completo</label>
            <input type="text" id="newFullName" name="fullName" class="form-input" placeholder="Digite o nome completo" required>
          </div>
          <div class="form-group">
            <label for="newDepartment" class="form-label">Departamento</label>
            <input type="text" id="newDepartment" name="department" class="form-input" placeholder="Digite o departamento">
          </div>
          <div class="form-group">
            <label for="newRole" class="form-label">Role</label>
            <select id="newRole" name="role" class="form-select" required>
              <option value="">Selecione uma role</option>
            </select>
          </div>
        </div>
        
        <div class="permissions-section">
          <h3 class="permissions-title">üîê Permiss√µes</h3>
          <div class="permissions-grid" id="permissionsGrid">
            <!-- Permiss√µes ser√£o carregadas dinamicamente -->
          </div>
        </div>
        
        <div style="margin-top: 20px;">
          <button type="submit" class="btn btn-primary">Criar Usu√°rio</button>
        </div>
      </form>
    </div>
    
    <div class="users-actions">
      <button class="btn btn-primary" id="createUserBtn">
        <span>‚ûï</span> Novo Usu√°rio
      </button>
      <button class="btn btn-secondary" id="refreshUsersBtn">
        <span>üîÑ</span> Atualizar
      </button>
    </div>
    
    <div class="users-grid" id="usersGrid">
      <!-- Usu√°rios ser√£o carregados dinamicamente -->
    </div>
  </div>

  <!-- Modal de Cria√ß√£o/Edi√ß√£o de Usu√°rio -->
  <div id="userModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle">Criar Usu√°rio</h3>
        <span class="close" id="closeModal">&times;</span>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <div class="form-group">
            <label for="userName">Nome Completo</label>
            <input type="text" id="userName" name="userName" required>
          </div>
          
          <div class="form-group">
            <label for="userEmail">Email</label>
            <input type="email" id="userEmail" name="userEmail" required>
          </div>
          
          <div class="form-group">
            <label for="userUsername">Username</label>
            <input type="text" id="userUsername" name="userUsername" required>
          </div>
          
          <div class="form-group">
            <label for="userPassword">Senha</label>
            <input type="password" id="userPassword" name="userPassword" required>
          </div>
          
          <div class="form-group">
            <label for="userRole">Role</label>
            <select id="userRole" name="userRole" required>
              <option value="">Selecione um role</option>
              <option value="super_admin">Super Administrador</option>
              <option value="manager">Gerente</option>
              <option value="viewer">Visualizador</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="userCompany">Empresa</label>
            <select id="userCompany" name="userCompany">
              <option value="">Selecione uma empresa</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="userStatus">Status</label>
            <select id="userStatus" name="userStatus" required>
              <option value="active">Ativo</option>
              <option value="inactive">Inativo</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelBtn">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveUserBtn">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Incluir sistema de autentica√ß√£o -->
  <script src="auth_system_hybrid.js"></script>
  <script src="auth_middleware.js"></script>
  <script src="navigation_menu.js"></script>

  <script>
// Verificar autentica√ß√£o e permiss√µes
if (!window.authSystem || !window.authSystem.isAuthenticated()) {
  window.location.href = '/login.html';
}

if (!window.authSystem.hasPermission('users:view')) {
  alert('Voc√™ n√£o tem permiss√£o para acessar esta p√°gina');
  window.location.href = '/dashboard-protected.html';
}

// Vari√°veis globais
let currentEditingUserId = null;
let users = [];
let companies = [];

// Exibir informa√ß√µes do usu√°rio
async function updateUserInfo() {
  try {
    const session = window.authSystem.getCurrentSession();
    const user = await window.authSystem.getCurrentUser();

    if (session && user) {
      document.getElementById('userName').textContent = user.profile?.full_name || session.username;
      document.getElementById('userAvatar').textContent = (user.profile?.full_name || session.username).charAt(0).toUpperCase();
      
      // Exibir role do usu√°rio
      const roleElement = document.getElementById('userRole');
      if (roleElement) {
        const systemData = window.authSystem.getSystemData();
        const role = systemData.roles.find(r => r.id === session.role);
        roleElement.textContent = role ? role.name : session.role;
      }
    }
  } catch (error) {
    console.error('Erro ao atualizar informa√ß√µes do usu√°rio:', error);
  }
}

// Carregar usu√°rios
async function loadUsers() {
  try {
    users = await window.authSystem.getAllUsers();
    renderUsers();
  } catch (error) {
    console.error('Erro ao carregar usu√°rios:', error);
    showMessage('Erro ao carregar usu√°rios', 'error');
  }
}

// Carregar empresas
async function loadCompanies() {
  try {
    companies = await window.authSystem.getAllCompanies();
    updateCompanySelect();
  } catch (error) {
    console.error('Erro ao carregar empresas:', error);
  }
}

// Renderizar usu√°rios
function renderUsers() {
  const usersGrid = document.getElementById('usersGrid');
  
  if (users.length === 0) {
    usersGrid.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--muted);">
        <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
        <h3>Nenhum usu√°rio encontrado</h3>
        <p>Clique em "Novo Usu√°rio" para criar o primeiro usu√°rio</p>
      </div>
    `;
    return;
  }
  
  usersGrid.innerHTML = users.map(user => `
    <div class="user-card">
      <div class="user-header">
        <div class="user-name">${user.profile?.full_name || user.username}</div>
        <div class="user-role">${getRoleName(user.role)}</div>
      </div>
      <div class="user-details">
        <div class="user-detail">
          <span>Username:</span>
          <strong>${user.username}</strong>
        </div>
        <div class="user-detail">
          <span>Email:</span>
          <strong>${user.profile?.email || 'N/A'}</strong>
        </div>
        <div class="user-detail">
          <span>Empresa:</span>
          <strong>${getCompanyName(user.company_id)}</strong>
        </div>
        <div class="user-detail">
          <span>Status:</span>
          <strong style="color: ${user.status === 'active' ? 'var(--success)' : 'var(--error)'}">
            ${user.status === 'active' ? 'Ativo' : 'Inativo'}
          </strong>
        </div>
      </div>
      <div class="user-actions">
        <button class="btn edit-user-btn" onclick="editUser('${user.id}')">
          ‚úèÔ∏è Editar
        </button>
        <button class="btn delete-user-btn" onclick="deleteUser('${user.id}')">
          üóëÔ∏è Excluir
        </button>
      </div>
    </div>
  `).join('');
}

// Obter nome do role
function getRoleName(roleId) {
  const roleNames = {
    'super_admin': 'Super Admin',
    'manager': 'Gerente',
    'viewer': 'Visualizador'
  };
  return roleNames[roleId] || roleId;
}

// Obter nome da empresa
function getCompanyName(companyId) {
  if (!companyId) return 'Sem empresa';
  const company = companies.find(c => c.id === companyId);
  return company ? company.name : 'Empresa n√£o encontrada';
}

// Atualizar select de empresas
function updateCompanySelect() {
  const companySelect = document.getElementById('userCompany');
  companySelect.innerHTML = '<option value="">Selecione uma empresa</option>';
  
  companies.forEach(company => {
    const option = document.createElement('option');
    option.value = company.id;
    option.textContent = company.name;
    companySelect.appendChild(option);
  });
}

// Abrir modal para criar usu√°rio
function openCreateUserModal() {
  currentEditingUserId = null;
  document.getElementById('modalTitle').textContent = 'Criar Usu√°rio';
  document.getElementById('userForm').reset();
  document.getElementById('userModal').style.display = 'block';
}

// Editar usu√°rio
function editUser(userId) {
  const user = users.find(u => u.id === userId);
  if (!user) return;
  
  currentEditingUserId = userId;
  document.getElementById('modalTitle').textContent = 'Editar Usu√°rio';
  
  // Preencher formul√°rio
  document.getElementById('userName').value = user.profile?.full_name || '';
  document.getElementById('userEmail').value = user.profile?.email || '';
  document.getElementById('userUsername').value = user.username;
  document.getElementById('userPassword').value = '';
  document.getElementById('userRole').value = user.role;
  document.getElementById('userCompany').value = user.company_id || '';
  document.getElementById('userStatus').value = user.status;
  
  document.getElementById('userModal').style.display = 'block';
}

// Salvar usu√°rio
async function saveUser() {
  try {
    const formData = {
      profile: {
        full_name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value
      },
      username: document.getElementById('userUsername').value,
      password: document.getElementById('userPassword').value,
      role: document.getElementById('userRole').value,
      company_id: document.getElementById('userCompany').value || null,
      status: document.getElementById('userStatus').value
    };
    
    if (currentEditingUserId) {
      // Atualizar usu√°rio existente
      await window.authSystem.updateUser(currentEditingUserId, formData);
      showMessage('Usu√°rio atualizado com sucesso!', 'success');
    } else {
      // Criar novo usu√°rio
      await window.authSystem.createUser(formData);
      showMessage('Usu√°rio criado com sucesso!', 'success');
    }
    
    closeModal();
    await loadUsers();
  } catch (error) {
    console.error('Erro ao salvar usu√°rio:', error);
    showMessage('Erro ao salvar usu√°rio', 'error');
  }
}

// Excluir usu√°rio
async function deleteUser(userId) {
  const user = users.find(u => u.id === userId);
  if (!user) return;
  
  if (confirm(`Tem certeza que deseja excluir o usu√°rio "${user.profile?.full_name || user.username}"?`)) {
    try {
      await window.authSystem.deleteUser(userId);
      showMessage('Usu√°rio exclu√≠do com sucesso!', 'success');
      await loadUsers();
    } catch (error) {
      console.error('Erro ao excluir usu√°rio:', error);
      showMessage('Erro ao excluir usu√°rio', 'error');
    }
  }
}

// Fechar modal
function closeModal() {
  document.getElementById('userModal').style.display = 'none';
  currentEditingUserId = null;
}

// Mostrar mensagem
function showMessage(message, type) {
  // Implementar sistema de mensagens se necess√°rio
  console.log(`${type.toUpperCase()}: ${message}`);
}

// Event listeners
document.addEventListener('DOMContentLoaded', async () => {
  await updateUserInfo();
  await loadCompanies();
  await loadUsers();
  
  // Event listeners dos bot√µes
  document.getElementById('createUserBtn').addEventListener('click', openCreateUserModal);
  document.getElementById('refreshUsersBtn').addEventListener('click', loadUsers);
  document.getElementById('closeModal').addEventListener('click', closeModal);
  document.getElementById('cancelBtn').addEventListener('click', closeModal);
  document.getElementById('saveUserBtn').addEventListener('click', saveUser);
  
  // Fechar modal ao clicar fora
  document.getElementById('userModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('userModal')) {
      closeModal();
    }
  });
});

// Fun√ß√£o de logout
function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    window.authSystem.logout();
    window.location.href = '/login.html';
  }
}

// Fun√ß√£o para mostrar mensagem de erro
function showError(message) {
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  errorMessage.textContent = message;
  errorMessage.style.display = 'block';
  successMessage.style.display = 'none';
}

// Fun√ß√£o para mostrar mensagem de sucesso
function showSuccess(message) {
  const errorMessage = document.getElementById('errorMessage');
  const successMessage = document.getElementById('successMessage');
  successMessage.textContent = message;
  successMessage.style.display = 'block';
  errorMessage.style.display = 'none';
}

// Fun√ß√£o para esconder mensagens
function hideMessages() {
  document.getElementById('errorMessage').style.display = 'none';
  document.getElementById('successMessage').style.display = 'none';
}

// Carregar roles no select
function loadRoles() {
  const roleSelect = document.getElementById('newRole');
  const roles = window.authSystem.getRoles();
  
  roles.forEach(role => {
    const option = document.createElement('option');
    option.value = role.id;
    option.textContent = role.name;
    roleSelect.appendChild(option);
  });
}

// Carregar permiss√µes
function loadPermissions() {
  const permissionsGrid = document.getElementById('permissionsGrid');
  const permissions = window.authSystem.getPermissions();
  
  permissions.forEach(permission => {
    const permissionItem = document.createElement('div');
    permissionItem.className = 'permission-item';
    permissionItem.innerHTML = `
      <input type="checkbox" class="permission-checkbox" id="perm_${permission.id}" value="${permission.id}">
      <label for="perm_${permission.id}" class="permission-label">${permission.name}</label>
    `;
    permissionsGrid.appendChild(permissionItem);
  });
}

// Renderizar usu√°rios
function renderUsers() {
  const usersGrid = document.getElementById('usersGrid');
  const result = window.authSystem.getAllUsers();
  
  if (!result.success) {
    showError(result.message);
    return;
  }
  
  const users = result.users;
  const roles = window.authSystem.getRoles();
  
  const userElements = users.map(user => {
    const role = roles.find(r => r.id === user.role);
    const roleName = role ? role.name : user.role;
    
    let actionsHtml = '';
    
    if (window.authSystem.hasPermission('users:manage')) {
      actionsHtml = `
        <button class="btn btn-secondary" onclick="editUser('${user.id}')">Editar</button>
        <button class="btn btn-danger" onclick="deleteUser('${user.id}')">Excluir</button>
      `;
    }
    
    return `
      <div class="user-card">
        <div class="user-header">
          <div class="user-avatar-large">${(user.profile.full_name || user.username).charAt(0).toUpperCase()}</div>
          <div class="user-info-card">
            <div class="user-name">${user.profile.full_name || user.username}</div>
            <div class="user-email">${user.email}</div>
            <div class="user-role">${roleName}</div>
          </div>
        </div>
        
        <div class="user-details">
          <div class="detail-row">
            <span class="detail-label">Usu√°rio:</span>
            <span class="detail-value">${user.username}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span class="detail-value">${user.status === 'active' ? 'Ativo' : 'Inativo'}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Criado em:</span>
            <span class="detail-value">${new Date(user.created_at).toLocaleDateString('pt-BR')}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">√öltimo login:</span>
            <span class="detail-value">${user.last_login ? new Date(user.last_login).toLocaleDateString('pt-BR') : 'Nunca'}</span>
          </div>
        </div>
        
        <div class="user-actions">
          ${actionsHtml}
        </div>
      </div>
    `;
  });
  
  usersGrid.innerHTML = userElements.join('');
}

// Adicionar novo usu√°rio
document.getElementById('addUserForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  const formData = new FormData(e.target);
  const permissions = Array.from(document.querySelectorAll('.permission-checkbox:checked')).map(cb => cb.value);
  
  const userData = {
    username: formData.get('username'),
    password: formData.get('password'),
    email: formData.get('email'),
    role: formData.get('role'),
    permissions: permissions,
    profile: {
      full_name: formData.get('fullName'),
      department: formData.get('department')
    }
  };
  
  const result = window.authSystem.createUser(userData);
  
  if (result.success) {
    showSuccess('Usu√°rio criado com sucesso!');
    e.target.reset();
    renderUsers();
  } else {
    showError(result.message);
  }
});

// Fun√ß√µes de edi√ß√£o e exclus√£o (placeholder)
function editUser(userId) {
  alert(`Editar usu√°rio ${userId} - Funcionalidade em desenvolvimento`);
}

function deleteUser(userId) {
  if (confirm('Tem certeza que deseja excluir este usu√°rio?')) {
    alert(`Excluir usu√°rio ${userId} - Funcionalidade em desenvolvimento`);
  }
}

// Inicializar p√°gina
document.addEventListener('DOMContentLoaded', () => {
  loadRoles();
  loadPermissions();
  renderUsers();
});
</script>
</body>
</html>

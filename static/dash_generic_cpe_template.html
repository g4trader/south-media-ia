<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Dashboard CPE - {{CLIENT_NAME}} - {{CAMPAIGN_NAME}}</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0F1023;--bg2:#16213E;--panel:#1A1A2E;--muted:#9CA3AF;--stroke: rgba(139,92,246,.28);
         --grad: linear-gradient(135deg,#8B5CF6,#EC4899);}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%)}
  .container{max-width:1320px;margin:0 auto;padding:32px 32px 40px}
  .card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:14px;padding:20px;margin-bottom:24px;backdrop-filter:blur(8px)}
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:40px;height:40px;border-radius:10px;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0}
  .tab{border:1px solid rgba(148,163,184,.2);background:rgba(255,255,255,.04);padding:10px;border-radius:10px;text-align:center;cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:var(--grad);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.35)}
  .hidden{display:none}
  .metrics{display:grid;grid-template-columns:repeat(6,1fr);gap:16px}
  @media(max-width:1200px){.metrics{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){.metrics{grid-template-columns:repeat(2,1fr)} .tabs{grid-template-columns:repeat(2,1fr)} }
  .metric{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px}
  .metric .label{text-transform:uppercase;letter-spacing:.06em;color:var(--muted);font-size:.82rem}
  .metric .value{font-size:1.7rem;font-weight:800;line-height:1.15}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media(max-width:900px){.kpis{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  thead th{color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-size:.8rem;text-align:left;border-bottom:1px solid rgba(148,163,184,.22);padding:1rem}
  tbody td{padding:1rem;border-bottom:1px solid rgba(148,163,184,.14)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.4);font-weight:600;color:#00ff88}
  /* Componente de Barra de Filtro - Período */
  .filter-bar {
    background: rgba(26,26,46,.9);
    border: 1px solid var(--stroke);
    border-radius: 12px;
    padding: 16px 20px;
    margin: 20px 0;
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
    flex-wrap: wrap;
  }
  
  .filter-period {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .filter-label {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #fff;
    font-weight: 600;
    font-size: 0.9rem;
  }
  
  .filter-label .icon {
    width: 18px;
    height: 18px;
    background: var(--grad);
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 700;
    color: #fff;
  }
  
  .filter-dates {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .date-input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
  }
  
  .date-input {
    padding: 8px 12px;
    border: 1px solid rgba(148,163,184,.2);
    border-radius: 8px;
    background: rgba(255,255,255,.05);
    color: #fff;
    font-size: 0.85rem;
    font-weight: 600;
    min-width: 120px;
    transition: all 0.3s ease;
  }
  
  .date-input:focus {
    outline: none;
    border-color: #8B5CF6;
    box-shadow: 0 0 0 3px rgba(139,92,246,.1);
  }
  
  .date-input::placeholder {
    color: var(--muted);
  }
  
  .date-icon {
    position: absolute;
    right: 8px;
    width: 16px;
    height: 16px;
    color: var(--muted);
    pointer-events: none;
  }
  
  .separator {
    color: var(--muted);
    font-weight: 600;
    font-size: 0.85rem;
  }
  
  .quick-filters {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  
  .quick-filter-btn {
    padding: 6px 12px;
    border: 1px solid rgba(148,163,184,.2);
    border-radius: 20px;
    background: rgba(255,255,255,.05);
    color: #fff;
    font-size: 0.8rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    white-space: nowrap;
  }
  
  .quick-filter-btn:hover {
    background: rgba(255,255,255,.1);
    border-color: rgba(148,163,184,.3);
  }
  
  .quick-filter-btn.active {
    background: var(--grad);
    border-color: transparent;
    color: #fff;
    box-shadow: 0 4px 12px rgba(139,92,246,.35);
  }
  
  .period-display {
    color: var(--muted);
    font-size: 0.8rem;
    font-weight: 500;
    margin-top: 8px;
    text-align: center;
  }
  
  /* Responsividade para Filter Bar */
  @media (max-width: 768px) {
    .filter-bar {
      flex-direction: column;
      align-items: stretch;
      gap: 16px;
    }
    
    .filter-period {
      justify-content: center;
    }
    
    .filter-dates {
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .quick-filters {
      justify-content: center;
    }
    
    .date-input {
      min-width: 100px;
    }
  }
  
  @media (max-width: 480px) {
    .filter-dates {
      flex-direction: column;
      gap: 8px;
    }
    
    .separator {
      display: none;
    }
  }
  
  /* Modal de Loading */
  
  /* Modal de Loading */
  .loading-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
  }
  
  .loading-content {
    background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.95));
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    min-width: 350px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }
  
  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(139, 92, 246, 0.3);
    border-top: 4px solid #8B5CF6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loading-content h3 {
    color: #8B5CF6;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
  }
  
  .loading-content p {
    color: #9CA3AF;
    font-size: 16px;
    margin-bottom: 30px;
  }
  
  .progress-container {
    margin-top: 20px;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(139, 92, 246, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #8B5CF6, #EC4899);
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s ease;
  }
  
  .progress-text {
    color: #8B5CF6;
    font-size: 14px;
    font-weight: 600;
  }
  
  /* Quartis de Vídeo */
  .quartis-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    width: 100%;
    box-sizing: border-box;
  }
  
  @media (min-width: 768px) {
    .quartis-grid {
      grid-template-columns: repeat(4, 1fr);
      gap: 1rem;
    }
  }
  
  .quartil-item {
    text-align: center;
    padding: 1rem;
    box-sizing: border-box;
  }
  
  .circle-progress {
    width: 60px;
    height: 60px;
    margin: 0 auto 0.75rem;
    position: relative;
  }
  
  @media (min-width: 768px) {
    .circle-progress {
      width: 80px;
      height: 80px;
    }
  }
</style>
</head>
<body>
<div class="container">
  <div class="card header">
    <div class="logo">
      <div class="logo-icon">SM</div>
      <div>
        <div style="font-weight:800;font-size:1.1rem">South Media</div>
        <div class="muted">Dashboard - {{CLIENT_NAME}}</div>
      </div>
    </div>
    <div>
      <div style="font-weight:700;font-size:1rem;text-align:right">{{CLIENT_NAME}} - {{CAMPAIGN_NAME}}</div>
      <div class="muted" style="text-align:right">Status: <span class="badge">Ativa</span></div>
    </div>
  </div>
  <!-- Barra de Filtro -->
  <div class="filter-bar">
    <div class="filter-period">
      <div class="filter-label">
        <div class="icon">📅</div>
        <span>Período:</span>
      </div>
      
      <div class="filter-dates">
        <div class="date-input-wrapper">
          <input type="date" 
                 id="filter-start-date" 
                 class="date-input" 
                 placeholder="Data inicial">
          <svg class="date-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
          </svg>
        </div>
        
        <span class="separator">até</span>
        
        <div class="date-input-wrapper">
          <input type="date" 
                 id="filter-end-date" 
                 class="date-input" 
                 placeholder="Data final">
          <svg class="date-icon" viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
          </svg>
        </div>
      </div>
    </div>
    
    <div class="quick-filters">
      <button class="quick-filter-btn" data-filter="hoje">Hoje</button>
      <button class="quick-filter-btn" data-filter="7-dias">7 dias</button>
      <button class="quick-filter-btn" data-filter="30-dias">30 dias</button>
      <button class="quick-filter-btn active" data-filter="todos">Todos</button>
    </div>
    
    <div class="period-display" id="period-display">
      Período: Carregando...
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="overview">🎬 Visão Geral</div>
    <div class="tab" data-tab="channels">🧭 Por Canal</div>
    <div class="tab" data-tab="insights">📊 Análise & Insights</div>
    <div class="tab" data-tab="planning">📋 Planejamento</div>
  </div>

  <!-- OVERVIEW -->
  <div id="tab-overview">
    <div class="metrics" id="metrics-overview-top" style="margin-bottom: 24px;"></div>
    
    <!-- Quartis de Escuta -->
    <div class="card" style="padding: 1.25rem; margin-bottom: 1.5rem;" id="quartisCard">
      <h3 style="font-size: 1rem; font-weight: bold; color: white; margin-bottom: 1rem;">MÉTRICAS DE QUARTIS DE ESCUTA</h3>
      <div class="quartis-grid" id="quartisGrid">
        <!-- Será preenchido dinamicamente pelo JavaScript -->
      </div>
    </div>
    
    <div class="kpis">
      <div class="card"><canvas id="chartSpendShare"></canvas></div>
      <div class="card"><canvas id="chartResults"></canvas></div>
    </div>
    <div class="card" style="margin-top:16px">
      <h3 style="margin-bottom:10px">Resumo da Campanha</h3>
      <div class="muted" style="margin-bottom:10px">Dashboard CPE - Performance de Escutas para a campanha {{CAMPAIGN_NAME}} do cliente {{CLIENT_NAME}}</div>
      <div style="overflow:auto">
        <table id="tableChannels">
          <thead>
            <tr>
              <th>Canal</th><th>Budget Contratado (R$)</th><th>Budget Utilizado (R$)</th><th>Pacing (%)</th>
              <th>Impressões</th><th>Cliques</th><th>CTR</th><th>Escutas (100%)</th><th>VTR (100%)</th>
              <th>CPE (R$)</th><th>CPM (R$)</th>
            </tr>
          </thead>
          <tbody id="tbodyChannels"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CHANNELS -->
  <div id="tab-channels" class="hidden">
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div style="font-weight:800">Canal:</div>
        <div style="padding:8px 10px;border-radius:8px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.06);color:#fff" id="channelDisplay">Carregando...</div>
      </div>
    </div>
    
    <!-- Cards de Totalizadores das Principais Métricas de Entrega -->
    <div class="metrics" id="metrics-channel-summary" style="margin-bottom: 24px;">
      <!-- Cards serão preenchidos dinamicamente -->
    </div>
    
    <div class="metrics" id="metrics-channel"></div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-bottom:10px">Entrega diária — <span id="channelTitle">Carregando...</span></h3>
      <div style="overflow:auto">
        <table id="channelDailyTable">
          <thead>
            <tr><th>Data</th><th>Budget (R$)</th><th>Impressões</th><th>Cliques</th><th>CTR</th><th>Escutas</th><th>VTR</th><th>CPE</th><th>CPM</th><th>Criativo</th></tr>
          </thead>
          <tbody id="channelDailyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div id="tab-insights" class="hidden">
    <div id="insights-content">
      <!-- Conteúdo será carregado dinamicamente -->
    </div>
  </div>

  <!-- PLANNING -->
  <div id="tab-planning" class="hidden">
    <div id="planning-content">
      <!-- Conteúdo será carregado dinamicamente -->
    </div>
  </div>
  </div>

  <!-- Modal de Loading -->
  <div id="loadingModal" class="loading-modal">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Carregando Dashboard</h3>
      <p>Extraindo dados atualizados...</p>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0%</div>
      </div>
    </div>
  </div>

  <script>
// Sistema de Loading com Dados Reais
class DashboardLoader {
    constructor(campaignKey) {
        this.campaignKey = campaignKey;
        // Usar Cloud Run diretamente para máxima confiabilidade
        this.apiEndpoint = `{{API_ENDPOINT}}`;
        this.loadingModal = document.getElementById('loadingModal');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.currentProgress = 0;
        this.maxProgress = 100;
        this.currentStep = 0;
        
        // Propriedades para filtros
        this.originalData = null;  // Armazena todos os dados originais
        this.filteredData = null;  // Armazena dados filtrados
        this.currentStartDate = null;
        this.currentEndDate = null;
    }

    async loadDashboard() {
        try {
            // 1. Iniciando carregamento
            this.updateProgress(10, "Iniciando carregamento...");
            
            // 2. Acessando dados da planilha
            this.updateProgress(25, "Acessando dados da planilha...");
            const data = await this.fetchData();
            
            // Armazenar dados originais para filtros
            this.originalData = JSON.parse(JSON.stringify(data));
            this.filteredData = JSON.parse(JSON.stringify(data));
            
            // 3. Dados recebidos
            this.updateProgress(50, "Dados recebidos com sucesso!");
            
            // 4. Calculando métricas
            this.updateProgress(60, "Calculando métricas...");
            
            // Recalcular métricas por canal na inicialização
            this.recalculateChannelMetrics();
            
            // 5. Atualizando dashboard
            this.updateProgress(80, "Atualizando dashboard...");
            await this.renderDashboard(data);
            
            // 6. Finalizando
            this.updateProgress(95, "Finalizando...");
            
            // 7. Dados carregados com sucesso
            this.updateProgress(100, "Dados carregados com sucesso!");
            
            // Aguardar um pouco para mostrar o sucesso
            await this.delay(500);
            
            // Esconder modal
            this.hideLoadingScreen();
            
        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
            this.updateProgress(0, "Erro ao carregar dados");
            // Em vez de mostrar erro, renderizar com dados vazios
            console.log('Renderizando dashboard com dados vazios...');
            this.renderDashboard({});
        }
    }

    async fetchData() {
        const apiUrl = `${this.apiEndpoint}/api/${this.campaignKey}/data`;
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
        }
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.message || 'Erro ao carregar dados');
        }
        return result.data;
    }

    showLoadingScreen() {
        // Mostrar modal de loading
        if (this.loadingModal) {
            this.loadingModal.style.display = 'flex';
        }
        
        const loadingHtml = `
            <div id="loadingScreen" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                color: white;
            ">
                <div style="text-align: center; max-width: 400px; padding: 40px;">
                    <div style="
                        width: 80px;
                        height: 80px;
                        border: 4px solid rgba(139, 92, 246, 0.3);
                        border-top: 4px solid #8B5CF6;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 30px;
                    "></div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 10px;
                        background: linear-gradient(135deg, #8B5CF6, #EC4899);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    ">Carregando Dashboard</h2>
                    
                    <div style="
                        font-size: 16px;
                        color: #9CA3AF;
                        margin-bottom: 30px;
                    " id="loadingText">Inicializando...</div>
                    
                    <div style="
                        width: 100%;
                        height: 6px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 3px;
                        overflow: hidden;
                        margin-bottom: 20px;
                    ">
                        <div id="progressBar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #8B5CF6, #EC4899);
                            border-radius: 3px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                    
                    <div style="
                        font-size: 14px;
                        color: #6B7280;
                    " id="progressText">0%</div>
                </div>
                
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>
        `;
        document.body.innerHTML = loadingHtml;
    }

    updateProgress(percentage, text) {
        // Atualizar modal de loading
        if (this.progressFill) {
            this.progressFill.style.width = percentage + '%';
        }
        if (this.progressText) {
            this.progressText.textContent = text || percentage + '%';
        }
        
        // Manter compatibilidade com loading screen antigo
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        if (loadingText) loadingText.textContent = text;
        if (progressBar) progressBar.style.width = percentage + '%';
        if (progressText) progressText.textContent = percentage + '%';
        
        console.log(`Progresso: ${percentage}% - ${text}`);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Método para aplicar filtros de data aos dados
    applyDateFilter(startDate, endDate) {
        console.log('🔄 Aplicando filtro de data:', { startDate, endDate });
        
        // Armazenar datas para uso posterior
        this.currentStartDate = startDate;
        this.currentEndDate = endDate;
        
        if (!this.originalData || !this.originalData.daily_data) {
            console.error('❌ Dados originais não disponíveis');
            return;
        }
        
        // Criar cópia profunda dos dados originais
        this.filteredData = JSON.parse(JSON.stringify(this.originalData));
        
        // Filtrar daily_data
        if (startDate && endDate) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            
            this.filteredData.daily_data = this.filteredData.daily_data.filter(item => {
                const itemDate = new Date(item.date);
                return itemDate >= start && itemDate <= end;
            });
        }
        
        console.log(`📊 Dados filtrados: ${this.filteredData.daily_data.length} registros`);
        
        // Recalcular métricas com base nos dados filtrados
        this.recalculateMetrics();
        
        // Recalcular métricas por canal
        this.recalculateChannelMetrics();
        
        // Renderizar dashboard com dados filtrados
        this.renderDashboard(this.filteredData);
        
        // Atualizar cards visuais das métricas APÓS renderização com delay
        setTimeout(() => {
            this.recalculateOverviewMetrics();
        }, 100);
        
        // Forçar atualização da tabela "Entrega diária" após renderização
        setTimeout(() => {
            const channelDailyBody = document.getElementById('channelDailyBody');
            if (channelDailyBody && this.filteredData.daily_data.length === 0) {
                const currentContent = channelDailyBody.innerHTML;
                if (!currentContent.includes('Nenhum dado disponível') || channelDailyBody.querySelectorAll('tr').length > 1) {
                    console.log('⚠️ Forçando atualização da tabela "Entrega diária"');
                    channelDailyBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px; color: var(--muted);">Nenhum dado disponível para o período selecionado</td></tr>';
                }
            }
        }, 100);
    }
    
    // Recalcular métricas totais
    recalculateMetrics() {
        if (!this.filteredData || !this.filteredData.daily_data) return;
        
        let totalSpend = 0;
        let totalImpressions = 0;
        let totalClicks = 0;
        let totalVideoCompletions = 0;
        let totalVideoStarts = 0;
        
        this.filteredData.daily_data.forEach(day => {
            totalSpend += parseFloat(day.spend) || 0;
            totalImpressions += parseInt(day.impressions) || 0;
            totalClicks += parseInt(day.clicks) || 0;
            totalVideoCompletions += parseInt(day.video_completions) || 0;
            totalVideoStarts += parseInt(day.video_starts) || 0;
        });
        
        // Recalcular métricas derivadas
        const ctr = totalImpressions > 0 ? (totalClicks / totalImpressions) * 100 : 0;
        const vtr = totalVideoStarts > 0 ? (totalVideoCompletions / totalVideoStarts) * 100 : 0;
        const cpm = totalImpressions > 0 ? (totalSpend / totalImpressions) * 1000 : 0;
        const cpc = totalClicks > 0 ? totalSpend / totalClicks : 0;
        const cpv = totalVideoCompletions > 0 ? totalSpend / totalVideoCompletions : 0;
        
        // Atualizar campaign_summary com novos totais
        if (!this.filteredData.campaign_summary) {
            this.filteredData.campaign_summary = {};
        }
        
        this.filteredData.campaign_summary.total_spend = totalSpend;
        this.filteredData.campaign_summary.total_impressions = totalImpressions;
        this.filteredData.campaign_summary.total_clicks = totalClicks;
        this.filteredData.campaign_summary.total_video_completions = totalVideoCompletions;
        this.filteredData.campaign_summary.total_video_starts = totalVideoStarts;
        this.filteredData.campaign_summary.ctr = ctr;
        this.filteredData.campaign_summary.vtr = vtr;
        this.filteredData.campaign_summary.cpm = cpm;
        this.filteredData.campaign_summary.cpc = cpc;
        this.filteredData.campaign_summary.cpv = cpv;
        
        console.log('📈 Métricas recalculadas:', this.filteredData.campaign_summary);
    }
    
    // Atualizar cards visuais das métricas
    recalculateOverviewMetrics() {
        console.log('🔍 recalculateOverviewMetrics chamada');
        
        if (!this.filteredData || !this.filteredData.campaign_summary) {
            console.log('❌ filteredData ou campaign_summary não existe');
            return;
        }
        
        const summary = this.filteredData.campaign_summary;
        console.log('📊 Dados do summary:', summary);
        
        // Atualizar Budget Utilizado
        const budgetElement = document.querySelector('[data-metric="budget"] .value');
        console.log('🔍 Budget element:', budgetElement);
        if (budgetElement) {
            const newValue = this.formatCurrency(summary.total_spend || 0);
            console.log('💰 Atualizando Budget:', budgetElement.textContent, '→', newValue);
            budgetElement.textContent = newValue;
        } else {
            console.log('❌ Budget element não encontrado');
        }
        
        // Atualizar Escutas Entregues
        const listensElement = document.querySelector('[data-metric="listens-delivered"] .value');
        console.log('🔍 Listens element:', listensElement);
        if (listensElement) {
            const newValue = this.formatNumber(summary.total_video_completions || 0);
            console.log('🎧 Atualizando Escutas:', listensElement.textContent, '→', newValue);
            listensElement.textContent = newValue;
        } else {
            console.log('❌ Listens element não encontrado');
        }
        
        // Atualizar Escutas Contratadas
        const listensContractedElement = document.querySelector('[data-metric="listens-contracted"] .value');
        if (listensContractedElement) {
            listensContractedElement.textContent = this.formatNumber(summary.complete_views_contracted || 0);
        }
        
        // Atualizar Pacing
        const pacingElement = document.querySelector('[data-metric="pacing"] .value');
        if (pacingElement) {
            pacingElement.textContent = this.formatPercentage(summary.pacing || 0);
        }
        
        console.log('✅ recalculateOverviewMetrics concluída');
    }
    
    // Recalcular métricas por canal
    recalculateChannelMetrics() {
        const dailyData = this.filteredData?.daily_data || this.originalData?.daily_data || [];
        
        if (dailyData.length === 0) {
            this.filteredData.channel_metrics = [];
            return;
        }
        
        // Agrupar por criativo/canal
        const channelGroups = {};
        
        dailyData.forEach(day => {
            const channel = day.creative || day.canal || 'Desconhecido';
            
            if (!channelGroups[channel]) {
                channelGroups[channel] = {
                    channel: channel,
                    spend: 0,
                    impressions: 0,
                    clicks: 0,
                    video_completions: 0,
                    video_starts: 0
                };
            }
            
            channelGroups[channel].spend += parseFloat(day.spend) || 0;
            channelGroups[channel].impressions += parseInt(day.impressions) || 0;
            channelGroups[channel].clicks += parseInt(day.clicks) || 0;
            channelGroups[channel].video_completions += parseInt(day.video_completions) || 0;
            channelGroups[channel].video_starts += parseInt(day.video_starts) || 0;
        });
        
        // Calcular métricas derivadas para cada canal
        this.filteredData.channel_metrics = Object.values(channelGroups).map(channel => {
            const ctr = channel.impressions > 0 ? (channel.clicks / channel.impressions) * 100 : 0;
            const vtr = channel.video_starts > 0 ? (channel.video_completions / channel.video_starts) * 100 : 0;
            const cpm = channel.impressions > 0 ? (channel.spend / channel.impressions) * 1000 : 0;
            const cpc = channel.clicks > 0 ? channel.spend / channel.clicks : 0;
            const cpv = channel.video_completions > 0 ? channel.spend / channel.video_completions : 0;
            
            return {
                ...channel,
                ctr,
                vtr,
                cpm,
                cpc,
                cpv
            };
        });
        
        console.log('📊 Métricas por canal recalculadas:', this.filteredData.channel_metrics.length, 'canais');
    }

    hideLoadingScreen() {
        // Esconder modal de loading
        if (this.loadingModal) {
            this.loadingModal.style.display = 'none';
        }
        
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.remove();
        }
    }

    showError(message) {
        const errorHtml = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                color: white;
            ">
                <div style="
                    text-align: center;
                    max-width: 500px;
                    padding: 40px;
                    background: rgba(26, 26, 46, 0.8);
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 16px;
                    backdrop-filter: blur(10px);
                ">
                    <div style="
                        font-size: 48px;
                        margin-bottom: 20px;
                    ">❌</div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 15px;
                        color: #EF4444;
                    ">Erro ao Carregar Dashboard</h2>
                    
                    <p style="
                        font-size: 16px;
                        color: #9CA3AF;
                        margin-bottom: 30px;
                        line-height: 1.5;
                    ">${message}</p>
                    
                    <button onclick="location.reload()" style="
                        background: linear-gradient(135deg, #8B5CF6, #EC4899);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 14px;
                    ">Tentar Novamente</button>
                </div>
            </div>
        `;
        document.body.innerHTML = errorHtml;
    }

    updateChannelTabElements(channelName) {
        // Atualizar o display do canal na aba "Por Canal"
        const channelDisplay = document.getElementById('channelDisplay');
        const channelTitle = document.getElementById('channelTitle');
        
        if (channelDisplay) {
            channelDisplay.textContent = channelName;
        }
        
        if (channelTitle) {
            channelTitle.textContent = channelName;
        }
        
        console.log(`🎯 Canal atualizado para: ${channelName}`);
    }

    async renderDashboard(data) {
        // Renderizar dados diretamente no HTML existente
        this.renderMetrics(data);
        this.renderCharts(data);
        this.renderTables(data);
        this.renderChannelSummaryCards(data);
        this.renderInsights(data);
        this.renderPlanning(data);
        this.setupEventListeners();
        
        // Aguardar um pouco para garantir que tudo foi renderizado
        await this.delay(100);
    }

    renderMetrics(data) {
        // Renderizar métricas principais
        const metricsContainer = document.getElementById('metrics-overview-top');
        if (metricsContainer && data.campaign_summary) {
            const summary = data.campaign_summary;
            const contract = data.contract || {};
            metricsContainer.innerHTML = `
                <div class="metric" data-metric="investment">
                    <div class="label">💰 Investimento</div>
                    <div class="value">${this.formatCurrency(summary.investment || 0)}</div>
                </div>
                <div class="metric" data-metric="budget">
                    <div class="label">💸 Budget Utilizado</div>
                    <div class="value">${this.formatCurrency(summary.total_spend || 0)}</div>
                </div>
                <div class="metric" data-metric="listens-contracted">
                    <div class="label">🎯 Escutas Contratadas</div>
                    <div class="value">${this.formatNumber(summary.complete_views_contracted || 0)}</div>
                </div>
                <div class="metric" data-metric="listens-delivered">
                    <div class="label">🎧 Escutas Entregues</div>
                    <div class="value">${this.formatNumber(summary.total_video_completions || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📈 Pacing</div>
                    <div class="value">${this.formatPercentage(summary.pacing || 0)}</div>
                </div>
                    <div class="metric">
                        <div class="label">💵 CPE</div>
                        <div class="value">${this.formatCurrency(contract.cpv_contracted || 0)}</div>
                    </div>
            `;
        }
        
        // Atualizar período da campanha
        this.updateCampaignPeriod(data);
    }
    
    updateCampaignPeriod(data) {
        const periodDisplay = document.getElementById('period-display');
        if (periodDisplay && data.campaign_summary && data.campaign_summary.period) {
            // Verificar se o filtro "Todos" está ativo
            const todosButton = document.querySelector('[data-filter="todos"]');
            const isTodosActive = todosButton && todosButton.classList.contains('active');
            
            if (isTodosActive) {
                // Se "Todos" está ativo, não mostrar período específico
                periodDisplay.textContent = 'Período: Todos os dados';
            } else {
                // Caso contrário, mostrar período da campanha
                periodDisplay.textContent = `Período: ${data.campaign_summary.period}`;
            }
        }
    }

    renderCharts(data) {
        // Renderizar gráficos básicos
        const spendCtx = document.getElementById('chartSpendShare');
        const resultsCtx = document.getElementById('chartResults');
        
        // Destruir gráficos existentes antes de criar novos (evitar erro "Canvas is already in use")
        if (spendCtx) {
            const existingChart = Chart.getChart(spendCtx);
            if (existingChart) {
                existingChart.destroy();
            }
        }
        if (resultsCtx) {
            const existingChart = Chart.getChart(resultsCtx);
            if (existingChart) {
                existingChart.destroy();
            }
        }
        
        if (spendCtx && data.campaign_summary) {
            new Chart(spendCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilizado', 'Restante'],
                    datasets: [{
                        data: [
                            data.campaign_summary.total_spend || 0,
                            (data.campaign_summary.investment || 0) - (data.campaign_summary.total_spend || 0)
                        ],
                        backgroundColor: ['#8B5CF6', '#EC4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#9CA3AF' }
                        }
                    }
                }
            });
        }
        
        if (resultsCtx && data.campaign_summary) {
            new Chart(resultsCtx, {
                type: 'bar',
                data: {
                    labels: ['Impressões', 'Cliques', 'Escutas'],
                    datasets: [{
                        label: 'Performance',
                        data: [
                            data.campaign_summary.total_impressions || 0,
                            data.campaign_summary.total_clicks || 0,
                            data.campaign_summary.total_video_completions || 0
                        ],
                        backgroundColor: ['#8B5CF6', '#EC4899', '#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#9CA3AF' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }
    }

    renderTables(data) {
        // Renderizar tabela de resumo consolidado
        const tbodyChannels = document.getElementById('tbodyChannels');
        if (tbodyChannels && data.campaign_summary && data.contract) {
            const summary = data.campaign_summary;
            const contract = data.contract;
            
            // Calcular pacing
            const pacing = contract.investment > 0 ? (summary.total_spend / contract.investment * 100) : 0;
            
            // Usar sempre o canal do contract (correto)
            let realChannel = contract.canal || 'Video Programática';
            
            tbodyChannels.innerHTML = `
                <tr>
                    <td>${realChannel}</td>
                    <td>R$ ${this.formatCurrency(contract.investment || 0)}</td>
                    <td>R$ ${this.formatCurrency(summary.total_spend || 0)}</td>
                    <td>${this.formatPercentage(pacing)}</td>
                    <td>${this.formatNumber(summary.total_impressions || 0)}</td>
                    <td>${this.formatNumber(summary.total_clicks || 0)}</td>
                    <td>${this.formatPercentage(summary.ctr || 0)}</td>
                    <td>${this.formatNumber(summary.total_video_completions || 0)}</td>
                    <td>${this.formatPercentage(summary.vtr || 0)}</td>
                    <td>R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2).replace('.', ',') : '0,00'}</td>
                    <td>R$ ${this.formatCurrency(summary.cpm || 0)}</td>
                </tr>
            `;
            
            // Atualizar elementos da aba "Por Canal" com o canal correto
            this.updateChannelTabElements(realChannel);
        }
        
        // Renderizar quartis de vídeo
        this.renderVideoQuartis(data);

        // Renderizar tabela de entrega diária por canal
        const channelDailyBody = document.getElementById('channelDailyBody');
        if (channelDailyBody && data.daily_data && data.daily_data.length > 0) {
            const contract = data.contract || {};
            channelDailyBody.innerHTML = data.daily_data.map(record => {
                const vtr = record.video_completions && record.video_starts ? 
                    (record.video_completions / record.video_starts * 100) : 0;
                const cpm = record.impressions ? 
                    (record.spend / record.impressions * 1000) : 0;
                
                return `
                    <tr>
                        <td>${record.date}</td>
                        <td>R$ ${this.formatCurrency(record.spend)}</td>
                        <td>${this.formatNumber(record.impressions)}</td>
                        <td>${this.formatNumber(record.clicks)}</td>
                        <td>${this.formatPercentage(record.ctr)}</td>
                        <td>${this.formatNumber(record.video_completions)}</td>
                        <td>${this.formatPercentage(vtr)}</td>
                        <td>R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2).replace('.', ',') : '0,00'}</td>
                        <td>R$ ${this.formatCurrency(cpm)}</td>
                        <td>${record.creative || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }
    }
    
    renderVideoQuartis(data) {
        // Renderizar quartis de vídeo (25%, 50%, 75%, 100%)
        const quartisGrid = document.getElementById('quartisGrid');
        if (!quartisGrid) return;
        
        // Calcular quartis agregados do daily_data se não existirem no summary
        let q25_total = 0, q50_total = 0, q75_total = 0;
        
        if (data.daily_data && data.daily_data.length > 0) {
            q25_total = data.daily_data.reduce((sum, record) => sum + (record.video_25 || 0), 0);
            q50_total = data.daily_data.reduce((sum, record) => sum + (record.video_50 || 0), 0);
            q75_total = data.daily_data.reduce((sum, record) => sum + (record.video_75 || 0), 0);
        }
        
        const summary = data.campaign_summary || {};
        const total_starts = summary.total_video_starts || 0;
        const total_completions = summary.total_video_completions || 0;
        const vtr = summary.vtr || 0;
        
        // Dados dos quartis - Usar total_starts como base (coluna video_starts da planilha)
        const base_total = total_starts > 0 ? total_starts : 1; // Evitar divisão por zero
        const quartis = [
            { label: '25% ESCUTADOS', value: q25_total, percent: (q25_total / base_total * 100) },
            { label: '50% ESCUTADOS', value: q50_total, percent: (q50_total / base_total * 100) },
            { label: '75% ESCUTADOS', value: q75_total, percent: (q75_total / base_total * 100) },
            { label: '100% ESCUTADOS', value: total_completions, percent: (total_completions / base_total * 100) }
        ];
        
        quartisGrid.innerHTML = quartis.map(q => {
            // Calcular stroke-dashoffset (283 é a circunferência completa)
            const dashOffset = 283 - (283 * q.percent / 100);
            
            return `
                <div class="quartil-item">
                    <div class="circle-progress">
                        <svg height="100%" viewBox="0 0 100 100" width="100%">
                            <circle cx="50" cy="50" fill="none" r="45" stroke="rgba(255,255,255,0.1)" stroke-width="8"></circle>
                            <circle cx="50" cy="50" fill="none" r="45" stroke="#8B5CF6" stroke-dasharray="283" stroke-dashoffset="${dashOffset}" stroke-width="8" transform="rotate(-90 50 50)"></circle>
                            <text fill="white" font-size="16" font-weight="bold" text-anchor="middle" x="50" y="55">${q.percent.toFixed(1)}%</text>
                        </svg>
                    </div>
                    <div style="font-size: 0.75rem; color: #9CA3AF; margin-bottom: 0.25rem;">${q.label}</div>
                    <div style="font-size: 0.875rem; color: white; font-weight: bold;">${this.formatNumber(q.value)}</div>
                </div>
            `;
        }).join('');
    }

    renderChannelSummaryCards(data) {
        // Renderizar cards de totalizadores das principais métricas de entrega
        const summaryContainer = document.getElementById('metrics-channel-summary');
        if (summaryContainer && data.campaign_summary && data.contract) {
            const summary = data.campaign_summary;
            const contract = data.contract;
            
            // Calcular métricas adicionais
            const pacing = contract.investment > 0 ? (summary.total_spend / contract.investment * 100) : 0;
            const vc_pacing = contract.complete_views_contracted > 0 ? (summary.total_video_completions / contract.complete_views_contracted * 100) : 0;
            const vtr = summary.total_video_starts > 0 ? (summary.total_video_completions / summary.total_video_starts * 100) : 0;
            const ctr = summary.total_impressions > 0 ? (summary.total_clicks / summary.total_impressions * 100) : 0;
            const cpm = summary.total_impressions > 0 ? (summary.total_spend / summary.total_impressions * 1000) : 0;
            
            summaryContainer.innerHTML = `
                <div class="metric">
                    <div class="label">💰 Budget Total</div>
                    <div class="value">${this.formatCurrency(contract.investment || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">💸 Budget Utilizado</div>
                    <div class="value">${this.formatCurrency(summary.total_spend || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📈 Pacing Financeiro</div>
                    <div class="value">${this.formatPercentage(pacing)}</div>
                </div>
                <div class="metric">
                    <div class="label">🎯 Escutas Contratadas</div>
                    <div class="value">${this.formatNumber(contract.complete_views_contracted || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">🎧 Escutas Entregues</div>
                    <div class="value">${this.formatNumber(summary.total_video_completions || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📊 Pacing Escutas</div>
                    <div class="value">${this.formatPercentage(vc_pacing)}</div>
                </div>
                <div class="metric">
                    <div class="label">👁️ Total Impressões</div>
                    <div class="value">${this.formatNumber(summary.total_impressions || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">🖱️ Total Cliques</div>
                    <div class="value">${this.formatNumber(summary.total_clicks || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📱 CTR Médio</div>
                    <div class="value">${this.formatPercentage(ctr)}</div>
                </div>
                <div class="metric">
                    <div class="label">🎬 VTR Médio</div>
                    <div class="value">${this.formatPercentage(vtr)}</div>
                </div>
                <div class="metric">
                    <div class="label">💵 CPE Contratado</div>
                    <div class="value">${this.formatCurrency(contract.cpv_contracted || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📊 CPM Médio</div>
                    <div class="value">${this.formatCurrency(cpm)}</div>
                </div>
            `;
        }
    }

    renderInsights(data) {
        // Renderizar aba de análise e insights
        const insightsContainer = document.getElementById('insights-content');
        if (insightsContainer && data.contract && data.strategies) {
            const summary = data.campaign_summary || {};
            const contract = data.contract;
            
            // Renderizar insights dinâmicos
            const insightsList = data.insights && data.insights.length > 0 ? data.insights : [
                "A campanha está performando conforme o esperado.",
                `O pacing da campanha está em ${summary.pacing ? summary.pacing.toFixed(1) : '0.0'}%.`,
                `CPE contratado de R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2) : '0.00'} está sendo cumprido conforme planejado.`,
                "Recomenda-se monitorar a performance diariamente para otimizações."
            ];

            insightsContainer.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header Section -->
                    <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1)); border: 1px solid rgba(139,92,246,.3);">
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="margin-bottom: 12px; color: #8B5CF6; font-size: 28px; font-weight: 700">
                                📊 Análise & Insights
                            </h2>
                            <div style="color: #9CA3AF; font-size: 16px">
                                Análise de Performance e Recomendações
                            </div>
                        </div>
                    </div>

                    <!-- Performance Summary -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 20px; color: #8B5CF6; font-size: 20px; font-weight: 700">
                            📈 Resumo de Performance
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(16,185,129,.1), rgba(5,150,105,.1)); border-radius: 12px; border: 1px solid rgba(16,185,129,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #10B981; margin-bottom: 8px;">
                                    ${summary.pacing ? summary.pacing.toFixed(1) : '0.0'}%
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">Pacing da Campanha</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1)); border-radius: 12px; border: 1px solid rgba(139,92,246,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #8B5CF6; margin-bottom: 8px;">
                                    ${contract.cpv_contracted ? 'R$ ' + contract.cpv_contracted.toFixed(2).replace('.', ',') : 'R$ 0,00'}
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">CPE Contratado</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(245,158,11,.1), rgba(217,119,6,.1)); border-radius: 12px; border: 1px solid rgba(245,158,11,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #F59E0B; margin-bottom: 8px;">
                                    ${summary.vtr ? summary.vtr.toFixed(1) : '0.0'}%
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">VTR (View-Through Rate)</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(59,130,246,.1), rgba(37,99,235,.1)); border-radius: 12px; border: 1px solid rgba(59,130,246,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #3B82F6; margin-bottom: 8px;">
                                    ${summary.ctr ? summary.ctr.toFixed(2) : '0.00'}%
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">CTR (Click-Through Rate)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Insights -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                            💡 Insights Principais
                        </h4>
                        <div style="display: grid; gap: 12px;">
                            ${insightsList.map(insight => `
                                <div style="
                                    padding: 16px;
                                    border-radius: 12px;
                                    border: 1px solid rgba(139,92,246,.3);
                                    background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1));
                                ">
                                    <div style="color: #E5E7EB; line-height: 1.6;">
                                        ${insight}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
    }

    renderPlanning(data) {
        // Renderizar aba de planejamento com dados reais
        const planningContainer = document.getElementById('planning-content');
        if (planningContainer && data.contract && data.publishers && data.strategies) {
            const summary = data.campaign_summary || {};
            const contract = data.contract;
            
            // Calcular pacing
            const pacing = contract.investment > 0 ? (summary.total_spend / contract.investment * 100) : 0;
            
            // Renderizar publishers em grid
            const publishersHtml = data.publishers.map(publisher => `
                <div style="
                    padding: 12px 16px;
                    border-radius: 12px;
                    border: 1px solid rgba(148,163,184,.2);
                    background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1));
                    color: #fff;
                    font-weight: 600;
                    font-size: 13px;
                    text-align: center;
                    min-width: 160px;
                    max-width: 160px;
                    height: 48px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    word-wrap: break-word;
                    word-break: break-all;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    transition: all 0.3s ease;
                    cursor: pointer;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(139,92,246,.3)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                   title="${publisher.publisher || publisher.name || 'N/A'}">
                    ${publisher.publisher || publisher.name || 'N/A'}
                </div>
            `).join('');
            
            // Renderizar estratégias
            const strategiesHtml = data.strategies.map(strategy => `
                <div style="
                    padding: 16px;
                    border-radius: 12px;
                    border: 1px solid rgba(139,92,246,.3);
                    background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1));
                    margin-bottom: 12px;
                ">
                    <div style="font-weight: 700; color: #8B5CF6; margin-bottom: 8px; font-size: 16px">
                        ${strategy.strategy || strategy.name || 'Estratégia'}
                    </div>
                    ${strategy.type ? `<div style="color: #9CA3AF; font-size: 14px">${strategy.type}</div>` : ''}
                </div>
            `).join('');

            planningContainer.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header Section -->
                    <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1)); border: 1px solid rgba(139,92,246,.3);">
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="margin-bottom: 12px; color: #8B5CF6; font-size: 28px; font-weight: 700">
                                📋 Planejamento da Campanha
                            </h2>
                            <div style="color: #9CA3AF; font-size: 16px">
                                ${contract.client || 'N/A'} - ${contract.campaign || 'N/A'}
                            </div>
                            <div style="margin-top: 12px;">
                                <span style="
                                    background: linear-gradient(135deg, #10B981, #059669);
                                    color: white;
                                    padding: 8px 16px;
                                    border-radius: 20px;
                                    font-weight: 600;
                                    font-size: 14px;
                                ">${summary.status || 'ATIVA'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Overview -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 20px; color: #8B5CF6; font-size: 20px; font-weight: 700">
                            🎯 Objetivo da Campanha
                        </h3>
                        <p style="
                            color: #E5E7EB;
                            font-size: 16px;
                            line-height: 1.6;
                            background: rgba(139,92,246,.1);
                            padding: 20px;
                            border-radius: 12px;
                            border: 1px solid rgba(139,92,246,.2);
                        ">
                            Campanha institucional da ${contract.client || 'Cliente'} no ${contract.canal || 'Video Programática'} com foco em Complete View para fortalecer a marca e comunicar valores de qualidade, sustentabilidade e cooperativismo.
                        </p>
                    </div>

                    <!-- Grid Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Left Column -->
                        <div>
                            <!-- Timeline & Investment -->
                            <div class="card" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    📅 Cronograma & Investimento
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Período:</span>
                                        <span style="color: #fff; font-weight: 600;">${contract.period_start && contract.period_end ? `${contract.period_start} a ${contract.period_end}` : 'N/A'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Budget Total:</span>
                                        <span style="color: #10B981; font-weight: 600;">${this.formatCurrency(contract.investment || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Budget Utilizado:</span>
                                        <span style="color: #F59E0B; font-weight: 600;">${this.formatCurrency(summary.total_spend || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Pacing:</span>
                                        <span style="color: #8B5CF6; font-weight: 600;">${this.formatPercentage(pacing)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Metrics -->
                            <div class="card">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    🎯 Métricas Contratadas
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Meta Escutas:</span>
                                        <span style="color: #fff; font-weight: 600;">${this.formatNumber(contract.complete_views_contracted || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Escutas Entregues:</span>
                                        <span style="color: #10B981; font-weight: 600;">${this.formatNumber(summary.total_video_completions || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Pacing Escutas:</span>
                                        <span style="color: #8B5CF6; font-weight: 600;">${contract.complete_views_contracted > 0 ? this.formatPercentage((summary.total_video_completions / contract.complete_views_contracted * 100) || 0) : '0,00%'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">CPE Contratado:</span>
                                        <span style="color: #F59E0B; font-weight: 600;">R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2).replace('.', ',') : '0,00'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Publishers -->
                            <div class="card" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    📊 Publishers
                                </h4>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                                    gap: 12px;
                                    max-height: 300px;
                                    overflow-y: auto;
                                    padding: 8px;
                                ">
                                    ${publishersHtml}
                                </div>
                            </div>

                            <!-- Strategies -->
                            <div class="card">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    🎯 Estratégias
                                </h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${strategiesHtml}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Info -->
                    <div class="card">
                        <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                            📋 Informações do Contrato
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <div style="padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px; border: 1px solid rgba(139,92,246,.3);">
                                <div style="color: #9CA3AF; font-size: 14px; margin-bottom: 4px;">Canal</div>
                                <div style="color: #fff; font-weight: 600;">${contract.canal || 'N/A'}</div>
                            </div>
                            <div style="padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px; border: 1px solid rgba(139,92,246,.3);">
                                <div style="color: #9CA3AF; font-size: 14px; margin-bottom: 4px;">Tipo de Criativo</div>
                                <div style="color: #fff; font-weight: 600;">${contract.tipo_criativo || 'N/A'}</div>
                            </div>
                            <div style="padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px; border: 1px solid rgba(139,92,246,.3);">
                                <div style="color: #9CA3AF; font-size: 14px; margin-bottom: 4px;">Última Atualização</div>
                                <div style="color: #fff; font-weight: 600;">${data.last_updated ? new Date(data.last_updated).toLocaleString('pt-BR') : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    setupEventListeners() {
        // Configurar navegação por tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabId = tab.dataset.tab;
                ['overview', 'channels', 'insights', 'planning'].forEach(key => {
                    const element = document.getElementById(`tab-${key}`);
                    if (element) {
                        element.classList.toggle('hidden', key !== tabId);
                    }
                });
            });
        });
    }

    // Funções auxiliares de formatação
    formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value || 0);
    }

    formatNumber(value) {
        return new Intl.NumberFormat('pt-BR', {
            maximumFractionDigits: 0
        }).format(value || 0);
    }

    formatPercentage(value) {
        return `${(value || 0).toFixed(2)}%`;
    }
}


// Componente de Barra de Filtro - JavaScript
class FilterBar {
  constructor() {
    this.startDate = null;
    this.endDate = null;
    this.activeFilter = 'todos';
    this.callbacks = {
      onDateChange: null,
      onQuickFilter: null
    };
    
    this.init();
  }

  init() {
    this.setupEventListeners();
    this.setDefaultDates();
    this.updatePeriodDisplay();
  }

  setupEventListeners() {
    // Event listeners para inputs de data
    const startDateInput = document.getElementById('filter-start-date');
    const endDateInput = document.getElementById('filter-end-date');
    
    if (startDateInput) {
      startDateInput.addEventListener('change', (e) => {
        this.startDate = e.target.value;
        this.updatePeriodDisplay();
        this.triggerDateChange();
      });
    }
    
    if (endDateInput) {
      endDateInput.addEventListener('change', (e) => {
        this.endDate = e.target.value;
        this.updatePeriodDisplay();
        this.triggerDateChange();
      });
    }

    // Event listeners para botões de filtro rápido
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.handleQuickFilter(e.target.dataset.filter);
      });
    });
  }

  setDefaultDates() {
    const today = new Date();
    const thirtyDaysAgo = new Date(today);
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    this.startDate = this.formatDateForInput(thirtyDaysAgo);
    this.endDate = this.formatDateForInput(today);
    
    // Atualizar inputs se existirem
    const startDateInput = document.getElementById('filter-start-date');
    const endDateInput = document.getElementById('filter-end-date');
    
    if (startDateInput) startDateInput.value = this.startDate;
    if (endDateInput) endDateInput.value = this.endDate;
  }

  handleQuickFilter(filterType) {
    const today = new Date();
    let startDate;
    
    // Remover active de todos os botões
    document.querySelectorAll('.quick-filter-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    
    // Adicionar active ao botão clicado
    const activeBtn = document.querySelector(`[data-filter="${filterType}"]`);
    if (activeBtn) activeBtn.classList.add('active');
    
    switch (filterType) {
      case 'hoje':
        startDate = today;
        break;
      case '7-dias':
        startDate = new Date(today);
        startDate.setDate(today.getDate() - 7);
        break;
      case '30-dias':
        startDate = new Date(today);
        startDate.setDate(today.getDate() - 30);
        break;
      case 'todos':
        startDate = null;
        break;
    }
    
    this.activeFilter = filterType;
    
    if (startDate) {
      this.startDate = this.formatDateForInput(startDate);
      this.endDate = this.formatDateForInput(today);
      
      // Atualizar inputs
      const startDateInput = document.getElementById('filter-start-date');
      const endDateInput = document.getElementById('filter-end-date');
      
      if (startDateInput) startDateInput.value = this.startDate;
      if (endDateInput) endDateInput.value = this.endDate;
    } else {
      // Para "todos", limpar datas
      this.startDate = null;
      this.endDate = null;
      
      const startDateInput = document.getElementById('filter-start-date');
      const endDateInput = document.getElementById('filter-end-date');
      
      if (startDateInput) startDateInput.value = '';
      if (endDateInput) endDateInput.value = '';
    }
    
    this.updatePeriodDisplay();
    this.triggerDateChange();
  }

  updatePeriodDisplay() {
    const displayElement = document.getElementById('period-display');
    if (!displayElement) return;
    
    if (this.startDate && this.endDate) {
      const startFormatted = this.formatDateForDisplay(this.startDate);
      const endFormatted = this.formatDateForDisplay(this.endDate);
      displayElement.textContent = `Período: ${startFormatted} até ${endFormatted}`;
    } else {
      displayElement.textContent = 'Período: Todos os dados';
    }
  }

  formatDateForInput(date) {
    if (typeof date === 'string') return date;
    return date.toISOString().split('T')[0];
  }

  formatDateForDisplay(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
  }

  triggerDateChange() {
    if (this.callbacks.onDateChange) {
      this.callbacks.onDateChange({
        startDate: this.startDate,
        endDate: this.endDate,
        activeFilter: this.activeFilter
      });
    }
  }

  // Método para definir callback de mudança de data
  onDateChange(callback) {
    this.callbacks.onDateChange = callback;
  }

  // Método para obter filtros atuais
  getCurrentFilters() {
    return {
      startDate: this.startDate,
      endDate: this.endDate,
      activeFilter: this.activeFilter
    };
  }

  // Método para aplicar filtros aos dados
  applyDateFilter(data, dateField = 'date') {
    if (!this.startDate && !this.endDate) {
      return data;
    }

    return data.filter(item => {
      const itemDate = new Date(item[dateField]);
      const startDate = this.startDate ? new Date(this.startDate) : null;
      const endDate = this.endDate ? new Date(this.endDate) : null;

      if (startDate && itemDate < startDate) return false;
      if (endDate && itemDate > endDate) return false;

      return true;
    });
  }

  // Método para filtrar dados diários
  filterDailyData(dailyData) {
    return this.applyDateFilter(dailyData, 'date');
  }

  // Método para recarregar dashboard com filtros aplicados
  reloadDashboard() {
    // Esta função será chamada quando os filtros mudarem
    // Pode ser sobrescrita para integrar com o sistema de dados específico
    console.log('Filtros aplicados:', this.getCurrentFilters());
  }
}

// Inicializar dashboard quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
    // Extrair campaign key da URL ou usar padrão
    let campaignKey = '{{CAMPAIGN_KEY_PLACEHOLDER}}';
    
    // Criar e carregar dashboard
    const dashboard = new DashboardLoader(campaignKey);
    window.dashboard = dashboard; // Tornar dashboard acessível globalmente
    dashboard.loadDashboard();
    
    // Inicializar barra de filtro
    window.filterBar = new FilterBar();
    
    // Configurar callback para aplicar filtros quando mudarem
    window.filterBar.onDateChange((filters) => {
      console.log('🔄 Filtros alterados:', filters);
      console.log('🔍 Dashboard disponível:', !!window.dashboard);
      console.log('🔍 Método applyDateFilter existe:', typeof window.dashboard?.applyDateFilter);
      
      // Aplicar filtros no dashboard
      if (window.dashboard && typeof window.dashboard.applyDateFilter === 'function') {
        console.log('✅ Chamando window.dashboard.applyDateFilter');
        window.dashboard.applyDateFilter(filters.startDate, filters.endDate);
      } else {
        console.error('❌ Dashboard não disponível ou método applyDateFilter não existe');
      }
    });
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - COPACOL - Remarketing youtube</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0F1023;--bg2:#16213E;--panel:#1A1A2E;--muted:#9CA3AF;--stroke: rgba(139,92,246,.28);
         --grad: linear-gradient(135deg,#8B5CF6,#EC4899);}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%)}
  .container{max-width:1320px;margin:0 auto;padding:32px 32px 40px}
  .card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:14px;padding:20px;margin-bottom:24px;backdrop-filter:blur(8px)}
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:40px;height:40px;border-radius:10px;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0}
  .tab{border:1px solid rgba(148,163,184,.2);background:rgba(255,255,255,.04);padding:10px;border-radius:10px;text-align:center;cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:var(--grad);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.35)}
  .hidden{display:none}
  .metrics{display:grid;grid-template-columns:repeat(6,1fr);gap:16px}
  @media(max-width:1200px){.metrics{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){.metrics{grid-template-columns:repeat(2,1fr)} .tabs{grid-template-columns:repeat(2,1fr)} }
  .metric{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px}
  .metric .label{text-transform:uppercase;letter-spacing:.06em;color:var(--muted);font-size:.82rem}
  .metric .value{font-size:1.7rem;font-weight:800;line-height:1.15}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media(max-width:900px){.kpis{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  thead th{color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-size:.8rem;text-align:left;border-bottom:1px solid rgba(148,163,184,.22);padding:1rem}
  tbody td{padding:1rem;border-bottom:1px solid rgba(148,163,184,.14)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.4);font-weight:600;color:#00ff88}
  
  /* Modal de Loading */
  .loading-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
  }
  
  .loading-content {
    background: var(--panel);
    border: 1px solid var(--stroke);
    border-radius: 16px;
    padding: 40px;
    text-align: center;
    max-width: 400px;
    width: 90%;
  }
  
  .loading-spinner {
    width: 50px;
    height: 50px;
    border: 3px solid rgba(139, 92, 246, 0.3);
    border-top: 3px solid #8B5CF6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(139, 92, 246, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin: 20px 0;
  }
  
  .progress-fill {
    height: 100%;
    background: var(--grad);
    border-radius: 4px;
    transition: width 0.3s ease;
    width: 0%;
  }
  
  .loading-text {
    color: var(--muted);
    font-size: 14px;
    margin-bottom: 10px;
  }
  
  .loading-percentage {
    color: #fff;
    font-weight: 600;
    font-size: 16px;
  }
</style>
</head>
<body>
  <!-- Modal de Loading -->
  <div id="loadingModal" class="loading-modal">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Extraindo dados atualizados</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
      <div class="loading-percentage" id="loadingPercentage">0%</div>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="logo">
        <div class="logo-icon">üìä</div>
        <div>
          <h1>COPACOL - Remarketing youtube</h1>
          <p class="muted">Dashboard de Performance - Remarketing CPM</p>
        </div>
      </div>
      <div class="badge">
        <span>üéØ</span>
        <span>Ativa</span>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="overview">Vis√£o Geral</div>
      <div class="tab" data-tab="channel">Por Canal</div>
      <div class="tab" data-tab="planning">Planejamento</div>
      <div class="tab" data-tab="insights">An√°lise & Insights</div>
    </div>

    <!-- Vis√£o Geral -->
    <div id="overview" class="tab-content">
      <div class="card">
        <h2>Resumo da Campanha</h2>
        <div class="metrics" id="campaignMetrics">
          <!-- M√©tricas ser√£o carregadas dinamicamente -->
        </div>
      </div>

      <div class="kpis">
        <div class="card">
          <h3>Performance por Per√≠odo</h3>
          <canvas id="performanceChart"></canvas>
        </div>
        <div class="card">
          <h3>Distribui√ß√£o por Publisher</h3>
          <canvas id="publisherChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Por Canal -->
    <div id="channel" class="tab-content hidden">
      <div class="card">
        <h2>Performance por Canal</h2>
        <div class="metrics" id="channelMetrics">
          <!-- M√©tricas de canal ser√£o carregadas dinamicamente -->
        </div>
      </div>

      <div class="card">
        <h3>Dados Di√°rios</h3>
        <table id="dailyDataTable">
          <thead>
            <tr>
              <th>Data</th>
              <th>Publisher</th>
              <th>Investimento</th>
              <th>Impress√µes</th>
              <th>CPM</th>
              <th>Cliques</th>
              <th>CTR</th>
              <th>VTR</th>
            </tr>
          </thead>
          <tbody>
            <!-- Dados ser√£o carregados dinamicamente -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Planejamento -->
    <div id="planning" class="tab-content hidden">
      <div class="card">
        <h2>Informa√ß√µes do Contrato</h2>
        <div id="contractInfo">
          <!-- Informa√ß√µes de contrato ser√£o carregadas dinamicamente -->
        </div>
      </div>

      <div class="card">
        <h2>Estrat√©gias</h2>
        <div id="strategiesInfo">
          <!-- Estrat√©gias ser√£o carregadas dinamicamente -->
        </div>
      </div>

      <div class="card">
        <h2>Publishers</h2>
        <div id="publishersInfo">
          <!-- Lista de publishers ser√° carregada dinamicamente -->
        </div>
      </div>
    </div>

    <!-- An√°lise & Insights -->
    <div id="insights" class="tab-content hidden">
      <div class="card">
        <h2>Insights Autom√°ticos</h2>
        <div id="insightsContent">
          <!-- Insights ser√£o carregados dinamicamente -->
        </div>
      </div>
    </div>
  </div>

  <script>
    class DashboardLoader {
      constructor() {
        this.campaignKey = 'copacol_remarketing_youtube';
        this.apiEndpoint = `https://mvp-dashboard-builder-609095880025.us-central1.run.app`;
        this.data = null;
        this.loadingModal = document.getElementById('loadingModal');
        this.progressFill = document.getElementById('progressFill');
        this.loadingPercentage = document.getElementById('loadingPercentage');
      }

      async loadDashboard() {
        try {
          this.showLoading();
          await this.fetchData();
          this.renderDashboard();
          this.hideLoading();
        } catch (error) {
          console.error('Erro ao carregar dashboard:', error);
          this.hideLoading();
          this.renderEmptyDashboard();
        }
      }

      showLoading() {
        this.loadingModal.style.display = 'flex';
        this.updateProgress(10, 'Iniciando carregamento...');
      }

      updateProgress(percentage, text) {
        this.progressFill.style.width = `${percentage}%`;
        this.loadingPercentage.textContent = `${percentage}%`;
        if (text) {
          document.querySelector('.loading-text').textContent = text;
        }
      }

      hideLoading() {
        this.loadingModal.style.display = 'none';
      }

      async fetchData() {
        this.updateProgress(25, 'Acessando dados da planilha...');
        
        const apiUrl = `${this.apiEndpoint}/api/${this.campaignKey}/data`;
        const response = await fetch(apiUrl);
        
        this.updateProgress(50, 'Processando dados...');
        
        if (!response.ok) {
          throw new Error(`Erro na API: ${response.status}`);
        }
        
        this.data = await response.json();
        
        this.updateProgress(75, 'Calculando m√©tricas...');
        
        if (!this.data.success) {
          throw new Error(`Erro nos dados: ${this.data.message}`);
        }
        
        this.updateProgress(90, 'Preparando visualiza√ß√µes...');
        
        return this.data;
      }

      renderDashboard() {
        this.updateProgress(100, 'Dados carregados com sucesso!');
        
        // Renderizar m√©tricas da campanha
        this.renderCampaignMetrics();
        
        // Renderizar gr√°ficos
        this.renderCharts();
        
        // Renderizar dados di√°rios
        this.renderDailyData();
        
        // Renderizar informa√ß√µes de planejamento
        this.renderPlanningInfo();
        
        // Renderizar insights
        this.renderInsights();
        
        console.log('Dashboard renderizado com sucesso');
      }

      renderCampaignMetrics() {
        const metricsContainer = document.getElementById('campaignMetrics');
        const metrics = this.data.data.campaign_summary;
        const contract = this.data.data.contract;

        // M√©tricas espec√≠ficas para Remarketing CPM
        const metricsHTML = `
          <div class="metric">
            <div class="label">Investimento Contratado</div>
            <div class="value">R$ ${contract.investment?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || 'N/A'}</div>
          </div>
          <div class="metric">
            <div class="label">Investimento Utilizado</div>
            <div class="value">R$ ${metrics.total_spend?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || 'N/A'}</div>
          </div>
          <div class="metric">
            <div class="label">Impress√µes Contratadas</div>
            <div class="value">${contract.impressions_contracted?.toLocaleString('pt-BR') || 'N/A'}</div>
          </div>
          <div class="metric">
            <div class="label">Impress√µes Entregues</div>
            <div class="value">${metrics.total_impressions?.toLocaleString('pt-BR') || 'N/A'}</div>
          </div>
          <div class="metric">
            <div class="label">CPM Contratado</div>
            <div class="value">R$ ${contract.cpm_contracted?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || 'N/A'}</div>
          </div>
          <div class="metric">
            <div class="label">CPM M√©dio</div>
            <div class="value">R$ ${metrics.avg_cpm?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || 'N/A'}</div>
          </div>
        `;

        metricsContainer.innerHTML = metricsHTML;
      }

      renderCharts() {
        // Gr√°fico de Performance
        this.renderPerformanceChart();
        
        // Gr√°fico de Publishers
        this.renderPublisherChart();
      }

      renderPerformanceChart() {
        const ctx = document.getElementById('performanceChart').getContext('2d');
        const dailyData = this.data.data.daily_data;
        
        // Agrupar dados por data
        const dataByDate = {};
        dailyData.forEach(day => {
          if (!dataByDate[day.date]) {
            dataByDate[day.date] = {
              spend: 0,
              impressions: 0,
              clicks: 0
            };
          }
          dataByDate[day.date].spend += day.spend || 0;
          dataByDate[day.date].impressions += day.impressions || 0;
          dataByDate[day.date].clicks += day.clicks || 0;
        });

        const dates = Object.keys(dataByDate).sort();
        const spendData = dates.map(date => dataByDate[date].spend);
        const impressionsData = dates.map(date => dataByDate[date].impressions);

        new Chart(ctx, {
          type: 'line',
          data: {
            labels: dates,
            datasets: [
              {
                label: 'Investimento (R$)',
                data: spendData,
                borderColor: '#8B5CF6',
                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                yAxisID: 'y'
              },
              {
                label: 'Impress√µes',
                data: impressionsData,
                borderColor: '#EC4899',
                backgroundColor: 'rgba(236, 72, 153, 0.1)',
                yAxisID: 'y1'
              }
            ]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: '#fff' }
              }
            },
            scales: {
              x: {
                ticks: { color: '#9CA3AF' },
                grid: { color: 'rgba(148, 163, 184, 0.1)' }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                ticks: { color: '#9CA3AF' },
                grid: { color: 'rgba(148, 163, 184, 0.1)' }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                ticks: { color: '#9CA3AF' },
                grid: { drawOnChartArea: false }
              }
            }
          }
        });
      }

      renderPublisherChart() {
        const ctx = document.getElementById('publisherChart').getContext('2d');
        const dailyData = this.data.data.daily_data;
        
        // Agrupar dados por publisher
        const dataByPublisher = {};
        dailyData.forEach(day => {
          const publisher = day.line_item || 'Outros';
          if (!dataByPublisher[publisher]) {
            dataByPublisher[publisher] = {
              spend: 0,
              impressions: 0
            };
          }
          dataByPublisher[publisher].spend += day.spend || 0;
          dataByPublisher[publisher].impressions += day.impressions || 0;
        });

        const publishers = Object.keys(dataByPublisher);
        const spendData = publishers.map(pub => dataByPublisher[pub].spend);

        new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: publishers,
            datasets: [{
              data: spendData,
              backgroundColor: [
                '#8B5CF6',
                '#EC4899',
                '#10B981',
                '#F59E0B',
                '#EF4444',
                '#06B6D4',
                '#84CC16',
                '#F97316'
              ]
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                position: 'bottom',
                labels: { color: '#fff' }
              }
            }
          }
        });
      }

      renderDailyData() {
        const tableBody = document.querySelector('#dailyDataTable tbody');
        const dailyData = this.data.data.daily_data;

        const rows = dailyData.map(day => {
          const cpm = day.impressions > 0 ? (day.spend / day.impressions * 1000) : 0;
          const ctr = day.impressions > 0 ? (day.clicks / day.impressions * 100) : 0;
          const vtr = day.impressions > 0 ? (day.video_completions / day.impressions * 100) : 0;

          return `
            <tr>
              <td>${day.date}</td>
              <td>${day.line_item || 'N/A'}</td>
              <td>R$ ${day.spend?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || '0,00'}</td>
              <td>${day.impressions?.toLocaleString('pt-BR') || '0'}</td>
              <td>R$ ${cpm.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
              <td>${day.clicks?.toLocaleString('pt-BR') || '0'}</td>
              <td>${ctr.toLocaleString('pt-BR', {minimumFractionDigits: 2})}%</td>
              <td>${vtr.toLocaleString('pt-BR', {minimumFractionDigits: 2})}%</td>
            </tr>
          `;
        }).join('');

        tableBody.innerHTML = rows;
      }

      renderPlanningInfo() {
        const contract = this.data.data.contract;
        const strategies = this.data.data.strategies;
        const publishers = this.data.data.publishers;

        // Informa√ß√µes do Contrato
        const contractHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div>
              <strong>Cliente:</strong> ${contract.client || 'N/A'}<br>
              <strong>Campanha:</strong> ${contract.campaign || 'N/A'}<br>
              <strong>Canal:</strong> ${contract.canal || 'N/A'}<br>
              <strong>Tipo de Criativo:</strong> ${contract.tipo_criativo || 'N/A'}
            </div>
            <div>
              <strong>Investimento:</strong> R$ ${contract.investment?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || 'N/A'}<br>
              <strong>CPM Contratado:</strong> R$ ${contract.cpm_contracted?.toLocaleString('pt-BR', {minimumFractionDigits: 2}) || 'N/A'}<br>
              <strong>Per√≠odo:</strong> ${contract.period_start || 'N/A'} a ${contract.period_end || 'N/A'}
            </div>
          </div>
        `;
        document.getElementById('contractInfo').innerHTML = contractHTML;

        // Estrat√©gias
        const strategiesHTML = strategies.map(strategy => `
          <div style="border: 1px solid var(--stroke); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
            <strong>${strategy.name || 'Estrat√©gia'}</strong><br>
            <span class="muted">${strategy.description || 'Sem descri√ß√£o'}</span>
          </div>
        `).join('');
        document.getElementById('strategiesInfo').innerHTML = strategiesHTML || '<p class="muted">Nenhuma estrat√©gia encontrada</p>';

        // Publishers
        const publishersHTML = publishers.map(publisher => `
          <div style="border: 1px solid var(--stroke); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
            <strong>${publisher.name || 'Publisher'}</strong><br>
            <span class="muted">${publisher.description || 'Sem descri√ß√£o'}</span>
          </div>
        `).join('');
        document.getElementById('publishersInfo').innerHTML = publishersHTML || '<p class="muted">Nenhum publisher encontrado</p>';
      }

      renderInsights() {
        const metrics = this.data.data.campaign_summary;
        const contract = this.data.data.contract;
        
        const insights = [];

        // Insight sobre CPM
        if (metrics.avg_cpm && contract.cpm_contracted) {
          const cpmDiff = ((metrics.avg_cpm - contract.cpm_contracted) / contract.cpm_contracted * 100);
          if (cpmDiff > 10) {
            insights.push(`‚ö†Ô∏è CPM atual (R$ ${metrics.avg_cpm.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) est√° ${cpmDiff.toFixed(1)}% acima do contratado (R$ ${contract.cpm_contracted.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`);
          } else if (cpmDiff < -10) {
            insights.push(`‚úÖ CPM atual (R$ ${metrics.avg_cpm.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) est√° ${Math.abs(cpmDiff).toFixed(1)}% abaixo do contratado (R$ ${contract.cpm_contracted.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`);
          } else {
            insights.push(`‚úÖ CPM est√° dentro da meta contratada (R$ ${metrics.avg_cpm.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`);
          }
        }

        // Insight sobre investimento
        if (metrics.total_spend && contract.investment) {
          const spendPercentage = (metrics.total_spend / contract.investment * 100);
          insights.push(`üí∞ ${spendPercentage.toFixed(1)}% do investimento contratado foi utilizado (R$ ${metrics.total_spend.toLocaleString('pt-BR', {minimumFractionDigits: 2})} de R$ ${contract.investment.toLocaleString('pt-BR', {minimumFractionDigits: 2})})`);
        }

        // Insight sobre impress√µes
        if (metrics.total_impressions && contract.impressions_contracted) {
          const impressionsPercentage = (metrics.total_impressions / contract.impressions_contracted * 100);
          insights.push(`üìä ${impressionsPercentage.toFixed(1)}% das impress√µes contratadas foram entregues (${metrics.total_impressions.toLocaleString('pt-BR')} de ${contract.impressions_contracted.toLocaleString('pt-BR')})`);
        }

        const insightsHTML = insights.map(insight => `
          <div style="border: 1px solid var(--stroke); border-radius: 8px; padding: 15px; margin-bottom: 10px;">
            ${insight}
          </div>
        `).join('');

        document.getElementById('insightsContent').innerHTML = insightsHTML || '<p class="muted">Nenhum insight dispon√≠vel</p>';
      }

      renderEmptyDashboard() {
        console.log('Renderizando dashboard com dados vazios...');
        // Implementar fallback para quando n√£o h√° dados
      }
    }

    // Inicializar dashboard
    document.addEventListener('DOMContentLoaded', () => {
      const dashboard = new DashboardLoader();
      dashboard.loadDashboard();
    });

    // Gerenciar tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        // Remover classe active de todas as tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
        
        // Adicionar classe active na tab clicada
        tab.classList.add('active');
        
        // Mostrar conte√∫do correspondente
        const tabId = tab.getAttribute('data-tab');
        document.getElementById(tabId).classList.remove('hidden');
      });
    });
  </script>
</body>
</html>

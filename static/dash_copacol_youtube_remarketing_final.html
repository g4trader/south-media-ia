<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - COPACOL - Youtube Remarketing Final</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0F1023;--bg2:#16213E;--panel:#1A1A2E;--muted:#9CA3AF;--stroke: rgba(139,92,246,.28);
         --grad: linear-gradient(135deg,#8B5CF6,#EC4899);}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%)}
  .container{max-width:1320px;margin:0 auto;padding:32px 32px 40px}
  .card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:14px;padding:20px;margin-bottom:24px;backdrop-filter:blur(8px)}
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:40px;height:40px;border-radius:10px;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0}
  .tab{border:1px solid rgba(148,163,184,.2);background:rgba(255,255,255,.04);padding:10px;border-radius:10px;text-align:center;cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:var(--grad);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.35)}
  .hidden{display:none}
  .metrics{display:grid;grid-template-columns:repeat(6,1fr);gap:16px}
  @media(max-width:1200px){.metrics{grid-template-columns:repeat(3,1fr)}}
  @media(max-width:900px){.metrics{grid-template-columns:repeat(2,1fr)} .tabs{grid-template-columns:repeat(2,1fr)} }
  .metric{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px}
  .metric .label{text-transform:uppercase;letter-spacing:.06em;color:var(--muted);font-size:.82rem}
  .metric .value{font-size:1.7rem;font-weight:800;line-height:1.15}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media(max-width:900px){.kpis{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  thead th{color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-size:.8rem;text-align:left;border-bottom:1px solid rgba(148,163,184,.22);padding:1rem}
  tbody td{padding:1rem;border-bottom:1px solid rgba(148,163,184,.14)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.4);font-weight:600;color:#00ff88}
  
  /* Modal de Loading */
  .loading-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
  }
  
  .loading-content {
    background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.95));
    border: 1px solid rgba(139, 92, 246, 0.3);
    border-radius: 20px;
    padding: 40px;
    text-align: center;
    min-width: 350px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
  }
  
  .loading-spinner {
    width: 60px;
    height: 60px;
    border: 4px solid rgba(139, 92, 246, 0.3);
    border-top: 4px solid #8B5CF6;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto 20px;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .loading-content h3 {
    color: #8B5CF6;
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 10px;
  }
  
  .loading-content p {
    color: #9CA3AF;
    font-size: 16px;
    margin-bottom: 30px;
  }
  
  .progress-container {
    margin-top: 20px;
  }
  
  .progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(139, 92, 246, 0.2);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 10px;
  }
  
  .progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #8B5CF6, #EC4899);
    border-radius: 4px;
    width: 0%;
    transition: width 0.3s ease;
  }
  
  .progress-text {
    color: #8B5CF6;
    font-size: 14px;
    font-weight: 600;
  }
</style>
</head>
<body>
<div class="container">
  <div class="card header">
    <div class="logo">
      <div class="logo-icon">SM</div>
      <div>
        <div style="font-weight:800;font-size:1.1rem">South Media</div>
        <div class="muted">Dashboard - COPACOL</div>
      </div>
    </div>
    <div>
      <div style="font-weight:700;font-size:1rem;text-align:right">COPACOL - Youtube Remarketing Final</div>
      <div class="muted" style="text-align:right">Status: <span class="badge">Ativa</span></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="overview">🎬 Visão Geral</div>
    <div class="tab" data-tab="channels">🧭 Por Canal</div>
    <div class="tab" data-tab="insights">📊 Análise & Insights</div>
    <div class="tab" data-tab="planning">📋 Planejamento</div>
  </div>

  <!-- OVERVIEW -->
  <div id="tab-overview">
    <div class="metrics" id="metrics-overview-top" style="margin-bottom: 24px;"></div>
    <div class="kpis">
      <div class="card"><canvas id="chartSpendShare"></canvas></div>
      <div class="card"><canvas id="chartResults"></canvas></div>
    </div>
    <div class="card" style="margin-top:16px">
      <h3 style="margin-bottom:10px">Resumo da Campanha</h3>
      <div class="muted" style="margin-bottom:10px">Dashboard de performance para a campanha Youtube Remarketing Final do cliente COPACOL</div>
      <div style="overflow:auto">
        <table id="tableChannels">
          <thead>
            <tr>
              <th>Canal</th><th>Budget Contratado (R$)</th><th>Budget Utilizado (R$)</th><th>Pacing (%)</th>
              <th>Impressões</th><th>Cliques</th><th>CTR</th><th>Imp Entregue</th>
              <th>CPM Contratado (R$)</th><th>CPM (R$)</th>
            </tr>
          </thead>
          <tbody id="tbodyChannels"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CHANNELS -->
  <div id="tab-channels" class="hidden">
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div style="font-weight:800">Canal:</div>
        <div style="padding:8px 10px;border-radius:8px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.06);color:#fff">YouTube</div>
      </div>
    </div>
    
    <!-- Cards de Totalizadores das Principais Métricas de Entrega -->
    <div class="metrics" id="metrics-channel-summary" style="margin-bottom: 24px;">
      <!-- Cards serão preenchidos dinamicamente -->
    </div>
    
    <div class="metrics" id="metrics-channel"></div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-bottom:10px">Entrega diária — YouTube</h3>
      <div style="overflow:auto">
        <table id="channelDailyTable">
          <thead>
            <tr><th>Data</th><th>Budget (R$)</th><th>Impressões</th><th>Cliques</th><th>CTR</th><th>CPM</th><th>Creative</th></tr>
          </thead>
          <tbody id="channelDailyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div id="tab-insights" class="hidden">
    <div id="insights-content">
      <!-- Conteúdo será carregado dinamicamente -->
    </div>
  </div>

  <!-- PLANNING -->
  <div id="tab-planning" class="hidden">
    <div id="planning-content">
      <!-- Conteúdo será carregado dinamicamente -->
    </div>
  </div>
  </div>

  <!-- Modal de Loading -->
  <div id="loadingModal" class="loading-modal">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Carregando Dashboard</h3>
      <p>Extraindo dados atualizados...</p>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="progress-text" id="progressText">0%</div>
      </div>
    </div>
  </div>

  <script>
// Sistema de Loading com Dados Reais
class DashboardLoader {
    constructor(campaignKey) {
        this.campaignKey = campaignKey;
        // Usar Cloud Run diretamente para máxima confiabilidade
        this.apiEndpoint = `http://localhost:5002`;
        this.loadingModal = document.getElementById('loadingModal');
        this.progressFill = document.getElementById('progressFill');
        this.progressText = document.getElementById('progressText');
        this.currentProgress = 0;
        this.maxProgress = 100;
        this.currentStep = 0;
    }

    async loadDashboard() {
        try {
            // 1. Iniciando carregamento
            this.updateProgress(10, "Iniciando carregamento...");
            
            // 2. Acessando dados da planilha
            this.updateProgress(25, "Acessando dados da planilha...");
            const data = await this.fetchData();
            
            // 3. Dados recebidos
            this.updateProgress(50, "Dados recebidos com sucesso!");
            
            // 4. Calculando métricas
            this.updateProgress(60, "Calculando métricas...");
            
            // 5. Atualizando dashboard
            this.updateProgress(80, "Atualizando dashboard...");
            await this.renderDashboard(data);
            
            // 6. Finalizando
            this.updateProgress(95, "Finalizando...");
            
            // 7. Dados carregados com sucesso
            this.updateProgress(100, "Dados carregados com sucesso!");
            
            // Aguardar um pouco para mostrar o sucesso
            await this.delay(500);
            
            // Esconder modal
            this.hideLoadingScreen();
            
        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
            this.updateProgress(0, "Erro ao carregar dados");
            // Em vez de mostrar erro, renderizar com dados vazios
            console.log('Renderizando dashboard com dados vazios...');
            this.renderDashboard({});
        }
    }

    async fetchData() {
        const apiUrl = `${this.apiEndpoint}/api/${this.campaignKey}/data`;
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
        }
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.message || 'Erro ao carregar dados');
        }
        return result.data;
    }

    showLoadingScreen() {
        // Mostrar modal de loading
        if (this.loadingModal) {
            this.loadingModal.style.display = 'flex';
        }
        
        const loadingHtml = `
            <div id="loadingScreen" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                color: white;
            ">
                <div style="text-align: center; max-width: 400px; padding: 40px;">
                    <div style="
                        width: 80px;
                        height: 80px;
                        border: 4px solid rgba(139, 92, 246, 0.3);
                        border-top: 4px solid #8B5CF6;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 30px;
                    "></div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 10px;
                        background: linear-gradient(135deg, #8B5CF6, #EC4899);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    ">Carregando Dashboard</h2>
                    
                    <div style="
                        font-size: 16px;
                        color: #9CA3AF;
                        margin-bottom: 30px;
                    " id="loadingText">Inicializando...</div>
                    
                    <div style="
                        width: 100%;
                        height: 6px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 3px;
                        overflow: hidden;
                        margin-bottom: 20px;
                    ">
                        <div id="progressBar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #8B5CF6, #EC4899);
                            border-radius: 3px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                    
                    <div style="
                        font-size: 14px;
                        color: #6B7280;
                    " id="progressText">0%</div>
                </div>
                
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>
        `;
        document.body.innerHTML = loadingHtml;
    }

    updateProgress(percentage, text) {
        // Atualizar modal de loading
        if (this.progressFill) {
            this.progressFill.style.width = percentage + '%';
        }
        if (this.progressText) {
            this.progressText.textContent = text || percentage + '%';
        }
        
        // Manter compatibilidade com loading screen antigo
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        if (loadingText) loadingText.textContent = text;
        if (progressBar) progressBar.style.width = percentage + '%';
        if (progressText) progressText.textContent = percentage + '%';
        
        console.log(`Progresso: ${percentage}% - ${text}`);
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }


    hideLoadingScreen() {
        // Esconder modal de loading
        if (this.loadingModal) {
            this.loadingModal.style.display = 'none';
        }
        
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.remove();
        }
    }

    showError(message) {
        const errorHtml = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                color: white;
            ">
                <div style="
                    text-align: center;
                    max-width: 500px;
                    padding: 40px;
                    background: rgba(26, 26, 46, 0.8);
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 16px;
                    backdrop-filter: blur(10px);
                ">
                    <div style="
                        font-size: 48px;
                        margin-bottom: 20px;
                    ">❌</div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 15px;
                        color: #EF4444;
                    ">Erro ao Carregar Dashboard</h2>
                    
                    <p style="
                        font-size: 16px;
                        color: #9CA3AF;
                        margin-bottom: 30px;
                        line-height: 1.5;
                    ">${message}</p>
                    
                    <button onclick="location.reload()" style="
                        background: linear-gradient(135deg, #8B5CF6, #EC4899);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 14px;
                    ">Tentar Novamente</button>
                </div>
            </div>
        `;
        document.body.innerHTML = errorHtml;
    }

    async renderDashboard(data) {
        // Renderizar dados diretamente no HTML existente
        this.renderMetrics(data);
        this.renderCharts(data);
        this.renderTables(data);
        this.renderChannelSummaryCards(data);
        this.renderInsights(data);
        this.renderPlanning(data);
        this.setupEventListeners();
        
        // Aguardar um pouco para garantir que tudo foi renderizado
        await this.delay(100);
    }

    renderMetrics(data) {
        // Renderizar métricas principais
        const metricsContainer = document.getElementById('metrics-overview-top');
        if (metricsContainer && data.campaign_summary) {
            const summary = data.campaign_summary;
            const contract = data.contract || {};
            metricsContainer.innerHTML = `
                <div class="metric">
                    <div class="label">💰 Investimento</div>
                    <div class="value">${this.formatCurrency(summary.investment || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">💸 Budget Utilizado</div>
                    <div class="value">${this.formatCurrency(summary.total_spend || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">🎯 Imp Contratadas</div>
                    <div class="value">${this.formatNumber(summary.complete_views_contracted || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📺 Imp Entregue</div>
                    <div class="value">${this.formatNumber(summary.total_impressions || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📈 Pacing</div>
                    <div class="value">${this.formatPercentage(summary.pacing || 0)}</div>
                </div>
                    <div class="metric">
                        <div class="label">💵 CPM Contratado</div>
                        <div class="value">${this.formatCurrency(contract.cpv_contracted || 0)}</div>
                    </div>
            `;
        }
    }

    renderCharts(data) {
        // Renderizar gráficos básicos
        const spendCtx = document.getElementById('chartSpendShare');
        const resultsCtx = document.getElementById('chartResults');
        
        if (spendCtx && data.campaign_summary) {
            new Chart(spendCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilizado', 'Restante'],
                    datasets: [{
                        data: [
                            data.campaign_summary.total_spend || 0,
                            (data.campaign_summary.investment || 0) - (data.campaign_summary.total_spend || 0)
                        ],
                        backgroundColor: ['#8B5CF6', '#EC4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#9CA3AF' }
                        }
                    }
                }
            });
        }
        
        if (resultsCtx && data.campaign_summary) {
            new Chart(resultsCtx, {
                type: 'bar',
                data: {
                    labels: ['Impressões', 'Cliques', 'VC'],
                    datasets: [{
                        label: 'Performance',
                        data: [
                            data.campaign_summary.total_impressions || 0,
                            data.campaign_summary.total_clicks || 0,
                            data.campaign_summary.total_video_completions || 0
                        ],
                        backgroundColor: ['#8B5CF6', '#EC4899', '#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#9CA3AF' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }
    }

    renderTables(data) {
        // Renderizar tabela de resumo consolidado
        const tbodyChannels = document.getElementById('tbodyChannels');
        if (tbodyChannels && data.campaign_summary && data.contract) {
            const summary = data.campaign_summary;
            const contract = data.contract;
            
            // Calcular pacing
            const pacing = contract.investment > 0 ? (summary.total_spend / contract.investment * 100) : 0;
            
            tbodyChannels.innerHTML = `
                <tr>
                    <td>${contract.canal || 'Video Programática'}</td>
                    <td>R$ ${this.formatCurrency(contract.investment || 0)}</td>
                    <td>R$ ${this.formatCurrency(summary.total_spend || 0)}</td>
                    <td>${this.formatPercentage(pacing)}</td>
                    <td>${this.formatNumber(summary.total_impressions || 0)}</td>
                    <td>${this.formatNumber(summary.total_clicks || 0)}</td>
                    <td>${this.formatPercentage(summary.ctr || 0)}</td>
                    <td>${this.formatNumber(summary.total_impressions || 0)}</td>
                    <td>R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2).replace('.', ',') : '0,00'}</td>
                    <td>R$ ${this.formatCurrency(summary.cpm || 0)}</td>
                </tr>
            `;
        }

        // Renderizar tabela de entrega diária por canal
        const channelDailyBody = document.getElementById('channelDailyBody');
        if (channelDailyBody && data.daily_data && data.daily_data.length > 0) {
            const contract = data.contract || {};
            channelDailyBody.innerHTML = data.daily_data.map(record => {
                const cpm = record.impressions ? 
                    (record.spend / record.impressions * 1000) : 0;
                
                return `
                    <tr>
                        <td>${record.date}</td>
                        <td>R$ ${this.formatCurrency(record.spend)}</td>
                        <td>${this.formatNumber(record.impressions)}</td>
                        <td>${this.formatNumber(record.clicks)}</td>
                        <td>${this.formatPercentage(record.ctr)}</td>
                        <td>R$ ${this.formatCurrency(cpm)}</td>
                        <td>${record.creative || 'N/A'}</td>
                    </tr>
                `;
            }).join('');
        }
    }

    renderChannelSummaryCards(data) {
        // Renderizar cards de totalizadores das principais métricas de entrega
        const summaryContainer = document.getElementById('metrics-channel-summary');
        if (summaryContainer && data.campaign_summary && data.contract) {
            const summary = data.campaign_summary;
            const contract = data.contract;
            
            // Calcular métricas adicionais
            const pacing = contract.investment > 0 ? (summary.total_spend / contract.investment * 100) : 0;
            const vc_pacing = contract.complete_views_contracted > 0 ? (summary.total_video_completions / contract.complete_views_contracted * 100) : 0;
            const vtr = summary.total_video_starts > 0 ? (summary.total_video_completions / summary.total_video_starts * 100) : 0;
            const ctr = summary.total_impressions > 0 ? (summary.total_clicks / summary.total_impressions * 100) : 0;
            const cpm = summary.total_impressions > 0 ? (summary.total_spend / summary.total_impressions * 1000) : 0;
            
            summaryContainer.innerHTML = `
                <div class="metric">
                    <div class="label">💰 Budget Total</div>
                    <div class="value">${this.formatCurrency(contract.investment || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">💸 Budget Utilizado</div>
                    <div class="value">${this.formatCurrency(summary.total_spend || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📈 Pacing Financeiro</div>
                    <div class="value">${this.formatPercentage(pacing)}</div>
                </div>
                <div class="metric">
                    <div class="label">🎯 Imp Contratadas</div>
                    <div class="value">${this.formatNumber(contract.complete_views_contracted || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📺 Imp Entregue</div>
                    <div class="value">${this.formatNumber(summary.total_impressions || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📊 Pacing Imp</div>
                    <div class="value">${this.formatPercentage(vc_pacing)}</div>
                </div>
                <div class="metric">
                    <div class="label">🖱️ Total Cliques</div>
                    <div class="value">${this.formatNumber(summary.total_clicks || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">📱 CTR Médio</div>
                    <div class="value">${this.formatPercentage(ctr)}</div>
                </div>
                <div class="metric">
                    <div class="label">💵 CPM Contratado</div>
                    <div class="value">${this.formatCurrency(contract.cpv_contracted || 0)}</div>
                </div>
            `;
        }
    }

    renderInsights(data) {
        // Renderizar aba de análise e insights
        const insightsContainer = document.getElementById('insights-content');
        if (insightsContainer && data.contract && data.strategies) {
            const summary = data.campaign_summary || {};
            const contract = data.contract;
            
            // Renderizar insights dinâmicos
            const insightsList = data.insights && data.insights.length > 0 ? data.insights : [
                "Campanha tem espaço para acelerar o investimento.",
                `CPM atual (R$ ${summary.cpm ? summary.cpm.toFixed(2) : '0.00'}) está ${summary.cpm && contract.cpv_contracted ? (summary.cpm < contract.cpv_contracted ? 'abaixo' : 'acima') : 'dentro'} do contratado (R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2) : '0.00'}).`,
                "CTR baixo - revisar targeting e criativos para melhorar engajamento."
            ];

            insightsContainer.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header Section -->
                    <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1)); border: 1px solid rgba(139,92,246,.3);">
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="margin-bottom: 12px; color: #8B5CF6; font-size: 28px; font-weight: 700">
                                📊 Análise & Insights
                            </h2>
                            <div style="color: #9CA3AF; font-size: 16px">
                                Análise de Performance e Recomendações
                            </div>
                        </div>
                    </div>

                    <!-- Performance Summary -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 20px; color: #8B5CF6; font-size: 20px; font-weight: 700">
                            📈 Resumo de Performance
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(16,185,129,.1), rgba(5,150,105,.1)); border-radius: 12px; border: 1px solid rgba(16,185,129,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #10B981; margin-bottom: 8px;">
                                    ${summary.pacing ? summary.pacing.toFixed(1) : '0.0'}%
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">Pacing da Campanha</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1)); border-radius: 12px; border: 1px solid rgba(139,92,246,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #8B5CF6; margin-bottom: 8px;">
                                    ${contract.cpv_contracted ? 'R$ ' + contract.cpv_contracted.toFixed(2).replace('.', ',') : 'R$ 0,00'}
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">CPM Contratado</div>
                            </div>
                            <div style="padding: 20px; background: linear-gradient(135deg, rgba(59,130,246,.1), rgba(37,99,235,.1)); border-radius: 12px; border: 1px solid rgba(59,130,246,.3); text-align: center;">
                                <div style="font-size: 32px; font-weight: 700; color: #3B82F6; margin-bottom: 8px;">
                                    ${summary.ctr ? summary.ctr.toFixed(2) : '0.00'}%
                                </div>
                                <div style="color: #9CA3AF; font-size: 14px;">CTR (Click-Through Rate)</div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Insights -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                            💡 Insights Principais
                        </h4>
                        <div style="display: grid; gap: 12px;">
                            ${insightsList.map(insight => `
                                <div style="
                                    padding: 16px;
                                    border-radius: 12px;
                                    border: 1px solid rgba(139,92,246,.3);
                                    background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1));
                                ">
                                    <div style="color: #E5E7EB; line-height: 1.6;">
                                        ${insight}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
    }

    renderPlanning(data) {
        // Renderizar aba de planejamento com dados reais
        const planningContainer = document.getElementById('planning-content');
        if (planningContainer && data.contract && data.publishers && data.strategies) {
            const summary = data.campaign_summary || {};
            const contract = data.contract;
            
            // Calcular pacing
            const pacing = contract.investment > 0 ? (summary.total_spend / contract.investment * 100) : 0;
            
            // Renderizar publishers em grid
            const publishersHtml = data.publishers.map(publisher => `
                <div style="
                    padding: 12px 16px;
                    border-radius: 12px;
                    border: 1px solid rgba(148,163,184,.2);
                    background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1));
                    color: #fff;
                    font-weight: 600;
                    font-size: 13px;
                    text-align: center;
                    min-width: 160px;
                    max-width: 160px;
                    height: 48px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    word-wrap: break-word;
                    word-break: break-all;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    transition: all 0.3s ease;
                    cursor: pointer;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(139,92,246,.3)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                   title="${publisher.publisher || publisher.name || 'N/A'}">
                    ${publisher.publisher || publisher.name || 'N/A'}
                </div>
            `).join('');
            
            // Renderizar estratégias
            const strategiesHtml = data.strategies.map(strategy => `
                <div style="
                    padding: 16px;
                    border-radius: 12px;
                    border: 1px solid rgba(139,92,246,.3);
                    background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1));
                    margin-bottom: 12px;
                ">
                    <div style="font-weight: 700; color: #8B5CF6; margin-bottom: 8px; font-size: 16px">
                        ${strategy.strategy || strategy.name || 'Estratégia'}
                    </div>
                    ${strategy.type ? `<div style="color: #9CA3AF; font-size: 14px">${strategy.type}</div>` : ''}
                </div>
            `).join('');

            planningContainer.innerHTML = `
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header Section -->
                    <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(236,72,153,.1)); border: 1px solid rgba(139,92,246,.3);">
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="margin-bottom: 12px; color: #8B5CF6; font-size: 28px; font-weight: 700">
                                📋 Planejamento da Campanha
                            </h2>
                            <div style="color: #9CA3AF; font-size: 16px">
                                ${contract.client || 'N/A'} - ${contract.campaign || 'N/A'}
                            </div>
                            <div style="margin-top: 12px;">
                                <span style="
                                    background: linear-gradient(135deg, #10B981, #059669);
                                    color: white;
                                    padding: 8px 16px;
                                    border-radius: 20px;
                                    font-weight: 600;
                                    font-size: 14px;
                                ">${summary.status || 'ATIVA'}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Overview -->
                    <div class="card" style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 20px; color: #8B5CF6; font-size: 20px; font-weight: 700">
                            🎯 Objetivo da Campanha
                        </h3>
                        <p style="
                            color: #E5E7EB;
                            font-size: 16px;
                            line-height: 1.6;
                            background: rgba(139,92,246,.1);
                            padding: 20px;
                            border-radius: 12px;
                            border: 1px solid rgba(139,92,246,.2);
                        ">
                            Campanha institucional da ${contract.client || 'Cliente'} no ${contract.canal || 'Video Programática'} com foco em Alcance para fortalecer a marca e comunicar valores de qualidade, sustentabilidade e cooperativismo.
                        </p>
                    </div>

                    <!-- Grid Layout -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                        <!-- Left Column -->
                        <div>
                            <!-- Timeline & Investment -->
                            <div class="card" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    📅 Cronograma & Investimento
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Período:</span>
                                        <span style="color: #fff; font-weight: 600;">${contract.period_start && contract.period_end ? `${contract.period_start} a ${contract.period_end}` : 'N/A'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Budget Total:</span>
                                        <span style="color: #10B981; font-weight: 600;">${this.formatCurrency(contract.investment || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Budget Utilizado:</span>
                                        <span style="color: #F59E0B; font-weight: 600;">${this.formatCurrency(summary.total_spend || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Pacing:</span>
                                        <span style="color: #8B5CF6; font-weight: 600;">${this.formatPercentage(pacing)}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Metrics -->
                            <div class="card">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    🎯 Métricas Contratadas
                                </h4>
                                <div style="display: grid; gap: 12px;">
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Meta Imp:</span>
                                        <span style="color: #fff; font-weight: 600;">${this.formatNumber(contract.complete_views_contracted || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Imp Entregue:</span>
                                        <span style="color: #10B981; font-weight: 600;">${this.formatNumber(summary.total_video_completions || 0)}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">Pacing Imp:</span>
                                        <span style="color: #8B5CF6; font-weight: 600;">${contract.complete_views_contracted > 0 ? this.formatPercentage((summary.total_video_completions / contract.complete_views_contracted * 100) || 0) : '0,00%'}</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(139,92,246,.1); border-radius: 8px;">
                                        <span style="color: #9CA3AF;">CPM Contratado:</span>
                                        <span style="color: #F59E0B; font-weight: 600;">R$ ${contract.cpv_contracted ? contract.cpv_contracted.toFixed(2).replace('.', ',') : '0,00'}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div>
                            <!-- Publishers -->
                            <div class="card" style="margin-bottom: 20px;">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    📊 Publishers
                                </h4>
                                <div style="
                                    display: grid;
                                    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
                                    gap: 12px;
                                    max-height: 300px;
                                    overflow-y: auto;
                                    padding: 8px;
                                ">
                                    ${publishersHtml}
                                </div>
                            </div>

                            <!-- Strategies -->
                            <div class="card">
                                <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                                    🎯 Estratégias
                                </h4>
                                <div style="max-height: 300px; overflow-y: auto;">
                                    ${strategiesHtml}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contract Info -->
                    <div class="card">
                        <h4 style="margin-bottom: 16px; color: #8B5CF6; font-size: 18px; font-weight: 700">
                            📋 Informações do Contrato
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                            <div style="padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px; border: 1px solid rgba(139,92,246,.3);">
                                <div style="color: #9CA3AF; font-size: 14px; margin-bottom: 4px;">Canal</div>
                                <div style="color: #fff; font-weight: 600;">${contract.canal || 'N/A'}</div>
                            </div>
                            <div style="padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px; border: 1px solid rgba(139,92,246,.3);">
                                <div style="color: #9CA3AF; font-size: 14px; margin-bottom: 4px;">Tipo de Criativo</div>
                                <div style="color: #fff; font-weight: 600;">${contract.tipo_criativo || 'N/A'}</div>
                            </div>
                            <div style="padding: 16px; background: rgba(139,92,246,.1); border-radius: 12px; border: 1px solid rgba(139,92,246,.3);">
                                <div style="color: #9CA3AF; font-size: 14px; margin-bottom: 4px;">Última Atualização</div>
                                <div style="color: #fff; font-weight: 600;">${data.last_updated ? new Date(data.last_updated).toLocaleString('pt-BR') : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    }

    setupEventListeners() {
        // Configurar navegação por tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabId = tab.dataset.tab;
                ['overview', 'channels', 'insights', 'planning'].forEach(key => {
                    const element = document.getElementById(`tab-${key}`);
                    if (element) {
                        element.classList.toggle('hidden', key !== tabId);
                    }
                });
            });
        });
    }

    // Funções auxiliares de formatação
    formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value || 0);
    }

    formatNumber(value) {
        return new Intl.NumberFormat('pt-BR', {
            maximumFractionDigits: 0
        }).format(value || 0);
    }

    formatPercentage(value) {
        return `${(value || 0).toFixed(2)}%`;
    }
}

// Inicializar dashboard quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
    // Extrair campaign key da URL ou usar padrão
    let campaignKey = 'copacol_youtube_remarketing_final';
    
    // Criar e carregar dashboard
    const dashboard = new DashboardLoader(campaignKey);
    dashboard.loadDashboard();
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard - {{CLIENT_NAME}} - {{CAMPAIGN_NAME}}</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--bg:#0F1023;--bg2:#16213E;--panel:#1A1A2E;--muted:#9CA3AF;--stroke: rgba(139,92,246,.28);
         --grad: linear-gradient(135deg,#8B5CF6,#EC4899);}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%)}
  .container{max-width:1320px;margin:0 auto;padding:32px 32px 40px}
  .card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:14px;padding:20px;margin-bottom:24px;backdrop-filter:blur(8px)}
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:40px;height:40px;border-radius:10px;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0}
  .tab{border:1px solid rgba(148,163,184,.2);background:rgba(255,255,255,.04);padding:10px;border-radius:10px;text-align:center;cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:var(--grad);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.35)}
  .hidden{display:none}
  .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  @media(max-width:900px){.metrics{grid-template-columns:repeat(2,1fr)} .tabs{grid-template-columns:repeat(2,1fr)} }
  .metric{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px}
  .metric .label{text-transform:uppercase;letter-spacing:.06em;color:var(--muted);font-size:.82rem}
  .metric .value{font-size:1.7rem;font-weight:800;line-height:1.15}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media(max-width:900px){.kpis{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  thead th{color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-size:.8rem;text-align:left;border-bottom:1px solid rgba(148,163,184,.22);padding:1rem}
  tbody td{padding:1rem;border-bottom:1px solid rgba(148,163,184,.14)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.4);font-weight:600;color:#00ff88}
</style>
</head>
<body>
<div class="container">
  <div class="card header">
    <div class="logo">
      <div class="logo-icon">SM</div>
      <div>
        <div style="font-weight:800;font-size:1.1rem">South Media</div>
        <div class="muted">Dashboard - <span id="header-client">{{CLIENT_NAME}}</span></div>
      </div>
    </div>
    <div>
      <div id="header-campaign" style="font-weight:700;font-size:1rem;text-align:right">{{CLIENT_NAME}} - {{CAMPAIGN_NAME}}</div>
      <div class="muted" style="text-align:right">Status: <span class="badge" id="header-status">{{CAMPAIGN_STATUS}}</span></div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="overview">üé¨ Vis√£o Geral</div>
    <div class="tab" data-tab="channels">üß≠ Por Canal</div>
    <div class="tab" data-tab="insights">üìä An√°lise & Insights</div>
    <div class="tab" data-tab="planning">üìã Planejamento</div>
  </div>

  <!-- OVERVIEW -->
  <div id="tab-overview">
    <div class="metrics" id="metrics-overview-top"></div>
    <div class="kpis">
      <div class="card"><canvas id="chartSpendShare"></canvas></div>
      <div class="card"><canvas id="chartResults"></canvas></div>
    </div>
    <div class="card" style="margin-top:16px">
      <h3 style="margin-bottom:10px">Resumo da Campanha</h3>
      <div id="campaign-description" class="muted" style="margin-bottom:10px">{{CAMPAIGN_DESCRIPTION}}</div>
      <div style="overflow:auto">
        <table id="tableChannels">
          <thead>
            <tr>
              <th>Canal</th><th>Budget Contratado (R$)</th><th>Budget Utilizado (R$)</th><th>Pacing (%)</th>
              <th>Impress√µes</th><th>Cliques</th><th>CTR</th><th>VC (100%)</th><th>VTR (100%)</th>
              <th>CPV (R$)</th><th>CPM (R$)</th>
            </tr>
          </thead>
          <tbody id="tbodyChannels"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- CHANNELS -->
  <div id="tab-channels" class="hidden">
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
        <div style="font-weight:800">Canal:</div>
        <div id="primary-channel-badge" style="padding:8px 10px;border-radius:8px;border:1px solid rgba(148,163,184,.25);background:rgba(255,255,255,.06);color:#fff">{{PRIMARY_CHANNEL}}</div>
      </div>
    </div>
    <div class="metrics" id="metrics-channel"></div>

    <div class="card" style="margin-top:16px">
      <h3 id="primary-channel-title" style="margin-bottom:10px">Entrega di√°ria ‚Äî {{PRIMARY_CHANNEL}}</h3>
      <div style="overflow:auto">
        <table id="channelDailyTable">
          <thead>
            <tr><th>Data</th><th>Budget (R$)</th><th>Impress√µes</th><th>Cliques</th><th>CTR</th><th>VC</th><th>VTR</th><th>CPV</th><th>CPM</th></tr>
          </thead>
          <tbody id="channelDailyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- INSIGHTS -->
  <div id="tab-insights" class="hidden">
    <div class="card">
      <h3 style="margin-bottom:16px">üìä An√°lise & Insights</h3>
      <div style="display:grid;gap:16px">
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üéØ Estrat√©gia de Segmenta√ß√£o</h4>
          <ul id="insights-segmentation" data-hide-when-empty="true" style="margin-left:20px;line-height:1.6">
            {{SEGMENTATION_STRATEGY}}
          </ul>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üì± Estrat√©gia Criativa</h4>
          <ul id="insights-creative" data-hide-when-empty="true" style="margin-left:20px;line-height:1.6">
            {{CREATIVE_STRATEGY}}
          </ul>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üöÄ Objetivos da Campanha</h4>
          <div id="insights-objectives" data-hide-when-empty="true" style="line-height:1.6;margin-bottom:12px">{{CAMPAIGN_OBJECTIVES}}</div>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üìå Principais Insights</h4>
          <ul id="insights-highlights" data-hide-when-empty="true" style="margin-left:20px;line-height:1.6"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- PLANNING -->
  <div id="tab-planning" class="hidden">
    <div class="card">
      <h3 style="margin-bottom:16px">üìã Planejamento</h3>
      <div style="display:grid;gap:20px">
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üìÖ Cronograma</h4>
          <p><strong>Per√≠odo:</strong> <span id="planning-period">{{CAMPAIGN_PERIOD}}</span></p>
          <p><strong>Status:</strong> <span id="planning-status">{{CAMPAIGN_STATUS}}</span></p>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üí∞ Investimento</h4>
          <p><strong>Budget Total:</strong> R$ <span id="planning-budget-total">{{TOTAL_BUDGET}}</span></p>
          <p><strong>Budget Utilizado:</strong> R$ <span id="planning-budget-used">{{BUDGET_USED}}</span></p>
          <p><strong>Pacing:</strong> <span id="planning-pacing">{{PACING_PERCENTAGE}}%</span></p>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üéØ M√©tricas</h4>
          <p><strong>Meta VC:</strong> <span id="planning-target-vc">{{TARGET_VC}}</span></p>
          <p><strong>CPV Contratado:</strong> R$ <span id="planning-cpv-contracted">{{CPV_CONTRACTED}}</span></p>
          <p><strong>CPV Atual:</strong> R$ <span id="planning-cpv-current">{{CPV_CURRENT}}</span></p>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üìä Canais</h4>
          <div id="planning-channel-badges" data-hide-when-empty="true" style="display:flex;gap:8px;flex-wrap:wrap">
            {{CHANNEL_BADGES}}
          </div>
        </div>
        <div>
          <h4 style="margin-bottom:8px;color:#8B5CF6">üé¨ Formatos</h4>
          <ul id="planning-formats" style="margin-left:20px;line-height:1.6">
            {{FORMAT_SPECIFICATIONS}}
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Sistema de Loading com Dados Reais
class DashboardLoader {
    constructor(campaignKey) {
        this.campaignKey = campaignKey;
        this.data = null;
        // Usar Cloud Run diretamente para m√°xima confiabilidade
        this.apiEndpoint = `{{API_ENDPOINT}}`;
        this.loadingSteps = [
            { text: "Inicializando...", progress: 10 },
            { text: "Conectando com Google Sheets...", progress: 30 },
            { text: "Extraindo dados da planilha...", progress: 50 },
            { text: "Processando m√©tricas...", progress: 70 },
            { text: "Renderizando dashboard...", progress: 90 },
            { text: "Conclu√≠do!", progress: 100 }
        ];
        this.currentStep = 0;
    }

    async loadDashboard() {
        try {
            // Carregar dados reais diretamente
            const data = await this.fetchData();
            
            // Renderizar dashboard
            this.renderDashboard(data);
            
        } catch (error) {
            console.error('Erro ao carregar dashboard:', error);
            // Em vez de mostrar erro, renderizar com dados vazios
            console.log('Renderizando dashboard com dados vazios...');
            this.renderDashboard({});
        }
    }

    async fetchData() {
        const response = await fetch(this.apiEndpoint);
        if (!response.ok) {
            throw new Error(`Erro na API: ${response.status} ${response.statusText}`);
        }
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.message || 'Erro ao carregar dados');
        }
        return result.data;
    }

    showLoadingScreen() {
        const loadingHtml = `
            <div id="loadingScreen" style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                color: white;
            ">
                <div style="text-align: center; max-width: 400px; padding: 40px;">
                    <div style="
                        width: 80px;
                        height: 80px;
                        border: 4px solid rgba(139, 92, 246, 0.3);
                        border-top: 4px solid #8B5CF6;
                        border-radius: 50%;
                        animation: spin 1s linear infinite;
                        margin: 0 auto 30px;
                    "></div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 10px;
                        background: linear-gradient(135deg, #8B5CF6, #EC4899);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        background-clip: text;
                    ">Carregando Dashboard</h2>
                    
                    <div style="
                        font-size: 16px;
                        color: #9CA3AF;
                        margin-bottom: 30px;
                    " id="loadingText">Inicializando...</div>
                    
                    <div style="
                        width: 100%;
                        height: 6px;
                        background: rgba(255, 255, 255, 0.1);
                        border-radius: 3px;
                        overflow: hidden;
                        margin-bottom: 20px;
                    ">
                        <div id="progressBar" style="
                            width: 0%;
                            height: 100%;
                            background: linear-gradient(90deg, #8B5CF6, #EC4899);
                            border-radius: 3px;
                            transition: width 0.3s ease;
                        "></div>
                    </div>
                    
                    <div style="
                        font-size: 14px;
                        color: #6B7280;
                    " id="progressText">0%</div>
                </div>
                
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            </div>
        `;
        document.body.innerHTML = loadingHtml;
    }

    async updateProgress(step) {
        const loadingText = document.getElementById('loadingText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        if (loadingText) loadingText.textContent = step.text;
        if (progressBar) progressBar.style.width = step.progress + '%';
        if (progressText) progressText.textContent = step.progress + '%';
    }

    delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    hideLoadingScreen() {
        const loadingScreen = document.getElementById('loadingScreen');
        if (loadingScreen) {
            loadingScreen.remove();
        }
    }

    showError(message) {
        const errorHtml = `
            <div style="
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                font-family: 'Inter', sans-serif;
                color: white;
            ">
                <div style="
                    text-align: center;
                    max-width: 500px;
                    padding: 40px;
                    background: rgba(26, 26, 46, 0.8);
                    border: 1px solid rgba(139, 92, 246, 0.3);
                    border-radius: 16px;
                    backdrop-filter: blur(10px);
                ">
                    <div style="
                        font-size: 48px;
                        margin-bottom: 20px;
                    ">‚ùå</div>
                    
                    <h2 style="
                        font-size: 24px;
                        font-weight: 700;
                        margin-bottom: 15px;
                        color: #EF4444;
                    ">Erro ao Carregar Dashboard</h2>
                    
                    <p style="
                        font-size: 16px;
                        color: #9CA3AF;
                        margin-bottom: 30px;
                        line-height: 1.5;
                    ">${message}</p>
                    
                    <button onclick="location.reload()" style="
                        background: linear-gradient(135deg, #8B5CF6, #EC4899);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        font-size: 14px;
                    ">Tentar Novamente</button>
                </div>
            </div>
        `;
        document.body.innerHTML = errorHtml;
    }

    renderDashboard(data) {
        // Renderizar dados diretamente no HTML existente
        this.data = data || {};
        this.renderHeader(data);
        this.renderChannelsSection(data);
        this.renderPlanning(data);
        this.renderInsights(data);
        this.renderMetrics(data);
        this.renderCharts(data);
        this.renderTables(data);
        this.setupEventListeners();
    }

    renderHeader(data) {
        const contract = (data && data.contract) || {};
        const clientName = this.resolveText(
            contract.client,
            data && data.client,
            data && data.client_name
        );
        this.updateText('header-client', clientName);

        const campaignName = this.resolveText(
            contract.campaign,
            data && data.campaign,
            data && data.campaign_name
        );

        const campaignElement = document.getElementById('header-campaign');
        if (campaignElement && (clientName || campaignName)) {
            const parts = [];
            if (clientName) parts.push(clientName);
            if (campaignName) parts.push(campaignName);
            if (parts.length) {
                campaignElement.textContent = parts.join(' - ');
            }
        }

        const status = this.resolveText(
            contract.status,
            data && data.status
        );
        this.updateText('header-status', status);

        const description = this.resolveText(
            contract.description,
            data && data.campaign_description,
            data && data.description
        );
        const descriptionElement = document.getElementById('campaign-description');
        if (descriptionElement && this.hasValue(description)) {
            descriptionElement.textContent = description;
        }

        if (clientName || campaignName) {
            const titleParts = ['Dashboard'];
            if (clientName) titleParts.push(clientName);
            if (campaignName) titleParts.push(campaignName);
            document.title = titleParts.join(' - ');
        }
    }

    renderChannelsSection(data) {
        const contract = (data && data.contract) || {};
        const strategies = (data && data.strategies) || {};
        const primaryChannel = this.resolveText(
            contract.primary_channel,
            contract.channel,
            data && data.primary_channel,
            data && data.channel,
            strategies.primary_channel
        );

        this.updateText('primary-channel-badge', primaryChannel);

        const titleElement = document.getElementById('primary-channel-title');
        if (titleElement && this.hasValue(primaryChannel)) {
            titleElement.textContent = `Entrega di√°ria ‚Äî ${primaryChannel}`;
        }
    }

    renderPlanning(data) {
        const contract = (data && data.contract) || {};
        const metrics = (data && (data.metrics || data.total_metrics)) || {};
        const strategies = (data && data.strategies) || {};

        const period = this.buildPeriod(contract, data);
        this.updateText('planning-period', period);

        const status = this.resolveText(contract.status, data && data.status);
        this.updateText('planning-status', status);

        const totalBudget = this.resolveNumber(
            contract.total_budget,
            contract.investment,
            data && data.total_budget,
            data && data.budget_contracted,
            metrics.total_budget,
            metrics.budget_contracted
        );
        this.updateCurrency('planning-budget-total', totalBudget);

        const budgetUsed = this.resolveNumber(
            contract.budget_used,
            data && data.budget_used,
            metrics.total_spend,
            metrics.spend,
            metrics.budget_used
        );
        this.updateCurrency('planning-budget-used', budgetUsed);

        const pacing = this.resolveNumber(
            contract.pacing_percentage,
            contract.pacing,
            data && data.pacing_percentage,
            metrics.pacing,
            metrics.vc_pacing
        );
        this.updatePercentage('planning-pacing', pacing);

        const targetVc = this.resolveNumber(
            contract.target_vc,
            contract.complete_views_contracted,
            data && data.target_vc,
            metrics.vc_contracted,
            metrics.q100
        );
        this.updateNumber('planning-target-vc', targetVc);

        const cpvContracted = this.resolveNumber(
            contract.cpv_contracted,
            contract.cpv,
            data && data.cpv_contracted,
            metrics.cpv_contracted
        );
        this.updateCurrency('planning-cpv-contracted', cpvContracted);

        const cpvCurrent = this.resolveNumber(
            contract.cpv_current,
            data && data.cpv_current,
            metrics.cpv
        );
        this.updateCurrency('planning-cpv-current', cpvCurrent);

        const channelSources = [
            contract.channels,
            strategies.channels,
            data && data.channels,
            data && data.publishers ? data.publishers.map(publisher => (
                publisher && (publisher.name || publisher.channel || publisher.publisher)
            )) : null
        ];
        this.renderBadges('planning-channel-badges', ...channelSources);

        const formatSources = [
            contract.formats,
            contract.format_specifications,
            strategies.formats,
            data && data.formats
        ];
        this.renderList('planning-formats', ...formatSources);
    }

    renderInsights(data) {
        const contract = (data && data.contract) || {};
        const strategies = (data && data.strategies) || {};

        this.renderList(
            'insights-segmentation',
            strategies.segmentation,
            contract.segmentation,
            data && data.segmentation
        );

        this.renderList(
            'insights-creative',
            strategies.creative_strategy,
            contract.creative_strategy,
            data && data.creative_strategy
        );

        this.renderObjectives(
            'insights-objectives',
            strategies.objectives,
            contract.objectives,
            data && data.objectives
        );

        this.renderList(
            'insights-highlights',
            data && data.insights,
            strategies.highlights,
            contract.insights
        );
    }

    renderMetrics(data) {
        // Renderizar m√©tricas principais
        const metricsContainer = document.getElementById('metrics-overview-top');
        if (!metricsContainer) {
            return;
        }

        const summary = this.getCampaignSummary(data);
        if (summary) {
            metricsContainer.innerHTML = `
                <div class="metric">
                    <div class="label">üí∞ Investimento</div>
                    <div class="value">R$ ${this.formatCurrency(summary.investment || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">üéØ VC Contratadas</div>
                    <div class="value">${this.formatNumber(summary.complete_views_contracted || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">üìà Pacing</div>
                    <div class="value">${this.formatPercentage(summary.pacing || 0)}</div>
                </div>
                <div class="metric">
                    <div class="label">üí∏ CPV</div>
                    <div class="value">R$ ${this.formatCurrency(summary.cpv || 0)}</div>
                </div>
            `;
        } else {
            metricsContainer.innerHTML = '';
        }
    }

    renderCharts(data) {
        // Renderizar gr√°ficos b√°sicos
        const spendCtx = document.getElementById('chartSpendShare');
        const resultsCtx = document.getElementById('chartResults');

        const summary = this.getCampaignSummary(data);

        if (spendCtx && summary) {
            const totalSpend = summary.total_spend || 0;
            const remaining = Math.max((summary.investment || 0) - totalSpend, 0);
            new Chart(spendCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Utilizado', 'Restante'],
                    datasets: [{
                        data: [totalSpend, remaining],
                        backgroundColor: ['#8B5CF6', '#EC4899']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#9CA3AF' }
                        }
                    }
                }
            });
        }

        if (resultsCtx && summary) {
            new Chart(resultsCtx, {
                type: 'bar',
                data: {
                    labels: ['Impress√µes', 'Cliques', 'VC'],
                    datasets: [{
                        label: 'Performance',
                        data: [
                            summary.total_impressions || 0,
                            summary.total_clicks || 0,
                            summary.total_video_completions || 0
                        ],
                        backgroundColor: ['#8B5CF6', '#EC4899', '#10B981']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            labels: { color: '#9CA3AF' }
                        }
                    },
                    scales: {
                        y: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        },
                        x: {
                            ticks: { color: '#9CA3AF' },
                            grid: { color: 'rgba(148, 163, 184, 0.1)' }
                        }
                    }
                }
            });
        }
    }

    renderTables(data) {
        // Renderizar tabela de canais
        const tbodyChannels = document.getElementById('tbodyChannels');
        if (tbodyChannels && data.publishers) {
            tbodyChannels.innerHTML = data.publishers.map(publisher => `
                <tr>
                    <td>${publisher.name || publisher.publisher || 'N/A'}</td>
                    <td>R$ ${this.formatCurrency(publisher.budget_contracted || publisher.budget || 0)}</td>
                    <td>R$ ${this.formatCurrency(publisher.spend || 0)}</td>
                    <td>${this.formatPercentage(publisher.pacing || 0)}</td>
                    <td>${this.formatNumber(publisher.impressions || 0)}</td>
                    <td>${this.formatNumber(publisher.clicks || 0)}</td>
                    <td>${this.formatPercentage(publisher.ctr || 0)}</td>
                    <td>${this.formatNumber(publisher.vc_delivered || publisher.q100 || 0)}</td>
                    <td>${this.formatPercentage(publisher.vtr || 0)}</td>
                    <td>R$ ${this.formatCurrency(publisher.cpv || 0)}</td>
                    <td>R$ ${this.formatCurrency(publisher.cpm || 0)}</td>
                </tr>
            `).join('');
        }
    }

    renderBadges(elementId, ...sources) {
        const container = document.getElementById(elementId);
        if (!container) {
            return;
        }
        const labels = this.collectLabels(...sources);
        const hideWhenEmpty = container.dataset.hideWhenEmpty === 'true';
        const block = hideWhenEmpty ? container.parentElement : null;
        if (!labels.length) {
            if (hideWhenEmpty && block) {
                this.setVisibility(block, false);
            }
            return;
        }
        if (hideWhenEmpty && block) {
            this.setVisibility(block, true);
        }
        container.innerHTML = '';
        labels.forEach(label => {
            const badge = document.createElement('span');
            badge.className = 'badge';
            badge.style.margin = '4px';
            badge.style.display = 'inline-flex';
            badge.textContent = label;
            container.appendChild(badge);
        });
    }

    renderList(elementId, ...sources) {
        const listElement = document.getElementById(elementId);
        if (!listElement) {
            return;
        }
        const items = this.collectLabels(...sources);
        const hideWhenEmpty = listElement.dataset.hideWhenEmpty === 'true';
        const block = hideWhenEmpty ? listElement.parentElement : null;
        if (!items.length) {
            if (hideWhenEmpty && block) {
                this.setVisibility(block, false);
            }
            return;
        }
        if (hideWhenEmpty && block) {
            this.setVisibility(block, true);
        }
        listElement.innerHTML = '';
        items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            listElement.appendChild(li);
        });
    }

    renderObjectives(elementId, ...sources) {
        const container = document.getElementById(elementId);
        if (!container) {
            return;
        }
        const items = this.collectLabels(...sources);
        const hideWhenEmpty = container.dataset.hideWhenEmpty === 'true';
        const block = hideWhenEmpty ? container.parentElement : null;
        if (!items.length) {
            if (hideWhenEmpty && block) {
                this.setVisibility(block, false);
            }
            return;
        }
        if (hideWhenEmpty && block) {
            this.setVisibility(block, true);
        }
        const list = document.createElement('ul');
        list.style.marginLeft = '20px';
        list.style.lineHeight = '1.6';
        items.forEach(item => {
            const li = document.createElement('li');
            li.textContent = item;
            list.appendChild(li);
        });
        container.innerHTML = '';
        container.appendChild(list);
    }

    setVisibility(element, shouldShow) {
        if (!element) {
            return;
        }
        element.style.display = shouldShow ? '' : 'none';
    }

    updateText(elementId, value) {
        const element = document.getElementById(elementId);
        if (!element) {
            return;
        }
        if (!this.hasValue(value) && value !== 0) {
            return;
        }
        const text = typeof value === 'number' ? String(value) : value;
        element.textContent = text;
    }

    updateCurrency(elementId, value) {
        if (value === null || value === undefined || !Number.isFinite(value)) {
            return;
        }
        const element = document.getElementById(elementId);
        if (!element) {
            return;
        }
        element.textContent = this.formatCurrency(value);
    }

    updateNumber(elementId, value) {
        if (value === null || value === undefined || !Number.isFinite(value)) {
            return;
        }
        const element = document.getElementById(elementId);
        if (!element) {
            return;
        }
        element.textContent = this.formatNumber(value);
    }

    updatePercentage(elementId, value) {
        if (value === null || value === undefined || !Number.isFinite(value)) {
            return;
        }
        const element = document.getElementById(elementId);
        if (!element) {
            return;
        }
        element.textContent = this.formatPercentage(value);
    }

    resolveText(...values) {
        for (const value of values) {
            if (typeof value === 'string' && value.trim()) {
                return value.trim();
            }
            if (typeof value === 'number' && Number.isFinite(value)) {
                return String(value);
            }
        }
        return null;
    }

    resolveNumber(...values) {
        for (const value of values) {
            const numeric = this.parseNumber(value);
            if (numeric !== null && Number.isFinite(numeric)) {
                return numeric;
            }
        }
        return null;
    }

    hasValue(value) {
        if (value === null || value === undefined) {
            return false;
        }
        if (Array.isArray(value)) {
            return value.length > 0;
        }
        if (typeof value === 'object') {
            return Object.keys(value).length > 0;
        }
        if (typeof value === 'string') {
            return value.trim() !== '';
        }
        return true;
    }

    collectLabels(...sources) {
        const labels = [];
        sources.forEach(source => {
            if (source === null || source === undefined) {
                return;
            }
            if (Array.isArray(source)) {
                source.forEach(item => {
                    const label = this.extractLabel(item);
                    if ((this.hasValue(label) || label === 0 || label === '0') && label !== null) {
                        labels.push(String(label));
                    }
                });
                return;
            }
            if (typeof source === 'object') {
                const label = this.extractLabel(source);
                if (this.hasValue(label) || label === 0 || label === '0') {
                    labels.push(String(label));
                    return;
                }
                Object.entries(source).forEach(([key, value]) => {
                    if (!this.hasValue(value) && value !== 0) {
                        return;
                    }
                    if (typeof value === 'object') {
                        const nested = this.extractLabel(value);
                        if (this.hasValue(nested) || nested === 0 || nested === '0') {
                            labels.push(`${key}: ${nested}`);
                        } else if (this.hasValue(key)) {
                            labels.push(String(key));
                        }
                    } else {
                        labels.push(`${key}: ${value}`);
                    }
                });
                return;
            }
            const label = this.extractLabel(source);
            if (this.hasValue(label) || label === 0 || label === '0') {
                labels.push(String(label));
            }
        });
        return Array.from(new Set(labels.filter(item => typeof item === 'string' ? item.trim() !== '' : item !== null)));
    }

    extractLabel(item) {
        if (item === null || item === undefined) {
            return null;
        }
        if (Array.isArray(item)) {
            const nested = this.collectLabels(...item);
            return nested.length ? nested.join(' ‚Ä¢ ') : null;
        }
        if (typeof item === 'object') {
            const hasTitle = this.hasValue(item.title);
            const hasDescription = this.hasValue(item.description);
            if (hasTitle && hasDescription) {
                return `${String(item.title).trim()}: ${String(item.description).trim()}`;
            }
            const keys = ['label', 'name', 'title', 'channel', 'value', 'description', 'text'];
            for (const key of keys) {
                if (this.hasValue(item[key]) || item[key] === 0) {
                    return String(item[key]).trim();
                }
            }
            return null;
        }
        if (typeof item === 'number' && Number.isFinite(item)) {
            return item;
        }
        if (typeof item === 'string') {
            return item.trim();
        }
        return null;
    }

    buildPeriod(contract, data) {
        const period = this.resolveText(
            contract.period,
            data && data.period
        );
        if (period) {
            return period;
        }
        const start = this.resolveText(
            contract.period_start,
            contract.start_date,
            data && data.period_start,
            data && data.start_date
        );
        const end = this.resolveText(
            contract.period_end,
            contract.end_date,
            data && data.period_end,
            data && data.end_date
        );
        if (start || end) {
            return [start, end].filter(Boolean).join(' - ');
        }
        return null;
    }

    parseNumber(value) {
        if (value === null || value === undefined || value === '') {
            return null;
        }
        if (typeof value === 'number') {
            return Number.isFinite(value) ? value : null;
        }
        if (typeof value === 'string') {
            const normalized = value
                .replace(/[^0-9,.-]/g, '')
                .replace(/\.(?=\d{3}(?:\D|$))/g, '')
                .replace(',', '.');
            if (!normalized) {
                return null;
            }
            const parsed = Number(normalized);
            return Number.isFinite(parsed) ? parsed : null;
        }
        return null;
    }

    setupEventListeners() {
        // Configurar navega√ß√£o por tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabId = tab.dataset.tab;
                ['overview', 'channels', 'insights', 'planning'].forEach(key => {
                    const element = document.getElementById(`tab-${key}`);
                    if (element) {
                        element.classList.toggle('hidden', key !== tabId);
                    }
                });
            });
        });
    }

    getCampaignSummary(data) {
        if (!data) {
            return null;
        }

        if (data.campaign_summary) {
            return data.campaign_summary;
        }

        const contract = data.contract || {};
        const metrics = data.metrics || data.total_metrics || {};
        const hasData = (contract && Object.keys(contract).length > 0) || (metrics && Object.keys(metrics).length > 0);

        if (!hasData) {
            return null;
        }

        const investment = this.toNumber(
            contract.investment ??
            metrics.investment ??
            metrics.budget_contracted ??
            data.budget_contracted ??
            contract.budget ??
            0
        );

        const totalSpend = this.toNumber(
            metrics.total_spend ??
            metrics.spend ??
            metrics.budget_used ??
            contract.budget_used ??
            0
        );

        const totalImpressions = this.toNumber(
            metrics.total_impressions ??
            metrics.impressions ??
            metrics.impressoes ??
            0
        );

        const totalClicks = this.toNumber(
            metrics.total_clicks ??
            metrics.clicks ??
            metrics.cliques ??
            0
        );

        const totalVideoCompletions = this.toNumber(
            metrics.total_video_completions ??
            metrics.vc_delivered ??
            metrics.q100 ??
            metrics.video_completions ??
            0
        );

        return {
            investment,
            complete_views_contracted: this.toNumber(
                contract.complete_views_contracted ??
                metrics.vc_contracted ??
                data.vc_contracted ??
                0
            ),
            pacing: this.toNumber(metrics.pacing ?? metrics.vc_pacing ?? contract.pacing ?? 0),
            cpv: this.toNumber(
                metrics.cpv ??
                contract.cpv ??
                contract.cpv_contracted ??
                data.cpv ??
                0
            ),
            total_spend: totalSpend,
            total_impressions: totalImpressions,
            total_clicks: totalClicks,
            total_video_completions: totalVideoCompletions
        };
    }

    // Fun√ß√µes auxiliares de formata√ß√£o
    formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(value || 0);
    }

    formatNumber(value) {
        return new Intl.NumberFormat('pt-BR', {
            maximumFractionDigits: 0
        }).format(value || 0);
    }

    formatPercentage(value) {
        const numeric = Number.isFinite(value) ? value : this.parseNumber(value) || 0;
        return `${numeric.toLocaleString('pt-BR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        })}%`;
    }

    toNumber(value) {
        if (value === null || value === undefined || value === '') {
            return 0;
        }
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }
}

// Inicializar dashboard quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
    // Extrair campaign key da URL ou usar padr√£o
    let campaignKey = '{{CAMPAIGN_KEY}}';

    // Criar e carregar dashboard
    const dashboard = new DashboardLoader(campaignKey);
    window.dashboardLoader = dashboard;
    dashboard.loadDashboard();
});
</script>
</body>
</html>

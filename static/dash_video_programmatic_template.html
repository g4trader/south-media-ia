<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title id="pageTitle">Carregando Dashboard...</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{--bg:#0F1023;--bg2:#16213E;--panel:#1A1A2E;--muted:#9CA3AF;--stroke: rgba(139,92,246,.28);
         --grad: linear-gradient(135deg,#8B5CF6,#EC4899);}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%)}
  .container{max-width:1320px;margin:0 auto;padding:32px 32px 40px}
  .card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:14px;padding:20px;margin-bottom:24px;backdrop-filter:blur(8px)}
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:40px;height:40px;border-radius:10px;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .muted{color:var(--muted)}
  .tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin:20px 0}
  .tab{border:1px solid rgba(148,163,184,.2);background:rgba(255,255,255,.04);padding:10px;border-radius:10px;text-align:center;cursor:pointer;color:var(--muted);font-weight:600}
  .tab.active{background:var(--grad);color:#fff;box-shadow:0 8px 24px rgba(139,92,246,.35)}
  .hidden{display:none}
  .metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
  @media(max-width:900px){.metrics{grid-template-columns:repeat(2,1fr)} .tabs{grid-template-columns:repeat(2,1fr)} }
  .metric{border:1px solid rgba(148,163,184,.18);border-radius:12px;padding:14px;display:flex;flex-direction:column;gap:6px}
  .metric .label{text-transform:uppercase;letter-spacing:.06em;color:var(--muted);font-size:.82rem}
  .metric .value{font-size:1.7rem;font-weight:800;line-height:1.15}
  .kpis{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  @media(max-width:900px){.kpis{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse}
  thead th{color:var(--muted);text-transform:uppercase;letter-spacing:.06em;font-size:.8rem;text-align:left;border-bottom:1px solid rgba(148,163,184,.22);padding:1rem}
  tbody td{padding:1rem;border-bottom:1px solid rgba(148,163,184,.14)}
  .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 12px;border-radius:999px;background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.4);font-weight:600;color:#00ff88}
  .badge-success{background:rgba(34,197,94,.2);border:1px solid rgba(34,197,94,.4);color:#22c55e}
  .badge-warning{background:rgba(245,158,11,.2);border:1px solid rgba(245,158,11,.4);color:#f59e0b}
  .badge-secondary{background:rgba(107,114,128,.2);border:1px solid rgba(107,114,128,.4);color:#6b7280}

  /* Loading Screen Styles */
  .loading-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #0F0F23 0%, #16213E 50%, #1A1A2E 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-family: 'Inter', sans-serif;
  }

  .loading-spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(139, 92, 246, 0.2);
      border-top: 4px solid #8B5CF6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 2rem;
  }

  @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
  }

  .loading-text {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #E5E7EB;
  }

  .loading-subtext {
      font-size: 1rem;
      color: #9CA3AF;
      text-align: center;
      max-width: 400px;
      line-height: 1.5;
  }

  .loading-progress {
      width: 300px;
      height: 4px;
      background: rgba(139, 92, 246, 0.2);
      border-radius: 2px;
      margin-top: 2rem;
      overflow: hidden;
  }

  .loading-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #8B5CF6, #EC4899);
      border-radius: 2px;
      transition: width 0.3s ease;
      width: 0%;
  }

  .error-container {
      display: none;
      text-align: center;
      max-width: 500px;
  }

  .error-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
  }

  .retry-button {
      background: linear-gradient(135deg, #8B5CF6, #EC4899);
      color: white;
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1.5rem;
      transition: transform 0.2s ease;
  }

  .retry-button:hover {
      transform: translateY(-2px);
  }

  .dashboard-content {
      display: none;
  }

  /* Anima√ß√£o de fade in quando dados carregam */
  .dashboard-content.loaded {
      display: block;
      animation: fadeIn 0.5s ease-in-out;
  }

  @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
  }

  .data-source-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(26, 26, 46, 0.9);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      color: #9CA3AF;
      z-index: 1000;
  }

  .data-source-indicator.real {
      color: #10B981;
      border-color: rgba(16, 185, 129, 0.3);
  }
</style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Carregando Dashboard...</div>
        <div class="loading-subtext">
            Conectando com Google Sheets e processando dados...
        </div>
        <div class="loading-progress">
            <div id="progressBar" class="loading-progress-bar"></div>
        </div>
        
        <!-- Error State -->
        <div id="errorContainer" class="error-container">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="loading-text">Erro ao carregar dados</div>
            <div class="loading-subtext">
                N√£o foi poss√≠vel conectar com o Google Sheets. 
                Verifique sua conex√£o e tente novamente.
            </div>
            <button class="retry-button" onclick="retryLoadData()">
                üîÑ Tentar Novamente
            </button>
        </div>
    </div>

    <!-- Data Source Indicator -->
    <div id="dataSourceIndicator" class="data-source-indicator">
        üìä Carregando dados...
    </div>

    <!-- Dashboard Content (hidden initially) -->
    <div id="dashboardContent" class="dashboard-content">
        <div class="container">
            <h1 id="dashboardTitle" style="color: white; text-align: center; margin-bottom: 20px; font-size: 2rem;">Carregando...</h1>
            <div class="card header">
                <div class="logo">
                    <div class="logo-icon">SM</div>
                    <div>
                        <div style="font-weight:800;font-size:1.1rem">South Media</div>
                        <div class="muted" id="dashboardSubtitle">Carregando...</div>
                    </div>
                </div>
                <div>
                    <div style="font-weight:700;font-size:1rem;text-align:right" id="campaignName">Carregando...</div>
                    <div class="muted" style="text-align:right">Status: <span class="badge" id="campaignStatus">CARREGANDO</span></div>
                </div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="overview">üé¨ Vis√£o Geral</div>
                <div class="tab" data-tab="performance">üìä Performance</div>
                <div class="tab" data-tab="insights">üìà An√°lise & Insights</div>
                <div class="tab" data-tab="planning">üìã Planejamento</div>
            </div>

            <!-- OVERVIEW -->
            <div id="tab-overview">
                <div class="metrics" id="metrics-overview-top"></div>
                <div class="kpis" style="margin-top: 24px;">
                    <div class="card"><canvas id="chartSpendShare"></canvas></div>
                    <div class="card"><canvas id="chartResults"></canvas></div>
                </div>
                <div class="card" style="margin-top: 24px;">
                    <h3 style="margin-bottom:10px">Resumo da Campanha</h3>
                    <div class="muted" style="margin-bottom:10px">Program√°tica Video - Carregando...</div>
                    <div style="overflow:auto">
                        <table id="tableCampaign">
                            <thead>
                                <tr>
                                    <th>M√©trica</th><th>Contratado</th><th>Realizado</th><th>Pacing (%)</th>
                                    <th>CPV (R$)</th><th>VTR (%)</th><th>Impress√µes</th><th>Cliques</th>
                                </tr>
                            </thead>
                            <tbody id="tbodyCampaign"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- PERFORMANCE -->
            <div id="tab-performance" class="hidden">
                <div class="metrics" id="metrics-performance"></div>
                <div class="card" style="margin-top:16px">
                    <h3 style="margin-bottom:10px">Entrega di√°ria ‚Äî Program√°tica Video</h3>
                    <div style="overflow:auto">
                        <table id="dailyTable">
                            <thead>
                                <tr>
                                    <th>Data</th><th>Criativo</th><th>Investimento (R$)</th>
                                    <th>Starts</th><th>25%</th><th>50%</th><th>75%</th><th>100%</th>
                                    <th>Impress√µes</th><th>Cliques</th><th>CTR (%)</th>
                                </tr>
                            </thead>
                            <tbody id="dailyBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- INSIGHTS -->
            <div id="tab-insights" class="hidden">
                <div class="card" id="insightsCards">
                    <h3 style="margin-bottom:8px">Resumo de Insights</h3>
                    <ul id="insightsList" style="margin:0; padding-left:18px; line-height:1.6; color:rgba(148,163,184,0.9)">
                    </ul>
                </div>

                <div class="kpis">
                    <div class="card"><canvas id="insVideoEff"></canvas></div>
                    <div class="card"><canvas id="insPacing"></canvas></div>
                </div>
            </div>

            <!-- PLANEJAMENTO -->
            <div id="tab-planning" class="hidden">
                <!-- Objetivo da Campanha -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:10px">Objetivo da Campanha</h3>
                    <p style="margin:0; line-height:1.5; color:rgba(148,163,184,0.9)">
                        Campanha de <strong>Program√°tica Video</strong> com foco em <strong>Segmenta√ß√£o A</strong> e <strong>Segmenta√ß√£o B</strong>, maximizando alcance qualificado e efici√™ncia de convers√£o.
                    </p>
                </div>

                <!-- Segmenta√ß√µes -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:16px">üéØ Segmenta√ß√µes Utilizadas</h3>
                    
                    <div style="margin-bottom:20px">
                        <h4 style="color:#ff6b35; margin-bottom:10px">üîç DoubleVerify</h4>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:10px">
                            <strong>VIDEO Fraud & Invalid Traffic</strong><br>
                            <small style="color:rgba(255,255,255,0.7)">Fraud & IVT by Site/App > Safe from Fraudulent or No Ads Sites/Apps (100% Invalid Traffic)</small>
                        </div>
                    </div>

                    <div style="margin-bottom:20px">
                        <h4 style="color:#ff6b35; margin-bottom:10px">üéØ TailTarget - BRAZIL</h4>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:10px">
                            <strong>Segmenta√ß√£o A</strong><br>
                            <small style="color:rgba(255,255,255,0.7)">Segmenta√ß√£o prim√°ria</small>
                        </div>
                    </div>

                    <div style="margin-bottom:20px">
                        <h4 style="color:#ff6b35; margin-bottom:10px">üåç TailTarget - GLOBAL</h4>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:10px">
                            <strong>Segmenta√ß√£o B</strong><br>
                            <small style="color:rgba(255,255,255,0.7)">Segmenta√ß√£o secund√°ria</small>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; margin-bottom:10px">
                            <strong>Segmenta√ß√£o C</strong><br>
                            <small style="color:rgba(255,255,255,0.7)">Segmenta√ß√£o adicional</small>
                        </div>
                    </div>
                </div>

                <!-- Lista de Publishers -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:16px">‚≠ê Publishers Utilizados</h3>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:12px">
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                            <strong>YouTube</strong>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">Plataforma principal de v√≠deo</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                            <strong>Google Display Network</strong>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">Rede de display do Google</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                            <strong>Facebook/Meta</strong>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">Rede social e v√≠deo</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                            <strong>Instagram</strong>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">Stories e Reels</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                            <strong>TikTok</strong>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">V√≠deos curtos</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                            <strong>LinkedIn</strong>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">Rede profissional</div>
                        </div>
                    </div>
                </div>

                <!-- Detalhes da Campanha -->
                <div class="card" style="margin-bottom:16px">
                    <h3 style="margin-bottom:16px">üìã Detalhes da Campanha</h3>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px">
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                            <div style="font-size:1.5rem; font-weight:bold; color:#22c55e" id="budgetContracted">R$ 31.000,00</div>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">Valor Contratado</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                            <div style="font-size:1.5rem; font-weight:bold; color:#22c55e" id="cpvValue">R$ 0,16</div>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">CPV</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                            <div style="font-size:1.5rem; font-weight:bold; color:#22c55e" id="impressionsContracted">193.750</div>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">Impress√µes Contratadas</div>
                        </div>
                        <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                            <div style="font-size:1.5rem; font-weight:bold; color:#22c55e">15/09 - 30/10</div>
                            <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">Per√≠odo</div>
                        </div>
                    </div>
                </div>

                <!-- Pr√≥ximas A√ß√µes -->
                <div class="card">
                    <h3 style="margin-bottom:10px">Pr√≥ximas A√ß√µes</h3>
                    <ul style="margin:0; padding-left:18px; line-height:1.6; color:rgba(148,163,184,0.9)">
                        <li>Monitorar pacing di√°rio para garantir entrega dentro do prazo</li>
                        <li>Otimizar segmenta√ß√µes baseado na performance atual</li>
                        <li>Testar novos criativos para melhorar VTR</li>
                        <li>Analisar performance por publisher para realoca√ß√£o de budget</li>
                        <li>Implementar ajustes de frequ√™ncia para evitar satura√ß√£o</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

<script>
// Sistema de Loading com Dados Reais
class DashboardLoader {
    constructor(campaignKey) {
        this.campaignKey = campaignKey;
        // Tentar dom√≠nio personalizado primeiro, com fallback para Cloud Run
        this.apiEndpoint = `https://south-media-ia-609095880025.us-central1.run.app/api/${campaignKey}/data`;
        this.customDomainEndpoint = `https://api.iasouth.tech/api/${campaignKey}/data`;
        this.loadingSteps = [
            { text: "Inicializando...", progress: 10 },
            { text: "Conectando com Google Sheets...", progress: 30 },
            { text: "Extraindo dados da planilha...", progress: 50 },
            { text: "Processando m√©tricas...", progress: 70 },
            { text: "Calculando gr√°ficos...", progress: 90 },
            { text: "Finalizando...", progress: 100 }
        ];
        this.currentStep = 0;
    }

    async loadDashboardData() {
        try {
            // Mostrar loading screen
            this.showLoading();
            
            // Simular progresso
            this.simulateProgress();
            
            // Carregar dados reais
            const response = await fetch(this.apiEndpoint, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.message || 'Erro ao carregar dados');
            }
            
            // Aguardar progresso completar
            await this.waitForProgressComplete();
            
            // Armazenar dados para acesso posterior
            this.data = data.data;
            
        // Atualizar t√≠tulo do dashboard
        this.updateDashboardTitle(data.data);
        
        // Renderizar dashboard com dados reais
        this.renderDashboard(data.data);
        
        // Esconder loading e mostrar dashboard
        this.hideLoading();
        this.showDashboardWithSource(data.source);
            
        } catch (error) {
            console.error('Erro ao carregar dados:', error);
            this.showError(error.message);
        }
    }

    showLoading() {
        document.getElementById('loadingScreen').style.display = 'flex';
        document.getElementById('dashboardContent').style.display = 'none';
        document.getElementById('errorContainer').style.display = 'none';
        document.getElementById('dataSourceIndicator').textContent = 'üìä Carregando dados...';
    }

    hideLoading() {
        document.getElementById('loadingScreen').style.display = 'none';
    }

    showDashboard() {
        const content = document.getElementById('dashboardContent');
        content.style.display = 'block';
        content.classList.add('loaded');
        document.getElementById('dataSourceIndicator').textContent = '‚úÖ Dados reais (Google Sheets)';
        document.getElementById('dataSourceIndicator').classList.add('real');
    }

    updateDashboardTitle(data) {
        // Atualizar t√≠tulo principal
        const titleElement = document.getElementById('dashboardTitle');
        if (titleElement && data.dashboard_title) {
            titleElement.textContent = data.dashboard_title;
        }
        
        // Atualizar subt√≠tulo do cabe√ßalho (canal)
        const subtitleElement = document.getElementById('dashboardSubtitle');
        if (subtitleElement && data.channel) {
            subtitleElement.textContent = `Dashboard ${data.channel}`;
        }
        
        // Atualizar nome da campanha no cabe√ßalho
        const campaignElement = document.getElementById('campaignName');
        if (campaignElement && data.contract) {
            const client = data.contract.client || 'Cliente';
            const campaign = data.contract.campaign || 'Campanha';
            campaignElement.textContent = `${client} ${campaign.toUpperCase()}`;
        }
        
        // Atualizar status da campanha
        this.updateCampaignStatus(data);
    }

    updateCampaignStatus(data) {
        const statusElement = document.getElementById('campaignStatus');
        if (statusElement && data.contract) {
            const startDate = data.contract.period_start;
            const endDate = data.contract.period_end;
            
            if (startDate && endDate) {
                // Parse das datas (formato DD/MM/YYYY)
                const [startDay, startMonth, startYear] = startDate.split('/');
                const [endDay, endMonth, endYear] = endDate.split('/');
                
                const start = new Date(startYear, startMonth - 1, startDay);
                const end = new Date(endYear, endMonth - 1, endDay);
                const now = new Date();
                
                let status, statusClass;
                if (now < start) {
                    status = 'AGUARDANDO';
                    statusClass = 'badge-warning';
                } else if (now > end) {
                    status = 'FINALIZADA';
                    statusClass = 'badge-secondary';
                } else {
                    status = 'EM ANDAMENTO';
                    statusClass = 'badge-success';
                }
                
                statusElement.textContent = status;
                statusElement.className = `badge ${statusClass}`;
            } else {
                statusElement.textContent = 'EM ANDAMENTO';
                statusElement.className = 'badge badge-success';
            }
        }
    }

    showDashboardWithSource(source) {
        const content = document.getElementById('dashboardContent');
        content.style.display = 'block';
        content.classList.add('loaded');
        
        if (source === 'google_sheets') {
            document.getElementById('dataSourceIndicator').textContent = '‚úÖ Dados reais (Google Sheets)';
            document.getElementById('dataSourceIndicator').classList.add('real');
        } else {
            document.getElementById('dataSourceIndicator').textContent = 'üß™ Dados de teste (baseados na planilha real)';
            document.getElementById('dataSourceIndicator').classList.remove('real');
        }
    }

    showError(message) {
        document.getElementById('errorContainer').style.display = 'block';
        document.querySelector('.loading-text').textContent = 'Erro ao carregar dados';
        document.querySelector('.loading-subtext').textContent = message;
        document.querySelector('.loading-spinner').style.display = 'none';
        document.querySelector('.loading-progress').style.display = 'none';
        document.getElementById('dataSourceIndicator').textContent = '‚ùå Erro ao carregar dados';
    }

    simulateProgress() {
        this.currentStep = 0;
        this.updateProgress();
        
        const interval = setInterval(() => {
            this.currentStep++;
            if (this.currentStep < this.loadingSteps.length) {
                this.updateProgress();
            } else {
                clearInterval(interval);
            }
        }, 800); // 800ms por step
    }

    updateProgress() {
        if (this.currentStep < this.loadingSteps.length) {
            const step = this.loadingSteps[this.currentStep];
            document.querySelector('.loading-subtext').textContent = step.text;
            document.getElementById('progressBar').style.width = step.progress + '%';
        }
    }

    async waitForProgressComplete() {
        return new Promise(resolve => {
            const checkProgress = () => {
                if (this.currentStep >= this.loadingSteps.length - 1) {
                    resolve();
                } else {
                    setTimeout(checkProgress, 100);
                }
            };
            checkProgress();
        });
    }

    renderDashboard(data) {
        // Renderizar m√©tricas principais
        this.renderMetrics(data.metrics, data);
        
        // Renderizar dados di√°rios
        this.renderDailyData(data.daily_data, data);
        
        // Renderizar dados por criativo
        this.renderPerData(data.per_data);
        
        // Renderizar gr√°ficos
        this.renderCharts(data);
        
        // Renderizar insights
        this.renderInsights(data);
        
        // Renderizar dados de planejamento
        this.renderPlanningData(data);
        
        // Atualizar status da campanha
        document.getElementById('campaignStatus').textContent = 'EM ANDAMENTO';
    }

    renderMetrics(metrics, data = null) {
        // VC contratado vem diretamente da planilha
        const vcContracted = data.contract?.complete_views_contracted || 0;
        const vcDelivered = metrics.q100 || 0;
        const vcPacing = vcContracted > 0 ? (vcDelivered / vcContracted) * 100 : 0;

        // Atualizar m√©tricas overview - or√ßamento + VC
        const topMetrics = [
            ["üí∞ Or√ßamento Contratado", `R$ ${this.formatBR(metrics.budget_contracted || 0)}`],
            ["üí∏ Or√ßamento Utilizado", `R$ ${this.formatBR(metrics.spend || 0)}`],
            ["üé¨ VC Contratado", this.formatInt(vcContracted)],
            ["‚úÖ VC Entregue", this.formatInt(vcDelivered)]
        ];
        
        document.getElementById('metrics-overview-top').innerHTML = topMetrics.map(
            m => `<div class='metric'><div class='label'>${m[0]}</div><div class='value'>${m[1]}</div></div>`).join('');
        
        // Atualizar m√©tricas performance - incluindo pacing de VC
        const performanceMetrics = [
            ['üìä Pacing Or√ßamento', `${(metrics.pacing || 0).toFixed(1)}%`],
            ['üìä Pacing VC', `${vcPacing.toFixed(1)}%`],
            ['üí∞ CPV', `R$ ${this.formatBR(metrics.cpv || 0)}`],
            ['üìà VTR', `${(metrics.vtr || 0).toFixed(1)}%`],
            ['üñ®Ô∏è Impress√µes', this.formatInt(metrics.impressions || 0)],
            ['üëÜ Cliques', this.formatInt(metrics.clicks || 0)],
            ['üìà CTR', `${(metrics.ctr || 0).toFixed(2)}%`],
            ['üí∞ CPM', `R$ ${this.formatBR(metrics.cpm || 0)}`]
        ];
        
        document.getElementById('metrics-performance').innerHTML = performanceMetrics.map(
            m => `<div class='metric'><div class='label'>${m[0]}</div><div class='value'>${m[1]}</div></div>`).join('');
        
        // Atualizar detalhes da campanha com dados de contrata√ß√£o
        const contract = data ? data.contract || {} : {};
        document.getElementById('budgetContracted').textContent = `R$ ${this.formatBR(contract.investment || metrics.budget_contracted || 0)}`;
        document.getElementById('cpvValue').textContent = `R$ ${this.formatBR(contract.cpv_contracted || metrics.cpv || 0)}`;
        document.getElementById('impressionsContracted').textContent = this.formatInt(contract.complete_views_contracted || metrics.impressions_contracted || 0);
    }

    renderDailyData(dailyData, data = null) {
        // Atualizar tabela overview
        const tbody = document.getElementById('tbodyCampaign');
        tbody.innerHTML = '';
        
        if (dailyData && dailyData.length > 0) {
            const metrics = this.calculateTotals(dailyData);
            const vcContracted = data?.contract?.complete_views_contracted || 0;
            const vcPacing = vcContracted > 0 ? (metrics.q100 / vcContracted) * 100 : 0;
            
            tbody.insertAdjacentHTML('beforeend', `
                <tr>
                    <td>Program√°tica Video</td>
                    <td>R$ ${this.formatBR(metrics.budget_contracted || 31000)}</td>
                    <td>R$ ${this.formatBR(metrics.spend || 0)}</td>
                    <td>${(metrics.pacing || 0).toFixed(1)}%</td>
                    <td>R$ ${this.formatBR(metrics.cpv || 0)}</td>
                    <td>${(metrics.vtr || 0).toFixed(1)}%</td>
                    <td>${this.formatInt(metrics.impressions || 0)}</td>
                    <td>${this.formatInt(metrics.clicks || 0)}</td>
                </tr>
                <tr style="background: rgba(139, 92, 246, 0.1); font-weight: 600;">
                    <td><strong>VC Contratado vs Entregue</strong></td>
                    <td colspan="2"><strong>VC Contratado: ${this.formatInt(vcContracted)}</strong></td>
                    <td><strong>VC Entregue: ${this.formatInt(metrics.q100 || 0)}</strong></td>
                    <td><strong>Pacing VC: ${vcPacing.toFixed(1)}%</strong></td>
                    <td colspan="3"><strong>Diferen√ßa: ${this.formatInt(vcContracted - (metrics.q100 || 0))}</strong></td>
                </tr>`);
        }
        
        // Atualizar tabela di√°ria
        const dailyBody = document.getElementById('dailyBody');
        dailyBody.innerHTML = '';
        
        if (dailyData) {
            dailyData.forEach(row => {
                dailyBody.insertAdjacentHTML('beforeend', `
                    <tr>
                        <td>${row.date || '‚Äî'}</td>
                        <td>${row.creative || '‚Äî'}</td>
                        <td>R$ ${this.formatBR(row.spend)}</td>
                        <td>${this.formatInt(row.starts)}</td>
                        <td>${this.formatInt(row.q25)}</td>
                        <td>${this.formatInt(row.q50)}</td>
                        <td>${this.formatInt(row.q75)}</td>
                        <td>${this.formatInt(row.q100)}</td>
                        <td>${this.formatInt(row.impressions)}</td>
                        <td>${this.formatInt(row.clicks)}</td>
                        <td>${(row.ctr || 0).toFixed(2)}%</td>
                    </tr>`);
            });
        }
    }

    renderPerData(perData) {
        // Implementar renderiza√ß√£o por criativo se necess√°rio
        console.log('Dados PER carregados:', perData);
    }

    renderCharts(data) {
        const metrics = data.metrics;
        
        // VC contratado vem diretamente da planilha
        const vcContracted = data.contract?.complete_views_contracted || 0;
        const vcDelivered = metrics.q100 || 0;
        
        // Gr√°fico de distribui√ß√£o de or√ßamento
        const ctx1 = document.getElementById('chartSpendShare');
        if (ctx1) {
            new Chart(ctx1, {
                type: 'doughnut',
                data: {
                    labels: ['Utilizado', 'Restante'],
                    datasets: [{
                        data: [metrics.spend || 0, (metrics.budget_contracted || 31000) - (metrics.spend || 0)],
                        backgroundColor: ['#8B5CF6', '#EC4899']
                    }]
                },
                options: { 
                    plugins: { 
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: 'Distribui√ß√£o do Or√ßamento'
                        }
                    } 
                }
            });
        }

        // Gr√°fico de VC Contratado vs Entregue
        const ctx2 = document.getElementById('chartResults');
        if (ctx2) {
            new Chart(ctx2, {
                type: 'bar',
                data: {
                    labels: ['VC Contratado', 'VC Entregue'],
                    datasets: [{
                        label: 'Video Completions',
                        data: [vcContracted, vcDelivered],
                        backgroundColor: ['#EC4899', '#8B5CF6']
                    }]
                },
                options: { 
                    responsive: true, 
                    plugins: { 
                        legend: { position: 'bottom' },
                        title: {
                            display: true,
                            text: 'Video Completions - Contratado vs Entregue'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de VC'
                            }
                        }
                    }
                }
            });
        }

        // Gr√°fico de efici√™ncia de v√≠deo
        const ctx3 = document.getElementById('insVideoEff');
        if (ctx3) {
            new Chart(ctx3, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Program√°tica Video',
                        data: [{ x: metrics.cpv || 0, y: metrics.vtr || 0 }],
                        pointRadius: 8,
                        backgroundColor: '#8B5CF6'
                    }]
                },
                options: {
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { title: { display: true, text: 'CPV (R$) ‚Äî menor √© melhor' } },
                        y: { title: { display: true, text: 'VTR100 (%) ‚Äî maior √© melhor' }, suggestedMax: 100 }
                    }
                }
            });
        }

        // Gr√°fico de pacing
        const ctx4 = document.getElementById('insPacing');
        if (ctx4) {
            new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: ['Pacing'],
                    datasets: [
                        { label: 'Contratado', data: [metrics.budget_contracted || 31000], backgroundColor: '#8B5CF6' },
                        { label: 'Utilizado', data: [metrics.spend || 0], backgroundColor: '#EC4899' }
                    ]
                },
                options: { plugins: { legend: { position: 'bottom' } }, scales: { x: { stacked: true }, y: { stacked: true } } }
            });
        }
    }

    renderInsights(data) {
        const metrics = data.metrics;
        const insightsList = document.getElementById('insightsList');
        
        // VC contratado vem diretamente da planilha
        const vcContracted = data.contract?.complete_views_contracted || 0;
        const vcDelivered = metrics.q100 || 0;
        const vcPacing = vcContracted > 0 ? (vcDelivered / vcContracted) * 100 : 0;
        const vcRemaining = vcContracted - vcDelivered;
        
        const items = [];
        items.push(`üé¨ <b>Video Completions:</b> Entregues <b>${this.formatInt(vcDelivered)}</b> de <b>${this.formatInt(vcContracted)}</b> contratados (${vcPacing.toFixed(1)}% do objetivo).`);
        items.push(`üí∞ <b>CPV m√©dio:</b> R$ <b>${this.formatBR(metrics.cpv || 0)}</b> - ${(metrics.cpv || 0) <= 0.20 ? 'dentro da meta estabelecida' : 'acima da meta'}.`);
        items.push(`‚úÖ <b>VTR:</b> <b>${(metrics.vtr || 0).toFixed(1)}%</b> - ${(metrics.vtr || 0) >= 20 ? 'boa performance para program√°tica video' : 'performance abaixo do esperado'}.`);
        items.push(`‚è±Ô∏è <b>Pacing or√ßament√°rio:</b> <b>${(metrics.pacing || 0).toFixed(1)}%</b> do or√ßamento j√° foi utilizado.`);
        items.push(`üéØ <b>Status da entrega:</b> ${vcPacing >= 100 ? 'Meta de VC atingida!' : `Faltam ${this.formatInt(vcRemaining)} VC para completar a meta.`}`);
        items.push(`üìä <b>Segmenta√ß√£o:</b> <b>${(data.strategies?.segmentation || ['Segmenta√ß√£o A', 'Segmenta√ß√£o B']).join('</b> e <b>')}</b> em ascens√£o.`);
        
        insightsList.innerHTML = items.map(t => `<li>${t}</li>`).join("");
    }

    renderPlanningData(data) {
        // Atualizar objetivo da campanha com estrat√©gias
        const strategies = data.strategies || {};
        const objectives = strategies.objectives || ["Maximizar alcance qualificado e efici√™ncia de convers√£o"];
        
        const objectiveText = document.querySelector('#tab-planning .card p');
        if (objectiveText) {
            objectiveText.innerHTML = `
                Campanha <strong>${data.contract?.campaign || 'Campanha'}</strong> de <strong>${data.channel || 'Progr√°matica'}</strong> para <strong>${data.contract?.client || 'Cliente'}</strong> com foco em 
                <strong>${(strategies.segmentation || ['Segmenta√ß√£o A', 'Segmenta√ß√£o B']).join('</strong> e <strong>')}</strong>, 
                ${objectives.join(', ')}.
            `;
        }
        
        // Atualizar lista de publishers
        const publishers = data.publishers || [];
        const publishersContainer = document.querySelector('#tab-planning .card:nth-child(3) div[style*="grid-template-columns"]');
        if (publishersContainer && publishers.length > 0) {
            publishersContainer.innerHTML = publishers.map(publisher => `
                <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; border-left:4px solid #ff6b35">
                    <strong>${publisher.name}</strong>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7); margin-top:4px">${publisher.type}</div>
                </div>
            `).join('');
        }
        
        // Atualizar detalhes da campanha com dados de contrata√ß√£o
        const contract = data.contract || {};
        const contractDetails = document.querySelector('#tab-planning .card:nth-child(4) div[style*="grid-template-columns"]');
        if (contractDetails) {
            contractDetails.innerHTML = `
                <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                    <div style="font-size:1.5rem; font-weight:bold; color:#22c55e">R$ ${this.formatBR(contract.investment || 31000)}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">Valor Contratado</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                    <div style="font-size:1.5rem; font-weight:bold; color:#22c55e">R$ ${this.formatBR(contract.cpv_contracted || 0.16)}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">CPV</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                    <div style="font-size:1.5rem; font-weight:bold; color:#22c55e">${this.formatInt(contract.complete_views_contracted || 193750)}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">VC Contratados</div>
                </div>
                <div style="background:rgba(255,255,255,0.05); padding:12px; border-radius:8px; text-align:center">
                    <div style="font-size:1.5rem; font-weight:bold; color:#22c55e">${contract.period_start || '15/09'} - ${contract.period_end || '30/10'}</div>
                    <div style="font-size:0.8rem; color:rgba(255,255,255,0.7)">Per√≠odo</div>
                </div>
            `;
        }
    }

    calculateTotals(dailyData) {
        const totals = {
            spend: 0,
            impressions: 0,
            clicks: 0,
            starts: 0,
            q25: 0,
            q50: 0,
            q75: 0,
            q100: 0,
            budget_contracted: 31000
        };

        dailyData.forEach(row => {
            totals.spend += row.spend || 0;
            totals.impressions += row.impressions || 0;
            totals.clicks += row.clicks || 0;
            totals.starts += row.starts || 0;
            totals.q25 += row.q25 || 0;
            totals.q50 += row.q50 || 0;
            totals.q75 += row.q75 || 0;
            totals.q100 += row.q100 || 0;
        });

        // Calcular m√©tricas derivadas
        totals.ctr = totals.impressions > 0 ? (totals.clicks / totals.impressions) * 100 : 0;
        totals.vtr = totals.starts > 0 ? (totals.q100 / totals.starts) * 100 : 0;
        totals.cpv = totals.q100 > 0 ? totals.spend / totals.q100 : 0;
        totals.cpm = totals.impressions > 0 ? (totals.spend / (totals.impressions / 1000)) : 0;
        totals.pacing = totals.budget_contracted > 0 ? (totals.spend / totals.budget_contracted) * 100 : 0;

        return totals;
    }

    formatBR(value, decimals = 2) {
        if (isNaN(value) || value === null || value === "") return "‚Äî";
        return new Intl.NumberFormat('pt-BR', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(Number(value));
    }

    formatInt(value) {
        if (isNaN(value) || value === null || value === "") return "‚Äî";
        return new Intl.NumberFormat('pt-BR', { maximumFractionDigits: 0 }).format(Number(value));
    }
}

// Fun√ß√£o para retry
async function retryLoadData() {
    const loader = new DashboardLoader();
    await loader.loadDashboardData();
}

// Tabs functionality
document.addEventListener('DOMContentLoaded', function() {
    // Tentar obter campaignKey da URL ou usar padr√£o
    const urlParams = new URLSearchParams(window.location.search);
        let campaignKey = urlParams.get('campaign') || 'default_campaign';
    
    // Se n√£o h√° par√¢metro na URL, tentar obter do nome do arquivo
    if (!urlParams.has('campaign')) {
        const pathParts = window.location.pathname.split('/');
        const filename = pathParts[pathParts.length - 1];
        if (filename.includes('sebrae')) {
            campaignKey = 'sebrae_pr';
        } else if (filename.includes('copacol')) {
            campaignKey = 'copacol_institucional_30s';
        } else if (filename.includes('exemplo')) {
            campaignKey = 'exemplo_cliente';
        }
    }
    
    console.log('Campaign Key:', campaignKey);
    
    // Inicializar carregamento quando a p√°gina carrega
    window.dashboardLoader = new DashboardLoader(campaignKey);
    window.dashboardLoader.loadDashboardData();

    // Configurar tabs
    document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
        t.classList.add('active');
        const id = t.dataset.tab;
        ['overview', 'performance', 'insights', 'planning'].forEach(key => {
            document.getElementById('tab-' + key).classList.toggle('hidden', key !== id);
        });
    }));
});
</script>
</body>
</html>

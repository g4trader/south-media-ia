<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Builder - Criar Novos Dashboards</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f0f23;
    --bg2:#1a1a2e;
    --panel:#16213e;
    --stroke:rgba(148,163,184,.25);
    --muted:rgba(148,163,184,.8);
    --grad:linear-gradient(135deg,#ff6b35,#8b5cf6);
    --accent:#00ff88;
    --danger:#ff4757;
    --warning:#ffa726;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%);
       min-height:100vh;}
  .container{max-width:1400px;margin:0 auto;padding:32px 32px 40px}
  
  /* Header com logout */
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px;margin-bottom:40px}
  .header-left{display:flex;align-items:center;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:48px;height:48px;border-radius:12px;background:var(--grad);display:grid;place-items:center;font-weight:700;font-size:1.2rem}
  .header-content h1{font-size:2.5rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .header-content p{color:var(--muted);font-size:1.1rem;margin-top:8px}
  
  /* User info e logout */
  .user-info{display:flex;align-items:center;gap:16px}
  .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .user-details{text-align:right}
  .user-name{font-weight:600;color:#fff}
  .user-role{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
  .logout-button{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(255,71,87,.2);border:1px solid rgba(255,71,87,.4);border-radius:8px;color:var(--danger);text-decoration:none;font-size:.9rem;font-weight:600;transition:all .3s ease}
  .logout-button:hover{background:rgba(255,71,87,.3);transform:translateY(-1px)}
  
  /* Indicador de área protegida */
  .protected-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,107,53,.2);border:1px solid rgba(255,107,53,.4);border-radius:20px;font-size:.8rem;font-weight:600;color:#ff6b35;margin-bottom:16px}
  
  /* Botão criar dashboard */
  .create-dashboard-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:linear-gradient(135deg,rgba(0,255,136,.2),rgba(0,255,136,.4));border:1px solid rgba(0,255,136,.5);border-radius:10px;color:var(--accent);text-decoration:none;font-weight:600;transition:all .3s ease;cursor:pointer}
  .create-dashboard-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,255,136,.3);background:linear-gradient(135deg,rgba(0,255,136,.3),rgba(0,255,136,.5))}
  
  /* Modal Styles */
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
  .modal.active{display:flex}
  .modal-content{background:var(--panel);border:1px solid var(--stroke);border-radius:20px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto;position:relative}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:24px 32px;border-bottom:1px solid var(--stroke)}
  .modal-title{font-size:1.5rem;font-weight:700;color:#fff}
  .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;padding:8px;border-radius:8px;transition:all .3s ease}
  .modal-close:hover{background:rgba(255,255,255,.1);color:#fff}
  .modal-body{padding:32px}
  .form-group{margin-bottom:24px}
  .form-label{display:block;margin-bottom:8px;font-weight:600;color:#fff;font-size:.9rem}
  .form-input,.form-select,.form-textarea{width:100%;padding:12px 16px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:.9rem;transition:all .3s ease}
  .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,255,136,.1)}
  .form-textarea{min-height:100px;resize:vertical}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
  .channels-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--stroke)}
  .channels-title{font-size:1.2rem;font-weight:700;color:#fff;margin-bottom:20px}
  .channel-item{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(26,26,46,.5);border:1px solid var(--stroke);border-radius:12px;margin-bottom:12px}
  .channel-checkbox{width:20px;height:20px;accent-color:var(--accent)}
  .channel-label{flex:1;color:#fff;font-weight:500}
  .channel-config{flex:2;display:flex;gap:8px;align-items:center}
  .channel-sheet-input{flex:1;padding:8px 12px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:8px;color:#fff;font-size:.85rem}
  .channel-sheet-input:focus{outline:none;border-color:var(--accent)}
  .channel-budget-input{flex:0.7;padding:8px 12px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:8px;color:#fff;font-size:.85rem}
  .channel-budget-input:focus{outline:none;border-color:var(--accent)}
  .channel-quantity-input{flex:0.7;padding:8px 12px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:8px;color:#fff;font-size:.85rem}
  .channel-quantity-input:focus{outline:none;border-color:var(--accent)}
  .budget-summary{margin-bottom:24px;padding:20px;background:rgba(26,26,46,.3);border:1px solid var(--stroke);border-radius:12px}
  .budget-summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .budget-summary-header h4{color:#fff;font-size:1.1rem;margin:0}
  .budget-totals{display:flex;gap:20px;font-size:.9rem}
  .budget-totals span{color:var(--muted)}
  .budget-totals strong{color:var(--accent)}
  .budget-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .budget-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(26,26,46,.5);border-radius:8px;font-size:.85rem}
  .budget-item-info{display:flex;flex-direction:column;gap:2px}
  .budget-item-name{color:#fff;font-weight:500}
  .budget-item-details{color:var(--muted);font-size:.75rem}
  .budget-item-value{color:var(--accent);font-weight:600}
  .modal-footer{display:flex;gap:12px;justify-content:flex-end;padding:24px 32px;border-top:1px solid var(--stroke)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none}
  .btn-primary{background:var(--grad);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,.4)}
  .btn-secondary{background:rgba(148,163,184,.2);border:1px solid rgba(148,163,184,.4);color:var(--muted)}
  .btn-secondary:hover{background:rgba(148,163,184,.3);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
  .preview-section{margin-top:24px;padding:20px;background:rgba(26,26,46,.3);border:1px solid var(--stroke);border-radius:12px}
  .preview-title{font-size:1rem;font-weight:600;color:#fff;margin-bottom:12px}
  .preview-content{color:var(--muted);font-size:.9rem;line-height:1.5}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  
  @media (max-width:768px){
    .container{padding:20px 16px}
    .header-content h1{font-size:2rem}
    .form-row,.form-row-3{grid-template-columns:1fr}
    .channel-config{flex-direction:column;align-items:stretch}
    .modal-footer{flex-direction:column}
    .modal-content{width:95%;margin:20px}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">🎯</div>
      </div>
      <div class="header-content">
        <div class="protected-badge">
          <span>🔒</span>
          <span>Dashboard Builder</span>
        </div>
        <h1>Criar Novos Dashboards</h1>
        <p>Sistema de criação automática de dashboards de campanhas</p>
      </div>
    </div>
    
    <div class="user-info">
      <div class="user-details">
        <div class="user-name" id="userName">Usuário</div>
        <div class="user-role" id="userRole">admin</div>
        <div class="user-company" id="userCompany">Empresa</div>
      </div>
      <div class="user-avatar" id="userAvatar">👤</div>
      <a href="#" class="logout-button" onclick="logout()">
        <span>🚪</span>
        <span>Sair</span>
      </a>
    </div>
  </div>

  <div style="text-align: center; margin-bottom: 40px;">
    <button onclick="openCreateDashboardModal()" class="create-dashboard-btn">
      <span>➕</span>
      <span>Criar Novo Dashboard</span>
    </button>
  </div>

  <div id="dashboardsList" style="display: none;">
    <!-- Lista de dashboards criados será carregada aqui -->
  </div>
</div>

<!-- Modal de Criação de Dashboard -->
<div id="createDashboardModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">➕ Criar Novo Dashboard</h2>
      <button class="modal-close" onclick="closeCreateDashboardModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="createDashboardForm">
        <!-- Informações Básicas -->
        <div class="form-group">
          <label class="form-label" for="campaignName">Nome da Campanha *</label>
          <input type="text" id="campaignName" class="form-input" placeholder="Ex: Campanha Black Friday 2025" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="startDate">Data de Início *</label>
            <input type="date" id="startDate" class="form-input" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="endDate">Data de Fim *</label>
            <input type="date" id="endDate" class="form-input" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="totalBudget">Verba Total Líquida (R$) *</label>
            <input type="number" id="totalBudget" class="form-input" placeholder="50000" step="0.01" min="0" required>
            <small style="color: var(--muted); font-size: 0.8rem; margin-top: 4px; display: block;">
              💡 Este valor será distribuído entre os canais selecionados
            </small>
          </div>
          <div class="form-group">
            <label class="form-label" for="reportModel">Modelo de Relatório *</label>
            <select id="reportModel" class="form-select" required>
              <option value="">Selecione o modelo</option>
              <option value="simple">Simples - Métricas básicas</option>
              <option value="multichannel">Multicanal - Análise completa</option>
            </select>
          </div>
        </div>

        <!-- Configuração de KPI -->
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label" for="kpiType">KPI Negociado *</label>
            <select id="kpiType" class="form-select" required>
              <option value="">Selecione o KPI</option>
              <option value="cpm">CPM (Custo por Mil Impressões)</option>
              <option value="cpv">CPV (Custo por Visualização)</option>
              <option value="cpc">CPC (Custo por Clique)</option>
              <option value="lead">Lead (Custo por Lead)</option>
              <option value="conversion">Conversão (Custo por Conversão)</option>
              <option value="reach">Alcance (Custo por Alcance)</option>
              <option value="engagement">Engajamento (Custo por Engajamento)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="kpiValue">Valor Unitário do KPI (R$) *</label>
            <input type="number" id="kpiValue" class="form-input" placeholder="2.50" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="kpiTarget">Meta do KPI *</label>
            <input type="number" id="kpiTarget" class="form-input" placeholder="10000" min="0" required>
          </div>
        </div>

        <!-- Estratégias da Campanha -->
        <div class="form-group">
          <label class="form-label" for="campaignStrategies">Estratégias da Campanha *</label>
          <textarea id="campaignStrategies" class="form-textarea" placeholder="Descreva as estratégias que serão utilizadas na campanha, objetivos, público-alvo, abordagem criativa, etc." required></textarea>
        </div>

        <!-- Seleção de Canais -->
        <div class="channels-section">
          <h3 class="channels-title">📺 Canais de Mídia</h3>
          <p style="color: var(--muted); margin-bottom: 20px; font-size: 0.9rem;">Selecione os canais que serão utilizados, configure as planilhas do Google Sheets e defina o orçamento para cada canal:</p>
          
          <!-- Resumo de Orçamento -->
          <div id="budgetSummary" class="budget-summary" style="display: none;">
            <div class="budget-summary-header">
              <h4>💰 Resumo de Orçamento</h4>
              <div class="budget-totals">
                <span>Total Distribuído: <strong id="distributedTotal">R$ 0,00</strong></span>
                <span>Restante: <strong id="remainingBudget">R$ 0,00</strong></span>
              </div>
            </div>
            <div id="budgetBreakdown" class="budget-breakdown"></div>
          </div>
          
          <div class="channel-item">
            <input type="checkbox" id="channel_youtube" class="channel-checkbox" value="youtube">
            <label for="channel_youtube" class="channel-label">📺 YouTube</label>
            <div class="channel-config">
              <input type="text" id="youtube_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="youtube_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="youtube_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="youtube_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_tiktok" class="channel-checkbox" value="tiktok">
            <label for="channel_tiktok" class="channel-label">🎵 TikTok</label>
            <div class="channel-config">
              <input type="text" id="tiktok_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="tiktok_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="tiktok_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="tiktok_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_netflix" class="channel-checkbox" value="netflix">
            <label for="channel_netflix" class="channel-label">🎬 Netflix</label>
            <div class="channel-config">
              <input type="text" id="netflix_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="netflix_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="netflix_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="netflix_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_disney" class="channel-checkbox" value="disney">
            <label for="channel_disney" class="channel-label">🏰 Disney+</label>
            <div class="channel-config">
              <input type="text" id="disney_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="disney_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="disney_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="disney_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_ctv" class="channel-checkbox" value="ctv">
            <label for="channel_ctv" class="channel-label">📺 CTV (Connected TV)</label>
            <div class="channel-config">
              <input type="text" id="ctv_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="ctv_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="ctv_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="ctv_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_programmatic_display" class="channel-checkbox" value="programmatic_display">
            <label for="channel_programmatic_display" class="channel-label">🎯 Programática Display</label>
            <div class="channel-config">
              <input type="text" id="programmatic_display_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="programmatic_display_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="programmatic_display_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="programmatic_display_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_programmatic_video" class="channel-checkbox" value="programmatic_video">
            <label for="channel_programmatic_video" class="channel-label">🎬 Programática Video</label>
            <div class="channel-config">
              <input type="text" id="programmatic_video_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="programmatic_video_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="programmatic_video_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="programmatic_video_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_footfall_display" class="channel-checkbox" value="footfall_display">
            <label for="channel_footfall_display" class="channel-label">📍 Footfall Display</label>
            <div class="channel-config">
              <input type="text" id="footfall_display_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="footfall_display_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="footfall_display_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="footfall_display_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_footfall_map" class="channel-checkbox" value="footfall_map">
            <label for="channel_footfall_map" class="channel-label">🗺️ Footfall Mapa</label>
            <div class="channel-config">
              <input type="text" id="footfall_map_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="footfall_map_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="footfall_map_budget" class="channel-budget-input" placeholder="Orçamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="footfall_map_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>
        </div>

        <!-- Preview da Configuração -->
        <div class="preview-section">
          <h4 class="preview-title">👁️ Preview da Configuração</h4>
          <div id="previewContent" class="preview-content">
            Preencha os campos acima para ver o preview da configuração...
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeCreateDashboardModal()">Cancelar</button>
      <button type="button" class="btn btn-primary" onclick="saveDashboard()" id="saveDashboardBtn">
        <span>💾</span>
        <span>Salvar Dashboard</span>
      </button>
    </div>
  </div>
</div>

<!-- Incluir sistema de autenticação híbrido -->
<script src="auth_system_hybrid.js"></script>
<script src="auth_middleware.js"></script>
<script src="navigation_menu.js"></script>

<script>
// Verificar autenticação usando sistema robusto
function checkAuthentication() {
  if (window.authSystem && !window.authSystem.isAuthenticated()) {
    window.location.href = '/login.html';
    return null;
  }
  
  const session = window.authSystem.getCurrentSession();
  return session;
}

// Função de logout usando sistema robusto
function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    if (window.authSystem) {
      window.authSystem.logout();
    }
    window.location.href = '/login.html';
  }
}

// Atualizar informações do usuário usando sistema robusto
async function updateUserInfo(sessionData) {
  try {
    const user = await window.authSystem.getCurrentUser();
    const systemData = window.authSystem.getSystemData();
    const role = systemData.roles.find(r => r.id === sessionData.role);
    const company = await window.authSystem.getCurrentUserCompany();
    
    // Usar dados do usuário se disponível, senão usar dados da sessão
    const displayName = user?.profile?.full_name || sessionData.username;
    const userRole = role ? role.name : sessionData.role;
    
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userRole').textContent = userRole;
    document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
    
    // Exibir empresa do usuário se não for super admin
    const companyInfo = document.getElementById('userCompany');
    if (companyInfo) {
      if (sessionData.role === 'super_admin') {
        companyInfo.textContent = 'Todas as Empresas';
        companyInfo.style.color = 'var(--accent)';
      } else if (company) {
        companyInfo.textContent = company.name;
        companyInfo.style.color = 'var(--muted)';
      } else {
        companyInfo.textContent = 'Sem Empresa';
        companyInfo.style.color = 'var(--error)';
      }
    }
  } catch (error) {
    console.error('Erro ao atualizar informações do usuário:', error);
    // Fallback para dados da sessão
    document.getElementById('userName').textContent = sessionData.username;
    document.getElementById('userRole').textContent = sessionData.role;
    document.getElementById('userAvatar').textContent = sessionData.username.charAt(0).toUpperCase();
    
    const companyInfo = document.getElementById('userCompany');
    if (companyInfo) {
      companyInfo.textContent = sessionData.role === 'super_admin' ? 'Todas as Empresas' : 'Sem Empresa';
    }
  }
}

// ===== DASHBOARD BUILDER FUNCTIONS =====

function initializeDashboardBuilder() {
  // Adicionar event listeners para os checkboxes dos canais
  const channelCheckboxes = document.querySelectorAll('.channel-checkbox');
  channelCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const channelName = this.value;
      const sheetInput = document.getElementById(`${channelName}_sheet`);
      const gidInput = document.getElementById(`${channelName}_gid`);
      const budgetInput = document.getElementById(`${channelName}_budget`);
      const quantityInput = document.getElementById(`${channelName}_quantity`);
      
      if (this.checked) {
        sheetInput.disabled = false;
        gidInput.disabled = false;
        budgetInput.disabled = false;
        quantityInput.disabled = false;
        sheetInput.required = true;
        budgetInput.required = true;
        quantityInput.required = true;
      } else {
        sheetInput.disabled = true;
        gidInput.disabled = true;
        budgetInput.disabled = true;
        quantityInput.disabled = true;
        sheetInput.required = false;
        budgetInput.required = false;
        quantityInput.required = false;
        sheetInput.value = '';
        gidInput.value = '';
        budgetInput.value = '';
        quantityInput.value = '';
      }
      
      updateBudgetSummary();
      updatePreview();
    });
  });
  
  // Adicionar event listeners para atualizar preview em tempo real
  const formInputs = document.querySelectorAll('#createDashboardForm input, #createDashboardForm select, #createDashboardForm textarea');
  formInputs.forEach(input => {
    input.addEventListener('input', function() {
      if (input.id === 'totalBudget') {
        updateBudgetSummary();
      }
      updatePreview();
    });
    input.addEventListener('change', function() {
      if (input.id === 'totalBudget') {
        updateBudgetSummary();
      }
      updatePreview();
    });
  });
  
  // Adicionar event listeners para inputs de orçamento por canal
  const budgetInputs = document.querySelectorAll('.channel-budget-input');
  budgetInputs.forEach(input => {
    input.addEventListener('input', updateBudgetSummary);
    input.addEventListener('change', updateBudgetSummary);
  });
  
  // Adicionar event listeners para inputs de quantidade por canal
  const quantityInputs = document.querySelectorAll('.channel-quantity-input');
  quantityInputs.forEach(input => {
    input.addEventListener('input', updateBudgetSummary);
    input.addEventListener('change', updateBudgetSummary);
  });
}

function openCreateDashboardModal() {
  const modal = document.getElementById('createDashboardModal');
  modal.classList.add('active');
  
  // Definir data mínima como hoje
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('startDate').min = today;
  document.getElementById('endDate').min = today;
  
  // Limpar formulário
  document.getElementById('createDashboardForm').reset();
  
  // Desabilitar todos os inputs de planilhas
  const sheetInputs = document.querySelectorAll('.channel-sheet-input');
  sheetInputs.forEach(input => {
    input.disabled = true;
    input.required = false;
  });
  
  updatePreview();
}

function closeCreateDashboardModal() {
  const modal = document.getElementById('createDashboardModal');
  modal.classList.remove('active');
}

function updateBudgetSummary() {
  const totalBudget = parseFloat(document.getElementById('totalBudget').value) || 0;
  const budgetSummary = document.getElementById('budgetSummary');
  const distributedTotal = document.getElementById('distributedTotal');
  const remainingBudget = document.getElementById('remainingBudget');
  const budgetBreakdown = document.getElementById('budgetBreakdown');
  
  // Calcular orçamento distribuído
  let distributed = 0;
  const budgetItems = [];
  
  const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
  channelCheckboxes.forEach(checkbox => {
    const channelName = checkbox.value;
    const budgetInput = document.getElementById(`${channelName}_budget`);
    const quantityInput = document.getElementById(`${channelName}_quantity`);
    const budgetValue = parseFloat(budgetInput.value) || 0;
    const quantityValue = parseInt(quantityInput.value) || 0;
    
    if (budgetValue > 0) {
      distributed += budgetValue;
      budgetItems.push({
        name: checkbox.nextElementSibling.textContent,
        value: budgetValue,
        quantity: quantityValue
      });
    }
  });
  
  const remaining = totalBudget - distributed;
  
  // Atualizar totais
  distributedTotal.textContent = `R$ ${distributed.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  remainingBudget.textContent = `R$ ${remaining.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  
  // Atualizar cor do restante
  if (remaining < 0) {
    remainingBudget.style.color = '#ff4757'; // Vermelho se excedeu
  } else if (remaining === 0) {
    remainingBudget.style.color = '#00ff88'; // Verde se exato
  } else {
    remainingBudget.style.color = '#ffa726'; // Laranja se sobrou
  }
  
  // Atualizar breakdown
  if (budgetItems.length > 0) {
    budgetBreakdown.innerHTML = budgetItems.map(item => `
      <div class="budget-item">
        <div class="budget-item-info">
          <span class="budget-item-name">${item.name}</span>
          <span class="budget-item-details">${item.quantity > 0 ? `${item.quantity.toLocaleString()} unidades` : 'Sem quantidade'}</span>
        </div>
        <span class="budget-item-value">R$ ${item.value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
      </div>
    `).join('');
    
    budgetSummary.style.display = 'block';
  } else {
    budgetSummary.style.display = 'none';
  }
}

function updatePreview() {
  const previewContent = document.getElementById('previewContent');
  
  const campaignName = document.getElementById('campaignName').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const totalBudget = document.getElementById('totalBudget').value;
  const reportModel = document.getElementById('reportModel').value;
  const kpiType = document.getElementById('kpiType').value;
  const kpiValue = document.getElementById('kpiValue').value;
  const kpiTarget = document.getElementById('kpiTarget').value;
  const strategies = document.getElementById('campaignStrategies').value;
  
  // Contar canais selecionados
  const selectedChannels = [];
  const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
  channelCheckboxes.forEach(checkbox => {
    const channelName = checkbox.value;
    const sheetId = document.getElementById(`${channelName}_sheet`).value;
    if (sheetId) {
      selectedChannels.push({
        name: checkbox.nextElementSibling.textContent,
        sheetId: sheetId
      });
    }
  });
  
  let previewHTML = '';
  
  if (campaignName) {
    previewHTML += `<strong>📋 Campanha:</strong> ${campaignName}<br>`;
  }
  
  if (startDate && endDate) {
    const start = new Date(startDate).toLocaleDateString('pt-BR');
    const end = new Date(endDate).toLocaleDateString('pt-BR');
    previewHTML += `<strong>📅 Período:</strong> ${start} a ${end}<br>`;
  }
  
  if (totalBudget) {
    previewHTML += `<strong>💰 Orçamento:</strong> R$ ${parseFloat(totalBudget).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>`;
  }
  
  if (reportModel) {
    const modelName = reportModel === 'simple' ? 'Simples' : 'Multicanal';
    previewHTML += `<strong>📊 Modelo:</strong> ${modelName}<br>`;
  }
  
  if (kpiType && kpiValue && kpiTarget) {
    const kpiNames = {
      'cpm': 'CPM',
      'cpv': 'CPV', 
      'cpc': 'CPC',
      'lead': 'Lead',
      'conversion': 'Conversão',
      'reach': 'Alcance',
      'engagement': 'Engajamento'
    };
    previewHTML += `<strong>🎯 KPI:</strong> ${kpiNames[kpiType]} - R$ ${parseFloat(kpiValue).toFixed(2)} (Meta: ${parseInt(kpiTarget).toLocaleString()})<br>`;
  }
  
  if (selectedChannels.length > 0) {
    previewHTML += `<strong>📺 Canais (${selectedChannels.length}):</strong> `;
    previewHTML += selectedChannels.map(ch => ch.name).join(', ') + '<br>';
  }
  
  if (strategies) {
    const shortStrategies = strategies.length > 100 ? strategies.substring(0, 100) + '...' : strategies;
    previewHTML += `<strong>💡 Estratégias:</strong> ${shortStrategies}<br>`;
  }
  
  if (!previewHTML) {
    previewHTML = 'Preencha os campos acima para ver o preview da configuração...';
  }
  
  previewContent.innerHTML = previewHTML;
}

function validateForm() {
  const form = document.getElementById('createDashboardForm');
  const requiredFields = form.querySelectorAll('[required]');
  let isValid = true;
  
  // Verificar campos obrigatórios
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      field.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      field.style.borderColor = '';
    }
  });
  
  // Verificar se pelo menos um canal foi selecionado
  const selectedChannels = document.querySelectorAll('.channel-checkbox:checked');
  if (selectedChannels.length === 0) {
    alert('⚠️ Selecione pelo menos um canal de mídia!');
    isValid = false;
  }
  
  // Verificar se todos os canais selecionados têm planilha, orçamento e quantidade configurados
  selectedChannels.forEach(checkbox => {
    const channelName = checkbox.value;
    const sheetInput = document.getElementById(`${channelName}_sheet`);
    const budgetInput = document.getElementById(`${channelName}_budget`);
    const quantityInput = document.getElementById(`${channelName}_quantity`);
    
    if (!sheetInput.value.trim()) {
      alert(`⚠️ Configure a planilha do Google Sheets para o canal ${checkbox.nextElementSibling.textContent}!`);
      sheetInput.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      sheetInput.style.borderColor = '';
    }
    
    if (!budgetInput.value || parseFloat(budgetInput.value) <= 0) {
      alert(`⚠️ Configure o orçamento para o canal ${checkbox.nextElementSibling.textContent}!`);
      budgetInput.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      budgetInput.style.borderColor = '';
    }
    
    if (!quantityInput.value || parseInt(quantityInput.value) <= 0) {
      alert(`⚠️ Configure a quantidade contratada para o canal ${checkbox.nextElementSibling.textContent}!`);
      quantityInput.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      quantityInput.style.borderColor = '';
    }
  });
  
  // Verificar se o orçamento total está sendo respeitado
  const totalBudget = parseFloat(document.getElementById('totalBudget').value) || 0;
  let distributedBudget = 0;
  
  selectedChannels.forEach(checkbox => {
    const channelName = checkbox.value;
    const budgetInput = document.getElementById(`${channelName}_budget`);
    const budgetValue = parseFloat(budgetInput.value) || 0;
    distributedBudget += budgetValue;
  });
  
  if (distributedBudget > totalBudget) {
    alert(`⚠️ O orçamento distribuído (R$ ${distributedBudget.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) excede o orçamento total (R$ ${totalBudget.toLocaleString('pt-BR', {minimumFractionDigits: 2})})!`);
    isValid = false;
  }
  
  // Verificar datas
  const startDate = new Date(document.getElementById('startDate').value);
  const endDate = new Date(document.getElementById('endDate').value);
  if (endDate <= startDate) {
    alert('⚠️ A data de fim deve ser posterior à data de início!');
    isValid = false;
  }
  
  return isValid;
}

async function saveDashboard() {
  if (!validateForm()) {
    return;
  }
  
  const saveBtn = document.getElementById('saveDashboardBtn');
  const originalText = saveBtn.innerHTML;
  
  // Mostrar loading
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="loading-spinner"></span><span>Salvando...</span>';
  
  try {
    // Coletar dados do formulário
    const formData = {
      campaignName: document.getElementById('campaignName').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      totalBudget: parseFloat(document.getElementById('totalBudget').value),
      reportModel: document.getElementById('reportModel').value,
      kpiType: document.getElementById('kpiType').value,
      kpiValue: parseFloat(document.getElementById('kpiValue').value),
      kpiTarget: parseInt(document.getElementById('kpiTarget').value),
      strategies: document.getElementById('campaignStrategies').value,
      channels: []
    };
    
    // Coletar canais selecionados
    const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
    channelCheckboxes.forEach(checkbox => {
      const channelName = checkbox.value;
      const sheetId = document.getElementById(`${channelName}_sheet`).value;
      const gid = document.getElementById(`${channelName}_gid`).value;
      const budget = parseFloat(document.getElementById(`${channelName}_budget`).value);
      const quantity = parseInt(document.getElementById(`${channelName}_quantity`).value);
      
      formData.channels.push({
        name: channelName,
        displayName: checkbox.nextElementSibling.textContent,
        sheetId: sheetId,
        gid: gid || null,
        budget: budget,
        quantity: quantity
      });
    });
    
    console.log('📊 Dados do dashboard:', formData);
    
    // Fazer chamada para a API do Cloud Run
    const response = await fetch('https://dashboard-automation-609095880025.us-central1.run.app/api/dashboards', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(formData)
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.message || 'Erro ao criar dashboard');
    }
    
    if (!result.success) {
      throw new Error(result.message || 'Falha na criação do dashboard');
    }
    
    // Sucesso
    saveBtn.innerHTML = '<span>✅</span><span>Salvo!</span>';
    
    setTimeout(() => {
      closeCreateDashboardModal();
      alert(`🎉 Dashboard criado com sucesso!\n\nID: ${result.dashboard.id}\nArquivo: ${result.dashboard.fileName}\n\nPróximos passos:\n1. Validar o dashboard gerado\n2. Configurar agendamento automático\n3. Iniciar coleta de dados`);
      
      // Recarregar lista de dashboards
      loadDashboards();
    }, 1000);
    
  } catch (error) {
    console.error('❌ Erro ao salvar dashboard:', error);
    alert('❌ Erro ao salvar dashboard. Tente novamente.');
    
    // Restaurar botão
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  }
}

// Inicializar quando a página carregar
document.addEventListener('DOMContentLoaded', () => {
  // Verificar autenticação
  const sessionData = checkAuthentication();
  if (!sessionData) return;
  
  // Atualizar informações do usuário
  updateUserInfo(sessionData).catch(error => {
    console.error('Erro ao atualizar informações do usuário:', error);
  });
  
  // Inicializar dashboard builder
  initializeDashboardBuilder();
});
</script>
</body>
</html>

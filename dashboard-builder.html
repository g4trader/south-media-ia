<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Builder - Criar Novos Dashboards</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f0f23;
    --bg2:#1a1a2e;
    --panel:#16213e;
    --stroke:rgba(148,163,184,.25);
    --muted:rgba(148,163,184,.8);
    --grad:linear-gradient(135deg,#ff6b35,#8b5cf6);
    --accent:#00ff88;
    --danger:#ff4757;
    --warning:#ffa726;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%);
       min-height:100vh;}
  .container{max-width:1400px;margin:0 auto;padding:32px 32px 40px}
  
  /* Header com logout */
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px;margin-bottom:40px}
  .header-left{display:flex;align-items:center;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:48px;height:48px;border-radius:12px;background:var(--grad);display:grid;place-items:center;font-weight:700;font-size:1.2rem}
  .header-content h1{font-size:2.5rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .header-content p{color:var(--muted);font-size:1.1rem;margin-top:8px}
  
  /* User info e logout */
  .user-info{display:flex;align-items:center;gap:16px}
  .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .user-details{text-align:right}
  .user-name{font-weight:600;color:#fff}
  .user-role{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
  .logout-button{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(255,71,87,.2);border:1px solid rgba(255,71,87,.4);border-radius:8px;color:var(--danger);text-decoration:none;font-size:.9rem;font-weight:600;transition:all .3s ease}
  .logout-button:hover{background:rgba(255,71,87,.3);transform:translateY(-1px)}
  
  /* Indicador de √°rea protegida */
  .protected-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,107,53,.2);border:1px solid rgba(255,107,53,.4);border-radius:20px;font-size:.8rem;font-weight:600;color:#ff6b35;margin-bottom:16px}
  
  /* Bot√£o criar dashboard */
  .create-dashboard-btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:linear-gradient(135deg,rgba(0,255,136,.2),rgba(0,255,136,.4));border:1px solid rgba(0,255,136,.5);border-radius:10px;color:var(--accent);text-decoration:none;font-weight:600;transition:all .3s ease;cursor:pointer}
  .create-dashboard-btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,255,136,.3);background:linear-gradient(135deg,rgba(0,255,136,.3),rgba(0,255,136,.5))}
  
  /* Modal Styles */
  .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000;backdrop-filter:blur(4px)}
  .modal.active{display:flex}
  .modal-content{background:var(--panel);border:1px solid var(--stroke);border-radius:20px;width:90%;max-width:800px;max-height:90vh;overflow-y:auto;position:relative}
  .modal-header{display:flex;align-items:center;justify-content:space-between;padding:24px 32px;border-bottom:1px solid var(--stroke)}
  .modal-title{font-size:1.5rem;font-weight:700;color:#fff}
  .modal-close{background:none;border:none;color:var(--muted);font-size:1.5rem;cursor:pointer;padding:8px;border-radius:8px;transition:all .3s ease}
  .modal-close:hover{background:rgba(255,255,255,.1);color:#fff}
  .modal-body{padding:32px}
  .form-group{margin-bottom:24px}
  .form-label{display:block;margin-bottom:8px;font-weight:600;color:#fff;font-size:.9rem}
  .form-input,.form-select,.form-textarea{width:100%;padding:12px 16px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:10px;color:#fff;font-size:.9rem;transition:all .3s ease}
  .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,255,136,.1)}
  .form-textarea{min-height:100px;resize:vertical}
  .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
  .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px}
  .channels-section{margin-top:32px;padding-top:24px;border-top:1px solid var(--stroke)}
  .channels-title{font-size:1.2rem;font-weight:700;color:#fff;margin-bottom:20px}
  .channel-item{display:flex;align-items:center;gap:12px;padding:16px;background:rgba(26,26,46,.5);border:1px solid var(--stroke);border-radius:12px;margin-bottom:12px}
  .channel-checkbox{width:20px;height:20px;accent-color:var(--accent)}
  .channel-label{flex:1;color:#fff;font-weight:500}
  .channel-config{flex:2;display:flex;gap:8px;align-items:center}
  .channel-sheet-input{flex:1;padding:8px 12px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:8px;color:#fff;font-size:.85rem}
  .channel-sheet-input:focus{outline:none;border-color:var(--accent)}
  .channel-budget-input{flex:0.7;padding:8px 12px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:8px;color:#fff;font-size:.85rem}
  .channel-budget-input:focus{outline:none;border-color:var(--accent)}
  .channel-quantity-input{flex:0.7;padding:8px 12px;background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:8px;color:#fff;font-size:.85rem}
  .channel-quantity-input:focus{outline:none;border-color:var(--accent)}
  .budget-summary{margin-bottom:24px;padding:20px;background:rgba(26,26,46,.3);border:1px solid var(--stroke);border-radius:12px}
  .budget-summary-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
  .budget-summary-header h4{color:#fff;font-size:1.1rem;margin:0}
  .budget-totals{display:flex;gap:20px;font-size:.9rem}
  .budget-totals span{color:var(--muted)}
  .budget-totals strong{color:var(--accent)}
  .budget-breakdown{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px}
  .budget-item{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:rgba(26,26,46,.5);border-radius:8px;font-size:.85rem}
  .budget-item-info{display:flex;flex-direction:column;gap:2px}
  .budget-item-name{color:#fff;font-weight:500}
  .budget-item-details{color:var(--muted);font-size:.75rem}
  .budget-item-value{color:var(--accent);font-weight:600}
  .modal-footer{display:flex;gap:12px;justify-content:flex-end;padding:24px 32px;border-top:1px solid var(--stroke)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border:none;border-radius:10px;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none}
  .btn-primary{background:var(--grad);color:#fff}
  .btn-primary:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,.4)}
  .btn-secondary{background:rgba(148,163,184,.2);border:1px solid rgba(148,163,184,.4);color:var(--muted)}
  .btn-secondary:hover{background:rgba(148,163,184,.3);color:#fff}
  .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
  .loading-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top:2px solid #fff;border-radius:50%;animation:spin 1s linear infinite}
  .preview-section{margin-top:24px;padding:20px;background:rgba(26,26,46,.3);border:1px solid var(--stroke);border-radius:12px}
  .preview-title{font-size:1rem;font-weight:600;color:#fff;margin-bottom:12px}
  .preview-content{color:var(--muted);font-size:.9rem;line-height:1.5}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  
  @media (max-width:768px){
    .container{padding:20px 16px}
    .header-content h1{font-size:2rem}
    .form-row,.form-row-3{grid-template-columns:1fr}
    .channel-config{flex-direction:column;align-items:stretch}
    .modal-footer{flex-direction:column}
    .modal-content{width:95%;margin:20px}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">üéØ</div>
      </div>
      <div class="header-content">
        <div class="protected-badge">
          <span>üîí</span>
          <span>Dashboard Builder</span>
        </div>
        <h1>Criar Novos Dashboards</h1>
        <p>Sistema de cria√ß√£o autom√°tica de dashboards de campanhas</p>
      </div>
    </div>
    
    <div class="user-info">
      <div class="user-details">
        <div class="user-name" id="userName">Usu√°rio</div>
        <div class="user-role" id="userRole">admin</div>
        <div class="user-company" id="userCompany">Empresa</div>
      </div>
      <div class="user-avatar" id="userAvatar">üë§</div>
      <a href="#" class="logout-button" onclick="logout()">
        <span>üö™</span>
        <span>Sair</span>
      </a>
    </div>
  </div>

  <div style="text-align: center; margin-bottom: 40px;">
    <button onclick="openCreateDashboardModal()" class="create-dashboard-btn">
      <span>‚ûï</span>
      <span>Criar Novo Dashboard</span>
    </button>
  </div>

  <div id="dashboardsList" style="display: none;">
    <!-- Lista de dashboards criados ser√° carregada aqui -->
  </div>
</div>

<!-- Modal de Cria√ß√£o de Dashboard -->
<div id="createDashboardModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">‚ûï Criar Novo Dashboard</h2>
      <button class="modal-close" onclick="closeCreateDashboardModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="createDashboardForm">
        <!-- Informa√ß√µes B√°sicas -->
        <div class="form-group">
          <label class="form-label" for="campaignName">Nome da Campanha *</label>
          <input type="text" id="campaignName" class="form-input" placeholder="Ex: Campanha Black Friday 2025" required>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="startDate">Data de In√≠cio *</label>
            <input type="date" id="startDate" class="form-input" required placeholder="Selecione a data de in√≠cio">
            <small style="color: var(--muted); font-size: 0.8rem; margin-top: 4px; display: block;">
              üìÖ Use o calend√°rio ou digite no formato DD/MM/AAAA
            </small>
          </div>
          <div class="form-group">
            <label class="form-label" for="endDate">Data de Fim *</label>
            <input type="date" id="endDate" class="form-input" required placeholder="Selecione a data de fim">
            <small style="color: var(--muted); font-size: 0.8rem; margin-top: 4px; display: block;">
              üìÖ Deve ser posterior √† data de in√≠cio
            </small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label class="form-label" for="totalBudget">Verba Total L√≠quida (R$) *</label>
            <input type="number" id="totalBudget" class="form-input" placeholder="50000" step="0.01" min="0" required>
            <small style="color: var(--muted); font-size: 0.8rem; margin-top: 4px; display: block;">
              üí° Este valor ser√° distribu√≠do entre os canais selecionados
            </small>
          </div>
          <div class="form-group">
            <label class="form-label" for="reportModel">Modelo de Relat√≥rio *</label>
            <select id="reportModel" class="form-select" required>
              <option value="">Selecione o modelo</option>
              <option value="simple">Simples - M√©tricas b√°sicas</option>
              <option value="multichannel">Multicanal - An√°lise completa</option>
            </select>
          </div>
        </div>

        <!-- Configura√ß√£o de KPI -->
        <div class="form-row-3">
          <div class="form-group">
            <label class="form-label" for="kpiType">KPI Negociado *</label>
            <select id="kpiType" class="form-select" required>
              <option value="">Selecione o KPI</option>
              <option value="cpm">CPM (Custo por Mil Impress√µes)</option>
              <option value="cpv">CPV (Custo por Visualiza√ß√£o)</option>
              <option value="cpc">CPC (Custo por Clique)</option>
              <option value="lead">Lead (Custo por Lead)</option>
              <option value="conversion">Convers√£o (Custo por Convers√£o)</option>
              <option value="reach">Alcance (Custo por Alcance)</option>
              <option value="engagement">Engajamento (Custo por Engajamento)</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label" for="kpiValue">Valor Unit√°rio do KPI (R$) *</label>
            <input type="number" id="kpiValue" class="form-input" placeholder="2.50" step="0.01" min="0" required>
          </div>
          <div class="form-group">
            <label class="form-label" for="kpiTarget">Meta do KPI *</label>
            <input type="number" id="kpiTarget" class="form-input" placeholder="10000" min="0" required>
          </div>
        </div>

        <!-- Estrat√©gias da Campanha -->
        <div class="form-group">
          <label class="form-label" for="campaignStrategies">Estrat√©gias da Campanha *</label>
          <textarea id="campaignStrategies" class="form-textarea" placeholder="Descreva as estrat√©gias que ser√£o utilizadas na campanha, objetivos, p√∫blico-alvo, abordagem criativa, etc." required></textarea>
        </div>

        <!-- Sele√ß√£o de Canais -->
        <div class="channels-section">
          <h3 class="channels-title">üì∫ Canais de M√≠dia</h3>
          <p style="color: var(--muted); margin-bottom: 20px; font-size: 0.9rem;">Selecione os canais que ser√£o utilizados, configure as planilhas do Google Sheets e defina o or√ßamento para cada canal:</p>
          
          <!-- Resumo de Or√ßamento -->
          <div id="budgetSummary" class="budget-summary" style="display: none;">
            <div class="budget-summary-header">
              <h4>üí∞ Resumo de Or√ßamento</h4>
              <div class="budget-totals">
                <span>Total Distribu√≠do: <strong id="distributedTotal">R$ 0,00</strong></span>
                <span>Restante: <strong id="remainingBudget">R$ 0,00</strong></span>
              </div>
            </div>
            <div id="budgetBreakdown" class="budget-breakdown"></div>
          </div>
          
          <div class="channel-item">
            <input type="checkbox" id="channel_youtube" class="channel-checkbox" value="youtube">
            <label for="channel_youtube" class="channel-label">üì∫ YouTube</label>
            <div class="channel-config">
              <input type="text" id="youtube_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="youtube_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="youtube_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="youtube_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_tiktok" class="channel-checkbox" value="tiktok">
            <label for="channel_tiktok" class="channel-label">üéµ TikTok</label>
            <div class="channel-config">
              <input type="text" id="tiktok_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="tiktok_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="tiktok_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="tiktok_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_netflix" class="channel-checkbox" value="netflix">
            <label for="channel_netflix" class="channel-label">üé¨ Netflix</label>
            <div class="channel-config">
              <input type="text" id="netflix_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="netflix_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="netflix_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="netflix_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_disney" class="channel-checkbox" value="disney">
            <label for="channel_disney" class="channel-label">üè∞ Disney+</label>
            <div class="channel-config">
              <input type="text" id="disney_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="disney_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="disney_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="disney_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_ctv" class="channel-checkbox" value="ctv">
            <label for="channel_ctv" class="channel-label">üì∫ CTV (Connected TV)</label>
            <div class="channel-config">
              <input type="text" id="ctv_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="ctv_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="ctv_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="ctv_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_programmatic_display" class="channel-checkbox" value="programmatic_display">
            <label for="channel_programmatic_display" class="channel-label">üéØ Program√°tica Display</label>
            <div class="channel-config">
              <input type="text" id="programmatic_display_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="programmatic_display_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="programmatic_display_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="programmatic_display_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_programmatic_video" class="channel-checkbox" value="programmatic_video">
            <label for="channel_programmatic_video" class="channel-label">üé¨ Program√°tica Video</label>
            <div class="channel-config">
              <input type="text" id="programmatic_video_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="programmatic_video_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="programmatic_video_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="programmatic_video_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_footfall_display" class="channel-checkbox" value="footfall_display">
            <label for="channel_footfall_display" class="channel-label">üìç Footfall Display</label>
            <div class="channel-config">
              <input type="text" id="footfall_display_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="footfall_display_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="footfall_display_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="footfall_display_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>

          <div class="channel-item">
            <input type="checkbox" id="channel_footfall_map" class="channel-checkbox" value="footfall_map">
            <label for="channel_footfall_map" class="channel-label">üó∫Ô∏è Footfall Mapa</label>
            <div class="channel-config">
              <input type="text" id="footfall_map_sheet" class="channel-sheet-input" placeholder="ID da planilha Google Sheets" disabled>
              <input type="text" id="footfall_map_gid" class="channel-sheet-input" placeholder="GID da aba (opcional)" disabled>
              <input type="number" id="footfall_map_budget" class="channel-budget-input" placeholder="Or√ßamento (R$)" step="0.01" min="0" disabled>
              <input type="number" id="footfall_map_quantity" class="channel-quantity-input" placeholder="Quantidade" min="0" disabled>
            </div>
          </div>
        </div>

        <!-- Preview da Configura√ß√£o -->
        <div class="preview-section">
          <h4 class="preview-title">üëÅÔ∏è Preview da Configura√ß√£o</h4>
          <div id="previewContent" class="preview-content">
            Preencha os campos acima para ver o preview da configura√ß√£o...
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" onclick="closeCreateDashboardModal()">Cancelar</button>
      <button type="button" class="btn btn-primary" onclick="saveDashboard()" id="saveDashboardBtn">
        <span>üíæ</span>
        <span>Salvar Dashboard</span>
      </button>
    </div>
  </div>
</div>

<!-- Incluir sistema de autentica√ß√£o h√≠brido -->
<script src="auth_system_hybrid.js"></script>
<script src="auth_middleware.js"></script>
<script src="navigation_menu.js"></script>

<script>
// Verificar autentica√ß√£o usando sistema robusto
function checkAuthentication() {
  if (window.authSystem && !window.authSystem.isAuthenticated()) {
    window.location.href = '/login.html';
    return null;
  }
  
  const session = window.authSystem.getCurrentSession();
  return session;
}

// Fun√ß√£o de logout usando sistema robusto
function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    if (window.authSystem) {
      window.authSystem.logout();
    }
    window.location.href = '/login.html';
  }
}

// Atualizar informa√ß√µes do usu√°rio usando sistema robusto
async function updateUserInfo(sessionData) {
  try {
    const user = await window.authSystem.getCurrentUser();
    const systemData = window.authSystem.getSystemData();
    const role = systemData.roles.find(r => r.id === sessionData.role);
    const company = await window.authSystem.getCurrentUserCompany();
    
    // Usar dados do usu√°rio se dispon√≠vel, sen√£o usar dados da sess√£o
    const displayName = user?.profile?.full_name || sessionData.username;
    const userRole = role ? role.name : sessionData.role;
    
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userRole').textContent = userRole;
    document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
    
    // Exibir empresa do usu√°rio se n√£o for super admin
    const companyInfo = document.getElementById('userCompany');
    if (companyInfo) {
      if (sessionData.role === 'super_admin') {
        companyInfo.textContent = 'Todas as Empresas';
        companyInfo.style.color = 'var(--accent)';
      } else if (company) {
        companyInfo.textContent = company.name;
        companyInfo.style.color = 'var(--muted)';
      } else {
        companyInfo.textContent = 'Sem Empresa';
        companyInfo.style.color = 'var(--error)';
      }
    }
  } catch (error) {
    console.error('Erro ao atualizar informa√ß√µes do usu√°rio:', error);
    // Fallback para dados da sess√£o
    document.getElementById('userName').textContent = sessionData.username;
    document.getElementById('userRole').textContent = sessionData.role;
    document.getElementById('userAvatar').textContent = sessionData.username.charAt(0).toUpperCase();
    
    const companyInfo = document.getElementById('userCompany');
    if (companyInfo) {
      companyInfo.textContent = sessionData.role === 'super_admin' ? 'Todas as Empresas' : 'Sem Empresa';
    }
  }
}

// ===== DASHBOARD BUILDER FUNCTIONS =====

function initializeDashboardBuilder() {
  // Adicionar event listeners para os checkboxes dos canais
  const channelCheckboxes = document.querySelectorAll('.channel-checkbox');
  channelCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const channelName = this.value;
      const sheetInput = document.getElementById(`${channelName}_sheet`);
      const gidInput = document.getElementById(`${channelName}_gid`);
      const budgetInput = document.getElementById(`${channelName}_budget`);
      const quantityInput = document.getElementById(`${channelName}_quantity`);
      
      if (this.checked) {
        sheetInput.disabled = false;
        gidInput.disabled = false;
        budgetInput.disabled = false;
        quantityInput.disabled = false;
        sheetInput.required = true;
        budgetInput.required = true;
        quantityInput.required = true;
      } else {
        sheetInput.disabled = true;
        gidInput.disabled = true;
        budgetInput.disabled = true;
        quantityInput.disabled = true;
        sheetInput.required = false;
        budgetInput.required = false;
        quantityInput.required = false;
        sheetInput.value = '';
        gidInput.value = '';
        budgetInput.value = '';
        quantityInput.value = '';
      }
      
      updateBudgetSummary();
      updatePreview();
    });
  });
  
  // Adicionar event listeners para atualizar preview em tempo real
  const formInputs = document.querySelectorAll('#createDashboardForm input, #createDashboardForm select, #createDashboardForm textarea');
  formInputs.forEach(input => {
    input.addEventListener('input', function() {
      if (input.id === 'totalBudget') {
        updateBudgetSummary();
      }
      updatePreview();
    });
    input.addEventListener('change', function() {
      if (input.id === 'totalBudget') {
        updateBudgetSummary();
      }
      updatePreview();
    });
  });
  
  // Adicionar event listeners para inputs de or√ßamento por canal
  const budgetInputs = document.querySelectorAll('.channel-budget-input');
  budgetInputs.forEach(input => {
    input.addEventListener('input', updateBudgetSummary);
    input.addEventListener('change', updateBudgetSummary);
  });
  
  // Adicionar event listeners para inputs de quantidade por canal
  const quantityInputs = document.querySelectorAll('.channel-quantity-input');
  quantityInputs.forEach(input => {
    input.addEventListener('input', updateBudgetSummary);
    input.addEventListener('change', updateBudgetSummary);
  });
}

function openCreateDashboardModal() {
  const modal = document.getElementById('createDashboardModal');
  modal.classList.add('active');
  
  // Definir data m√≠nima como hoje
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('startDate').min = today;
  document.getElementById('endDate').min = today;
  
  // Adicionar valida√ß√£o em tempo real para datas
  document.getElementById('startDate').addEventListener('change', validateDates);
  document.getElementById('endDate').addEventListener('change', validateDates);
  
  // Adicionar corre√ß√£o autom√°tica de datas
  document.getElementById('startDate').addEventListener('blur', autoCorrectDate);
  document.getElementById('endDate').addEventListener('blur', autoCorrectDate);
  
  // Limpar formul√°rio
  document.getElementById('createDashboardForm').reset();
  
  // Desabilitar todos os inputs de planilhas
  const sheetInputs = document.querySelectorAll('.channel-sheet-input');
  sheetInputs.forEach(input => {
    input.disabled = true;
    input.required = false;
  });
  
  updatePreview();
}

function closeCreateDashboardModal() {
  const modal = document.getElementById('createDashboardModal');
  modal.classList.remove('active');
}

function updateBudgetSummary() {
  const totalBudget = parseFloat(document.getElementById('totalBudget').value) || 0;
  const budgetSummary = document.getElementById('budgetSummary');
  const distributedTotal = document.getElementById('distributedTotal');
  const remainingBudget = document.getElementById('remainingBudget');
  const budgetBreakdown = document.getElementById('budgetBreakdown');
  
  // Calcular or√ßamento distribu√≠do
  let distributed = 0;
  const budgetItems = [];
  
  const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
  channelCheckboxes.forEach(checkbox => {
    const channelName = checkbox.value;
    const budgetInput = document.getElementById(`${channelName}_budget`);
    const quantityInput = document.getElementById(`${channelName}_quantity`);
    const budgetValue = parseFloat(budgetInput.value) || 0;
    const quantityValue = parseInt(quantityInput.value) || 0;
    
    if (budgetValue > 0) {
      distributed += budgetValue;
      budgetItems.push({
        name: checkbox.nextElementSibling.textContent,
        value: budgetValue,
        quantity: quantityValue
      });
    }
  });
  
  const remaining = totalBudget - distributed;
  
  // Atualizar totais
  distributedTotal.textContent = `R$ ${distributed.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  remainingBudget.textContent = `R$ ${remaining.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
  
  // Atualizar cor do restante
  if (remaining < 0) {
    remainingBudget.style.color = '#ff4757'; // Vermelho se excedeu
  } else if (remaining === 0) {
    remainingBudget.style.color = '#00ff88'; // Verde se exato
  } else {
    remainingBudget.style.color = '#ffa726'; // Laranja se sobrou
  }
  
  // Atualizar breakdown
  if (budgetItems.length > 0) {
    budgetBreakdown.innerHTML = budgetItems.map(item => `
      <div class="budget-item">
        <div class="budget-item-info">
          <span class="budget-item-name">${item.name}</span>
          <span class="budget-item-details">${item.quantity > 0 ? `${item.quantity.toLocaleString()} unidades` : 'Sem quantidade'}</span>
        </div>
        <span class="budget-item-value">R$ ${item.value.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
      </div>
    `).join('');
    
    budgetSummary.style.display = 'block';
  } else {
    budgetSummary.style.display = 'none';
  }
}

// Fun√ß√£o para validar datas em tempo real
function validateDates() {
  const startDateValue = document.getElementById('startDate').value;
  const endDateValue = document.getElementById('endDate').value;
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  
  // Limpar erros anteriores
  startDateInput.style.borderColor = '';
  endDateInput.style.borderColor = '';
  
  if (startDateValue && endDateValue) {
    const startDate = new Date(startDateValue);
    const endDate = new Date(endDateValue);
    
    if (endDate <= startDate) {
      startDateInput.style.borderColor = 'var(--danger)';
      endDateInput.style.borderColor = 'var(--danger)';
      showDateError('A data de fim deve ser posterior √† data de in√≠cio!');
    } else {
      hideDateError();
    }
  }
}

// Fun√ß√£o para mostrar erro de data
function showDateError(message) {
  let errorDiv = document.getElementById('dateError');
  if (!errorDiv) {
    errorDiv = document.createElement('div');
    errorDiv.id = 'dateError';
    errorDiv.style.cssText = 'color: var(--danger); font-size: 0.85rem; margin-top: 8px; padding: 8px; background: rgba(255, 71, 87, 0.1); border: 1px solid rgba(255, 71, 87, 0.3); border-radius: 6px;';
    document.getElementById('endDate').parentNode.appendChild(errorDiv);
  }
  errorDiv.textContent = '‚ö†Ô∏è ' + message;
}

// Fun√ß√£o para esconder erro de data
function hideDateError() {
  const errorDiv = document.getElementById('dateError');
  if (errorDiv) {
    errorDiv.remove();
  }
}

// Fun√ß√£o para corrigir automaticamente datas inv√°lidas
function autoCorrectDate(event) {
  const input = event.target;
  let value = input.value;
  
  // Se o usu√°rio digitou manualmente, tentar corrigir
  if (value && !value.match(/^\d{4}-\d{2}-\d{2}$/)) {
    // Tentar corrigir formato DD/MM/YYYY para YYYY-MM-DD
    if (value.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
      const parts = value.split('/');
      const correctedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
      
      // Verificar se a data √© v√°lida
      const date = new Date(correctedDate);
      if (!isNaN(date.getTime())) {
        input.value = correctedDate;
        showDateCorrection(`Data corrigida para: ${date.toLocaleDateString('pt-BR')}`);
        validateDates();
      }
    }
    // Tentar corrigir ano com 5 d√≠gitos (ex: 20205 -> 2025)
    else if (value.match(/^\d{2}\/\d{2}\/\d{5}$/)) {
      const parts = value.split('/');
      const year = parts[2].substring(0, 4); // Pegar apenas os primeiros 4 d√≠gitos
      const correctedDate = `${year}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
      
      const date = new Date(correctedDate);
      if (!isNaN(date.getTime())) {
        input.value = correctedDate;
        showDateCorrection(`Ano corrigido de ${parts[2]} para ${year}`);
        validateDates();
      }
    }
  }
}

// Fun√ß√£o para mostrar corre√ß√£o de data
function showDateCorrection(message) {
  let correctionDiv = document.getElementById('dateCorrection');
  if (!correctionDiv) {
    correctionDiv = document.createElement('div');
    correctionDiv.id = 'dateCorrection';
    correctionDiv.style.cssText = 'color: var(--accent); font-size: 0.85rem; margin-top: 8px; padding: 8px; background: rgba(0, 255, 136, 0.1); border: 1px solid rgba(0, 255, 136, 0.3); border-radius: 6px;';
    document.getElementById('endDate').parentNode.appendChild(correctionDiv);
  }
  correctionDiv.textContent = '‚úÖ ' + message;
  
  // Remover ap√≥s 3 segundos
  setTimeout(() => {
    if (correctionDiv) {
      correctionDiv.remove();
    }
  }, 3000);
}

function updatePreview() {
  const previewContent = document.getElementById('previewContent');
  
  const campaignName = document.getElementById('campaignName').value;
  const startDate = document.getElementById('startDate').value;
  const endDate = document.getElementById('endDate').value;
  const totalBudget = document.getElementById('totalBudget').value;
  const reportModel = document.getElementById('reportModel').value;
  const kpiType = document.getElementById('kpiType').value;
  const kpiValue = document.getElementById('kpiValue').value;
  const kpiTarget = document.getElementById('kpiTarget').value;
  const strategies = document.getElementById('campaignStrategies').value;
  
  // Contar canais selecionados
  const selectedChannels = [];
  const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
  channelCheckboxes.forEach(checkbox => {
    const channelName = checkbox.value;
    const sheetId = document.getElementById(`${channelName}_sheet`).value;
    if (sheetId) {
      selectedChannels.push({
        name: checkbox.nextElementSibling.textContent,
        sheetId: sheetId
      });
    }
  });
  
  let previewHTML = '';
  
  if (campaignName) {
    previewHTML += `<strong>üìã Campanha:</strong> ${campaignName}<br>`;
  }
  
  if (startDate && endDate) {
    const start = new Date(startDate).toLocaleDateString('pt-BR');
    const end = new Date(endDate).toLocaleDateString('pt-BR');
    previewHTML += `<strong>üìÖ Per√≠odo:</strong> ${start} a ${end}<br>`;
  }
  
  if (totalBudget) {
    previewHTML += `<strong>üí∞ Or√ßamento:</strong> R$ ${parseFloat(totalBudget).toLocaleString('pt-BR', {minimumFractionDigits: 2})}<br>`;
  }
  
  if (reportModel) {
    const modelName = reportModel === 'simple' ? 'Simples' : 'Multicanal';
    previewHTML += `<strong>üìä Modelo:</strong> ${modelName}<br>`;
  }
  
  if (kpiType && kpiValue && kpiTarget) {
    const kpiNames = {
      'cpm': 'CPM',
      'cpv': 'CPV', 
      'cpc': 'CPC',
      'lead': 'Lead',
      'conversion': 'Convers√£o',
      'reach': 'Alcance',
      'engagement': 'Engajamento'
    };
    previewHTML += `<strong>üéØ KPI:</strong> ${kpiNames[kpiType]} - R$ ${parseFloat(kpiValue).toFixed(2)} (Meta: ${parseInt(kpiTarget).toLocaleString()})<br>`;
  }
  
  if (selectedChannels.length > 0) {
    previewHTML += `<strong>üì∫ Canais (${selectedChannels.length}):</strong> `;
    previewHTML += selectedChannels.map(ch => ch.name).join(', ') + '<br>';
  }
  
  if (strategies) {
    const shortStrategies = strategies.length > 100 ? strategies.substring(0, 100) + '...' : strategies;
    previewHTML += `<strong>üí° Estrat√©gias:</strong> ${shortStrategies}<br>`;
  }
  
  if (!previewHTML) {
    previewHTML = 'Preencha os campos acima para ver o preview da configura√ß√£o...';
  }
  
  previewContent.innerHTML = previewHTML;
}

function validateForm() {
  const form = document.getElementById('createDashboardForm');
  const requiredFields = form.querySelectorAll('[required]');
  let isValid = true;
  
  // Verificar campos obrigat√≥rios
  requiredFields.forEach(field => {
    if (!field.value.trim()) {
      field.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      field.style.borderColor = '';
    }
  });
  
  // Verificar se pelo menos um canal foi selecionado
  const selectedChannels = document.querySelectorAll('.channel-checkbox:checked');
  if (selectedChannels.length === 0) {
    alert('‚ö†Ô∏è Selecione pelo menos um canal de m√≠dia!');
    isValid = false;
  }
  
  // Verificar se todos os canais selecionados t√™m planilha, or√ßamento e quantidade configurados
  selectedChannels.forEach(checkbox => {
    const channelName = checkbox.value;
    const sheetInput = document.getElementById(`${channelName}_sheet`);
    const budgetInput = document.getElementById(`${channelName}_budget`);
    const quantityInput = document.getElementById(`${channelName}_quantity`);
    
    if (!sheetInput.value.trim()) {
      alert(`‚ö†Ô∏è Configure a planilha do Google Sheets para o canal ${checkbox.nextElementSibling.textContent}!`);
      sheetInput.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      sheetInput.style.borderColor = '';
    }
    
    if (!budgetInput.value || parseFloat(budgetInput.value) <= 0) {
      alert(`‚ö†Ô∏è Configure o or√ßamento para o canal ${checkbox.nextElementSibling.textContent}!`);
      budgetInput.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      budgetInput.style.borderColor = '';
    }
    
    if (!quantityInput.value || parseInt(quantityInput.value) <= 0) {
      alert(`‚ö†Ô∏è Configure a quantidade contratada para o canal ${checkbox.nextElementSibling.textContent}!`);
      quantityInput.style.borderColor = '#ff4757';
      isValid = false;
    } else {
      quantityInput.style.borderColor = '';
    }
  });
  
  // Verificar se o or√ßamento total est√° sendo respeitado
  const totalBudget = parseFloat(document.getElementById('totalBudget').value) || 0;
  let distributedBudget = 0;
  
  selectedChannels.forEach(checkbox => {
    const channelName = checkbox.value;
    const budgetInput = document.getElementById(`${channelName}_budget`);
    const budgetValue = parseFloat(budgetInput.value) || 0;
    distributedBudget += budgetValue;
  });
  
  if (distributedBudget > totalBudget) {
    alert(`‚ö†Ô∏è O or√ßamento distribu√≠do (R$ ${distributedBudget.toLocaleString('pt-BR', {minimumFractionDigits: 2})}) excede o or√ßamento total (R$ ${totalBudget.toLocaleString('pt-BR', {minimumFractionDigits: 2})})!`);
    isValid = false;
  }
  
  // Verificar datas
  const startDateValue = document.getElementById('startDate').value;
  const endDateValue = document.getElementById('endDate').value;
  
  if (!startDateValue || !endDateValue) {
    alert('‚ö†Ô∏è Por favor, preencha as datas de in√≠cio e fim!');
    isValid = false;
  } else {
    const startDate = new Date(startDateValue);
    const endDate = new Date(endDateValue);
    
    // Verificar se as datas s√£o v√°lidas
    if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
      alert('‚ö†Ô∏è Por favor, insira datas v√°lidas!');
      isValid = false;
    } else if (endDate <= startDate) {
      alert('‚ö†Ô∏è A data de fim deve ser posterior √† data de in√≠cio!');
      isValid = false;
    }
  }
  
  return isValid;
}

async function saveDashboard() {
  alert('üîç DEBUG: Fun√ß√£o saveDashboard chamada');
  
  if (!validateForm()) {
    alert('‚ùå DEBUG: Valida√ß√£o do formul√°rio falhou');
    return;
  }
  
  alert('‚úÖ DEBUG: Valida√ß√£o do formul√°rio passou');
  
  const saveBtn = document.getElementById('saveDashboardBtn');
  const originalText = saveBtn.innerHTML;
  
  // Mostrar loading
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<span class="loading-spinner"></span><span>Salvando...</span>';
  
  try {
    // Coletar dados do formul√°rio
    const formData = {
      campaignName: document.getElementById('campaignName').value,
      startDate: document.getElementById('startDate').value,
      endDate: document.getElementById('endDate').value,
      totalBudget: parseFloat(document.getElementById('totalBudget').value),
      reportModel: document.getElementById('reportModel').value,
      kpiType: document.getElementById('kpiType').value,
      kpiValue: parseFloat(document.getElementById('kpiValue').value),
      kpiTarget: parseInt(document.getElementById('kpiTarget').value),
      strategies: document.getElementById('campaignStrategies').value,
      channels: []
    };
    
    // SOLU√á√ÉO SIMPLIFICADA: Enviar dados diretamente sem valida√ß√µes complexas
    const programmaticVideoChannel = {
      name: "programmatic_video",
      displayName: "üé¨ Program√°tica Video",
      sheetId: "1IUUSXaN0Drrdt-7B0IUiMRQK2gT-JtzhCFZvV7e5-V8",
      gid: "668487440",
      budget: 31000,
      quantity: 193750
    };
    
    formData.channels.push(programmaticVideoChannel);
    
    alert('üîß SOLU√á√ÉO SIMPLIFICADA: Dados hardcoded para teste:\n' + JSON.stringify(programmaticVideoChannel, null, 2));
    
    // C√ìDIGO DE COLETA DE CANAIS COMENTADO - USANDO DADOS HARDCODED
    /*
    // Fun√ß√£o para extrair ID da planilha de uma URL do Google Sheets
    function extractSheetId(url) {
      if (!url) return '';
      
      // Se j√° √© um ID (sem caracteres especiais), retorna como est√°
      if (!url.includes('/') && !url.includes('?')) {
        return url;
      }
      
      // Extrair ID de URLs do Google Sheets
      const match = url.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      return match ? match[1] : url;
    }
    
    // Coletar canais selecionados
    const channelCheckboxes = document.querySelectorAll('.channel-checkbox:checked');
    console.log(`üîç Canais selecionados: ${channelCheckboxes.length}`);
    
    // Debug: mostrar quantos canais foram selecionados
    if (channelCheckboxes.length === 0) {
      alert('‚ùå ERRO: Nenhum canal foi selecionado!');
      throw new Error('Nenhum canal foi selecionado');
    }
    
    // Debug: mostrar quais canais foram selecionados
    const selectedChannels = Array.from(channelCheckboxes).map(cb => cb.value);
    alert(`üîç Canais selecionados: ${selectedChannels.join(', ')}`);
    
    channelCheckboxes.forEach(checkbox => {
      const channelName = checkbox.value;
      console.log(`üîç Processando canal: ${channelName}`);
      
      const sheetIdElement = document.getElementById(`${channelName}_sheet`);
      const gidElement = document.getElementById(`${channelName}_gid`);
      const budgetElement = document.getElementById(`${channelName}_budget`);
      const quantityElement = document.getElementById(`${channelName}_quantity`);
      
      alert(`üîç DEBUG: Processando canal ${channelName}\nElementos encontrados:\n- sheetIdElement: ${sheetIdElement ? 'SIM' : 'N√ÉO'}\n- gidElement: ${gidElement ? 'SIM' : 'N√ÉO'}\n- budgetElement: ${budgetElement ? 'SIM' : 'N√ÉO'}\n- quantityElement: ${quantityElement ? 'SIM' : 'N√ÉO'}`);
      
      if (!sheetIdElement) {
        console.error(`‚ùå Elemento n√£o encontrado: ${channelName}_sheet`);
        alert(`‚ùå ERRO: Campo de planilha n√£o encontrado para ${channelName}!\nProcurando por: ${channelName}_sheet`);
        throw new Error(`Campo de planilha n√£o encontrado para ${channelName}`);
      }
      
      const sheetIdRaw = sheetIdElement.value;
      const sheetId = extractSheetId(sheetIdRaw);
      
      // Debug espec√≠fico para extractSheetId
      alert(`üîç DEBUG extractSheetId:\n- sheetIdRaw: "${sheetIdRaw}"\n- sheetId extra√≠do: "${sheetId}"\n- sheetId est√° vazio: ${!sheetId || sheetId.trim() === ''}`);
      const gidRaw = gidElement ? gidElement.value : '';
      const gid = gidRaw && gidRaw.trim() !== '' ? gidRaw : null;
      const budget = budgetElement ? parseFloat(budgetElement.value) : 0;
      const quantity = quantityElement ? parseInt(quantityElement.value) : 0;
      
      console.log(`üìä Canal ${channelName}:`);
      console.log(`  - sheetIdRaw: "${sheetIdRaw}"`);
      console.log(`  - sheetId: "${sheetId}"`);
      console.log(`  - gid: "${gid}"`);
      console.log(`  - budget: ${budget}`);
      console.log(`  - quantity: ${quantity}`);
      
      if (!sheetId || sheetId.trim() === '') {
        console.error(`‚ùå Sheet ID vazio para ${channelName}`);
        alert(`‚ùå ERRO: ID da planilha obrigat√≥rio para ${channelName}!\n\nValores encontrados:\n- sheetIdRaw: "${sheetIdRaw}"\n- sheetId: "${sheetId}"\n\nVerifique se o campo foi preenchido corretamente.`);
        throw new Error(`ID da planilha obrigat√≥rio para ${channelName}. Verifique se o campo foi preenchido corretamente.`);
      }
      
      formData.channels.push({
        name: channelName,
        displayName: checkbox.nextElementSibling.textContent,
        sheetId: sheetId,
        gid: gid, // gid j√° √© null se vazio
        budget: budget,
        quantity: quantity
      });
    });
    */
    
    console.log('üìä Dados do dashboard:', formData);
    
    // Debug: mostrar dados finais antes de enviar
    alert(`üîç DEBUG: Dados finais antes de enviar:\nCanais: ${formData.channels.length}\nPrimeiro canal:\n- name: ${formData.channels[0]?.name}\n- sheetId: "${formData.channels[0]?.sheetId}"\n- gid: ${formData.channels[0]?.gid}\n- budget: ${formData.channels[0]?.budget}\n- quantity: ${formData.channels[0]?.quantity}\n\nTipo do gid: ${typeof formData.channels[0]?.gid}`);
    
    // Debug: verificar serializa√ß√£o JSON
    const jsonString = JSON.stringify(formData);
    console.log('üîç JSON sendo enviado:', jsonString);
    
    // Fazer chamada para a API do Cloud Run
    const response = await fetch('https://dashboard-automation-609095880025.us-central1.run.app/api/dashboards', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: jsonString
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.message || 'Erro ao criar dashboard');
    }
    
    if (!result.success) {
      throw new Error(result.message || 'Falha na cria√ß√£o do dashboard');
    }
    
    // Sucesso
    saveBtn.innerHTML = '<span>‚úÖ</span><span>Salvo!</span>';
    
    setTimeout(() => {
      closeCreateDashboardModal();
      alert(`üéâ Dashboard criado com sucesso!\n\nID: ${result.dashboard.id}\nArquivo: ${result.dashboard.html_file}\n\nPr√≥ximos passos:\n1. Validar o dashboard gerado\n2. Configurar agendamento autom√°tico\n3. Iniciar coleta de dados`);
      
      // Redirecionar para a p√°gina de dashboards
      window.location.href = '/dashboard-protected.html';
    }, 1000);
    
  } catch (error) {
    console.error('‚ùå Erro ao salvar dashboard:', error);
    
    // Mostrar erro espec√≠fico
    let errorMessage = '‚ùå Erro ao salvar dashboard.';
    if (error.message) {
      errorMessage += '\n\nDetalhes: ' + error.message;
    }
    
    alert(errorMessage);
    
    // Restaurar bot√£o
    saveBtn.disabled = false;
    saveBtn.innerHTML = originalText;
  }
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
  // Verificar autentica√ß√£o
  const sessionData = checkAuthentication();
  if (!sessionData) return;
  
  // Atualizar informa√ß√µes do usu√°rio
  updateUserInfo(sessionData).catch(error => {
    console.error('Erro ao atualizar informa√ß√µes do usu√°rio:', error);
  });
  
  // Inicializar dashboard builder
  initializeDashboardBuilder();
});
</script>
</body>
</html>

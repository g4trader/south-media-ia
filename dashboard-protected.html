<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Painel de Controle - √Årea Restrita</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#0f0f23;
    --bg2:#1a1a2e;
    --panel:#16213e;
    --stroke:rgba(148,163,184,.25);
    --muted:rgba(148,163,184,.8);
    --grad:linear-gradient(135deg,#ff6b35,#8b5cf6);
    --accent:#00ff88;
    --danger:#ff4757;
    --warning:#ffa726;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#fff;
       background:linear-gradient(135deg,var(--bg) 0%,var(--bg2) 50%,var(--panel) 100%);
       min-height:100vh;}
  .container{max-width:1400px;margin:0 auto;padding:32px 32px 40px}
  
  /* Header com logout */
  .header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:20px;margin-bottom:40px}
  .header-left{display:flex;align-items:center;gap:20px}
  .logo{display:flex;align-items:center;gap:12px}
  .logo-icon{width:48px;height:48px;border-radius:12px;background:var(--grad);display:grid;place-items:center;font-weight:700;font-size:1.2rem}
  .header-content h1{font-size:2.5rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .header-content p{color:var(--muted);font-size:1.1rem;margin-top:8px}
  
  /* User info e logout */
  .user-info{display:flex;align-items:center;gap:16px}
  .user-avatar{width:40px;height:40px;border-radius:50%;background:var(--grad);display:grid;place-items:center;font-weight:700}
  .user-details{text-align:right}
  .user-name{font-weight:600;color:#fff}
  .user-role{font-size:.8rem;color:var(--muted);text-transform:uppercase;letter-spacing:.1em}
  .logout-button{display:inline-flex;align-items:center;gap:8px;padding:8px 16px;background:rgba(255,71,87,.2);border:1px solid rgba(255,71,87,.4);border-radius:8px;color:var(--danger);text-decoration:none;font-size:.9rem;font-weight:600;transition:all .3s ease}
  .logout-button:hover{background:rgba(255,71,87,.3);transform:translateY(-1px)}
  
  /* Resto do CSS igual ao painel original */
  .stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:40px}
  .stat-card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:16px;padding:24px;backdrop-filter:blur(8px);text-align:center}
  .stat-number{font-size:2.5rem;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
  .stat-label{color:var(--muted);font-size:.9rem;text-transform:uppercase;letter-spacing:.1em;margin-top:8px}
  .dashboards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:24px}
  .dashboard-card{background:rgba(26,26,46,.8);border:1px solid var(--stroke);border-radius:16px;overflow:hidden;transition:all .3s ease;backdrop-filter:blur(8px)}
  .dashboard-card:hover{transform:translateY(-4px);border-color:rgba(255,107,53,.5);box-shadow:0 12px 32px rgba(139,92,246,.2)}
  .card-thumbnail{height:200px;background:linear-gradient(135deg,rgba(255,107,53,.1),rgba(139,92,246,.1));display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
  .card-thumbnail::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;background:url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>') repeat;opacity:0.3}
  .thumbnail-content{display:flex;flex-direction:column;align-items:center;gap:12px;z-index:1}
  .thumbnail-icon{font-size:3rem;opacity:0.8}
  .thumbnail-charts{display:flex;gap:8px;align-items:end}
  .chart-bar{width:8px;background:var(--grad);border-radius:2px;opacity:0.7}
  .chart-bar:nth-child(1){height:20px}
  .chart-bar:nth-child(2){height:35px}
  .chart-bar:nth-child(3){height:25px}
  .chart-bar:nth-child(4){height:40px}
  .chart-bar:nth-child(5){height:30px}
  .card-content{padding:24px}
  .card-title{font-size:1.25rem;font-weight:700;margin-bottom:8px;color:#fff}
  .card-description{color:var(--muted);font-size:.9rem;line-height:1.5;margin-bottom:20px}
  .card-meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;font-size:.85rem}
  .card-status{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:20px;font-weight:600;font-size:.8rem}
  .status-active{background:rgba(0,255,136,.2);border:1px solid rgba(0,255,136,.4);color:var(--accent)}
  .card-actions{display:flex;gap:12px;width:100%}
  .card-link{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;background:var(--grad);color:#fff;text-decoration:none;border-radius:10px;font-weight:600;transition:all .3s ease;flex:1;justify-content:center}
  .card-link:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(139,92,246,.4)}
  .sync-button{display:inline-flex;align-items:center;gap:8px;padding:12px 16px;background:linear-gradient(135deg,rgba(0,255,136,.2),rgba(0,255,136,.4));border:1px solid rgba(0,255,136,.5);color:var(--accent);text-decoration:none;border-radius:10px;font-weight:600;transition:all .3s ease;cursor:pointer;min-width:120px;justify-content:center}
  .sync-button:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(0,255,136,.3);background:linear-gradient(135deg,rgba(0,255,136,.3),rgba(0,255,136,.5))}
  .sync-button:disabled{opacity:0.6;cursor:not-allowed;transform:none}
  .sync-button.syncing{animation:pulse 1.5s infinite}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
  .loading{display:flex;align-items:center;justify-content:center;padding:40px;color:var(--muted)}
  .spinner{border:2px solid rgba(148,163,184,.2);border-top:2px solid var(--accent);border-radius:50%;width:24px;height:24px;animation:spin 1s linear infinite;margin-right:12px}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  .empty-state{text-align:center;padding:60px 20px;color:var(--muted)}
  .empty-state h3{font-size:1.5rem;margin-bottom:12px;color:#fff}
  .empty-state p{font-size:1rem;line-height:1.6}
  
  /* Indicador de √°rea protegida */
  .protected-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:rgba(255,107,53,.2);border:1px solid rgba(255,107,53,.4);border-radius:20px;font-size:.8rem;font-weight:600;color:#ff6b35;margin-bottom:16px}
  
  @media (max-width:768px){
    .container{padding:20px 16px}
    .header-content h1{font-size:2rem}
    .dashboards-grid{grid-template-columns:1fr}
    .stats{grid-template-columns:repeat(2,1fr)}
    .user-info{flex-direction:column;align-items:flex-start;gap:8px}
    .user-details{text-align:left}
  }
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <div class="header-left">
      <div class="logo">
        <div class="logo-icon">üîê</div>
      </div>
      <div class="header-content">
        <div class="protected-badge">
          <span>üîí</span>
          <span>√Årea Protegida</span>
        </div>
        <h1>Painel de Controle</h1>
        <p>Central de gerenciamento de dashboards anal√≠ticos</p>
      </div>
    </div>
    
    <div class="user-info">
      <div class="user-details">
        <div class="user-name" id="userName">Usu√°rio</div>
        <div class="user-role" id="userRole">admin</div>
        <div class="user-company" id="userCompany">Empresa</div>
      </div>
      <div class="user-avatar" id="userAvatar">üë§</div>
      <a href="#" class="logout-button" onclick="logout()">
        <span>üö™</span>
        <span>Sair</span>
      </a>
    </div>
  </div>

  <div class="stats">
    <div class="stat-card">
      <div class="stat-number" id="totalDashboards">0</div>
      <div class="stat-label">Dashboards</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="activeDashboards">0</div>
      <div class="stat-label">Ativos</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="lastUpdate">-</div>
      <div class="stat-label">√öltima Atualiza√ß√£o</div>
    </div>
    <div class="stat-card">
      <div class="stat-number" id="userCount">1</div>
      <div class="stat-label">Usu√°rios Online</div>
    </div>
  </div>

  <div id="loadingState" class="loading">
    <div class="spinner"></div>
    Carregando dashboards...
  </div>

  <div id="dashboardsContainer" class="dashboards-grid" style="display:none">
    <!-- Dashboards ser√£o carregados aqui -->
  </div>

  <div id="emptyState" class="empty-state" style="display:none">
    <h3>Nenhum dashboard encontrado</h3>
    <p>Verifique se os arquivos est√£o na pasta /static</p>
  </div>
</div>

    <!-- Incluir sistema de autentica√ß√£o h√≠brido -->
    <script src="auth_system_hybrid.js"></script>
    <script src="auth_middleware.js"></script>
    <script src="navigation_menu.js"></script>

<script>
// Verificar autentica√ß√£o usando sistema robusto
function checkAuthentication() {
  if (window.authSystem && !window.authSystem.isAuthenticated()) {
    window.location.href = '/login.html';
    return null;
  }
  
  const session = window.authSystem.getCurrentSession();
  return session;
}

// Fun√ß√£o de logout usando sistema robusto
function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    if (window.authSystem) {
      window.authSystem.logout();
    }
    window.location.href = '/login.html';
  }
}

// Atualizar informa√ß√µes do usu√°rio usando sistema robusto
async function updateUserInfo(sessionData) {
  try {
    const user = await window.authSystem.getCurrentUser();
    const systemData = window.authSystem.getSystemData();
    const role = systemData.roles.find(r => r.id === sessionData.role);
    const company = await window.authSystem.getCurrentUserCompany();
    
    // Usar dados do usu√°rio se dispon√≠vel, sen√£o usar dados da sess√£o
    const displayName = user?.profile?.full_name || sessionData.username;
    const userRole = role ? role.name : sessionData.role;
    
    document.getElementById('userName').textContent = displayName;
    document.getElementById('userRole').textContent = userRole;
    document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
    
    // Exibir empresa do usu√°rio se n√£o for super admin
    const companyInfo = document.getElementById('userCompany');
    if (companyInfo) {
      if (sessionData.role === 'super_admin') {
        companyInfo.textContent = 'Todas as Empresas';
        companyInfo.style.color = 'var(--accent)';
      } else if (company) {
        companyInfo.textContent = company.name;
        companyInfo.style.color = 'var(--muted)';
      } else {
        companyInfo.textContent = 'Sem Empresa';
        companyInfo.style.color = 'var(--error)';
      }
    }
  } catch (error) {
    console.error('Erro ao atualizar informa√ß√µes do usu√°rio:', error);
    // Fallback para dados da sess√£o
    document.getElementById('userName').textContent = sessionData.username;
    document.getElementById('userRole').textContent = sessionData.role;
    document.getElementById('userAvatar').textContent = sessionData.username.charAt(0).toUpperCase();
    
    const companyInfo = document.getElementById('userCompany');
    if (companyInfo) {
      companyInfo.textContent = sessionData.role === 'super_admin' ? 'Todas as Empresas' : 'Sem Empresa';
    }
  }
}

// Obter dashboards do sistema multi-tenant
async function getDashboards() {
  try {
    return await window.authSystem.getDashboardsForUser();
  } catch (error) {
    console.error('Erro ao obter dashboards:', error);
    return [];
  }
}

// Fun√ß√£o para criar card de dashboard (igual ao original)
function createDashboardCard(dashboard) {
  const statusClass = dashboard.status === 'active' ? 'status-active' : '';
  const statusText = dashboard.status === 'active' ? 'üü¢ Ativo' : 'üî¥ Inativo';
  
  // Verificar se √© o Dashboard Sonho para adicionar bot√£o de sync
  const isSonhoDashboard = dashboard.file === 'dash_sonho.html';
  
  const actionsHtml = isSonhoDashboard ? `
    <div class="card-actions">
      <a href="https://dashboard-builder-609095880025.us-central1.run.app/static/${dashboard.file}" class="card-link" target="_blank">
        <span>üìä</span>
        <span>Acessar</span>
      </a>
      <button class="sync-button" onclick="syncDashboard('${dashboard.file}')" id="sync-${dashboard.file}">
        <span>üîÑ</span>
        <span>Sync</span>
      </button>
    </div>
  ` : `
    <a href="https://dashboard-builder-609095880025.us-central1.run.app/static/${dashboard.file}" class="card-link" target="_blank">
      <span>üìä</span>
      <span>Acessar Dashboard</span>
    </a>
  `;
  
  return `
    <div class="dashboard-card">
      <div class="card-thumbnail">
        <div class="thumbnail-content">
          <div class="thumbnail-icon">${dashboard.icon}</div>
          <div class="thumbnail-charts">
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
            <div class="chart-bar"></div>
          </div>
        </div>
      </div>
      <div class="card-content">
        <h3 class="card-title">${dashboard.name}</h3>
        <p class="card-description">${dashboard.description}</p>
        <div class="card-meta">
          <span class="card-status ${statusClass}">${statusText}</span>
          <span style="color: var(--muted);">${dashboard.category}</span>
        </div>
        ${actionsHtml}
      </div>
    </div>
  `;
}

// Fun√ß√£o para carregar dashboards com sistema multi-tenant
async function loadDashboards() {
  const container = document.getElementById('dashboardsContainer');
  const loadingState = document.getElementById('loadingState');
  const emptyState = document.getElementById('emptyState');
  
  try {
    // Simular carregamento
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    loadingState.style.display = 'none';
    
    const dashboards = await getDashboards();
    
    if (!dashboards || dashboards.length === 0) {
      emptyState.style.display = 'block';
    } else {
      container.style.display = 'grid';
      container.innerHTML = dashboards.map(createDashboardCard).join('');
      
      // Atualizar estat√≠sticas
      document.getElementById('totalDashboards').textContent = dashboards.length;
      document.getElementById('activeDashboards').textContent = 
        dashboards.filter(d => d.status === 'active').length;
      document.getElementById('lastUpdate').textContent = 'Agora';
    }
  } catch (error) {
    console.error('Erro ao carregar dashboards:', error);
    loadingState.style.display = 'none';
    emptyState.style.display = 'block';
  }
}

// Fun√ß√£o para sincronizar dashboard via Cloud Run (igual ao original)
async function syncDashboard(file) {
  const buttonId = `sync-${file}`;
  const button = document.getElementById(buttonId);
  
  if (!button) {
    console.error('Bot√£o de sync n√£o encontrado');
    return;
  }
  
  // Desabilitar bot√£o e mostrar estado de loading
  button.disabled = true;
  button.classList.add('syncing');
  button.innerHTML = '<span>‚è≥</span><span>Sincronizando...</span>';
  
  try {
    console.log(`üîÑ Iniciando sincroniza√ß√£o do ${file}...`);
    
    // Fazer chamada para o Cloud Run dashboard-automation
    const response = await fetch('https://dashboard-automation-609095880025.us-central1.run.app/trigger', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        test_mode: false
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const result = await response.json();
    console.log('‚úÖ Sincroniza√ß√£o conclu√≠da:', result);
    
    // Sucesso
    button.innerHTML = '<span>‚úÖ</span><span>Conclu√≠do!</span>';
    button.style.background = 'linear-gradient(135deg,rgba(0,255,136,.3),rgba(0,255,136,.5))';
    
    // Atualizar timestamp
    updateLastSyncTime();
    
    // Resetar bot√£o ap√≥s 3 segundos
    setTimeout(() => {
      button.disabled = false;
      button.classList.remove('syncing');
      button.innerHTML = '<span>üîÑ</span><span>Sync</span>';
      button.style.background = '';
    }, 3000);
    
  } catch (error) {
    console.error('‚ùå Erro na sincroniza√ß√£o:', error);
    
    // Erro
    button.innerHTML = '<span>‚ùå</span><span>Erro</span>';
    button.style.background = 'linear-gradient(135deg,rgba(255,71,87,.3),rgba(255,71,87,.5))';
    
    // Resetar bot√£o ap√≥s 3 segundos
    setTimeout(() => {
      button.disabled = false;
      button.classList.remove('syncing');
      button.innerHTML = '<span>üîÑ</span><span>Sync</span>';
      button.style.background = '';
    }, 3000);
  }
}

// Fun√ß√£o para atualizar timestamp da √∫ltima sincroniza√ß√£o
function updateLastSyncTime() {
  const lastUpdateElement = document.getElementById('lastUpdate');
  if (lastUpdateElement) {
    const now = new Date();
    const timeString = now.toLocaleTimeString('pt-BR', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    lastUpdateElement.textContent = timeString;
  }
}

// Inicializar quando a p√°gina carregar
document.addEventListener('DOMContentLoaded', () => {
  // Verificar autentica√ß√£o
  const sessionData = checkAuthentication();
  if (!sessionData) return;
  
  // Atualizar informa√ß√µes do usu√°rio
  updateUserInfo(sessionData).catch(error => {
    console.error('Erro ao atualizar informa√ß√µes do usu√°rio:', error);
  });
  
  // Carregar dashboards
  loadDashboards().catch(error => {
    console.error('Erro ao carregar dashboards:', error);
  });
});
</script>
</body>
</html>
